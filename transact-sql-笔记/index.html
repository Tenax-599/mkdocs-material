<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Learning Learning Transact-SQL
"><link href=https://a53d90dd.tenax-756.pages.dev/transact-sql-%E7%AC%94%E8%AE%B0/ rel=canonical><link href=../%E5%AD%A6%E4%B9%A0-modbustcp-%E9%80%9A%E4%BF%A1/ rel=prev><link rel=icon href=../assets/favicon.ico><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.10"><title>Transact-SQL 笔记 - My Blog - Tenax</title><link rel=stylesheet href=../assets/stylesheets/main.4af4bdda.min.css><link rel=stylesheet href=../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Inter:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Inter";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../stylesheets/extra.css><link rel=stylesheet href=https://unpkg.com/katex@0/dist/katex.min.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><link href=../assets/stylesheets/glightbox.min.css rel=stylesheet><style>
    html.glightbox-open { overflow: initial; height: 100%; }
    .gslide-title { margin-top: 0px; user-select: text; }
    .gslide-desc { color: #666; user-select: text; }
    .gslide-image img { background: white; }
    .gscrollbar-fixer { padding-right: 15px; }
    .gdesc-inner { font-size: 0.75rem; }
    body[data-md-color-scheme="slate"] .gdesc-inner { background: var(--md-default-bg-color);}
    body[data-md-color-scheme="slate"] .gslide-title { color: var(--md-default-fg-color);}
    body[data-md-color-scheme="slate"] .gslide-desc { color: var(--md-default-fg-color);}</style><script src=../assets/javascripts/glightbox.min.js></script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=green data-md-color-accent=green> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#transact-sql class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=.. title="My Blog - Tenax" class="md-header__button md-logo" aria-label="My Blog - Tenax" data-md-component=logo> <img src=../assets/logo.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> My Blog - Tenax </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Transact-SQL 笔记 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=green data-md-color-accent=green aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 1 7 7c0 2.38-1.19 4.47-3 5.74V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.26C6.19 13.47 5 11.38 5 9a7 7 0 0 1 7-7M9 21v-1h6v1a1 1 0 0 1-1 1h-4a1 1 0 0 1-1-1m3-17a5 5 0 0 0-5 5c0 2.05 1.23 3.81 3 4.58V16h4v-2.42c1.77-.77 3-2.53 3-4.58a5 5 0 0 0-5-5"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=black data-md-color-accent=deep-purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2a7 7 0 0 0-7 7c0 2.38 1.19 4.47 3 5.74V17a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-2.26c1.81-1.27 3-3.36 3-5.74a7 7 0 0 0-7-7M9 21a1 1 0 0 0 1 1h4a1 1 0 0 0 1-1v-1H9z"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" title=分享 aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg> </a> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/Tenax-599/mkdocs-material/tree/main/docs title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> Tenax-599/mkdocs-material </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation hidden> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="My Blog - Tenax" class="md-nav__button md-logo" aria-label="My Blog - Tenax" data-md-component=logo> <img src=../assets/logo.png alt=logo> </a> My Blog - Tenax </label> <div class=md-nav__source> <a href=https://github.com/Tenax-599/mkdocs-material/tree/main/docs title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81"/></svg> </div> <div class=md-source__repository> Tenax-599/mkdocs-material </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <a href=.. class=md-nav__link> <span class=md-ellipsis> Blog </span> </a> </li> <li class=md-nav__item> <a href=../tags/ class=md-nav__link> <span class=md-ellipsis> Tags </span> </a> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3> <div class="md-nav__link md-nav__container"> <a href=../blog/ class="md-nav__link "> <span class=md-ellipsis> Blog </span> </a> <label class="md-nav__link " for=__nav_3 id=__nav_3_label tabindex> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> Blog </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> <span class=md-ellipsis> 归档 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex> <span class=md-ellipsis> 归档 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 归档 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../archive/2025/ class=md-nav__link> <span class=md-ellipsis> 2025 </span> </a> </li> <li class=md-nav__item> <a href=../archive/2024/ class=md-nav__link> <span class=md-ellipsis> 2024 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> <span class=md-ellipsis> 介绍 </span> </a> <nav class=md-nav aria-label=介绍> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_2 class=md-nav__link> <span class=md-ellipsis> 关系数据 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sql class=md-nav__link> <span class=md-ellipsis> 探索 SQL 语句的结构 </span> </a> </li> <li class=md-nav__item> <a href=#select class=md-nav__link> <span class=md-ellipsis> 检查 SELECT 语句 </span> </a> <nav class=md-nav aria-label="检查 SELECT 语句"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_3 class=md-nav__link> <span class=md-ellipsis> 选择所有列 </span> </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> <span class=md-ellipsis> 格式化查询 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> <span class=md-ellipsis> 使用数据类型 </span> </a> <nav class=md-nav aria-label=使用数据类型> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_6 class=md-nav__link> <span class=md-ellipsis> 数据类型转换 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#t-sql class=md-nav__link> <span class=md-ellipsis> T-SQL 包含有助于显式转换数据类型的函数 </span> </a> <nav class=md-nav aria-label="T-SQL 包含有助于显式转换数据类型的函数"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cast-try_cast class=md-nav__link> <span class=md-ellipsis> CAST 和 TRY_CAST </span> </a> </li> <li class=md-nav__item> <a href=#convert-try_convert class=md-nav__link> <span class=md-ellipsis> CONVERT 和 TRY_CONVERT </span> </a> </li> <li class=md-nav__item> <a href=#parse-try_parse class=md-nav__link> <span class=md-ellipsis> PARSE 和 TRY_PARSE </span> </a> </li> <li class=md-nav__item> <a href=#str class=md-nav__link> <span class=md-ellipsis> STR </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#null class=md-nav__link> <span class=md-ellipsis> 处理 NULL </span> </a> <nav class=md-nav aria-label="处理 NULL"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#isnull class=md-nav__link> <span class=md-ellipsis> ISNULL </span> </a> </li> <li class=md-nav__item> <a href=#coalesce class=md-nav__link> <span class=md-ellipsis> COALESCE </span> </a> </li> <li class=md-nav__item> <a href=#nullif class=md-nav__link> <span class=md-ellipsis> NULLIF </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> <span class=md-ellipsis> 插入数据 </span> </a> <nav class=md-nav aria-label=插入数据> <ul class=md-nav__list> <li class=md-nav__item> <a href=#insert class=md-nav__link> <span class=md-ellipsis> INSERT 语句 </span> </a> </li> <li class=md-nav__item> <a href=#insert-select class=md-nav__link> <span class=md-ellipsis> INSERT ... SELECT </span> </a> </li> <li class=md-nav__item> <a href=#select-into class=md-nav__link> <span class=md-ellipsis> SELECT ... INTO </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> <span class=md-ellipsis> 对结果进行排序 </span> </a> <nav class=md-nav aria-label=对结果进行排序> <ul class=md-nav__list> <li class=md-nav__item> <a href=#order-by class=md-nav__link> <span class=md-ellipsis> 使用 ORDER BY 子句 </span> </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> <span class=md-ellipsis> 排序方向 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> <span class=md-ellipsis> 限制排序结果 </span> </a> <nav class=md-nav aria-label=限制排序结果> <ul class=md-nav__list> <li class=md-nav__item> <a href=#top class=md-nav__link> <span class=md-ellipsis> 使用 TOP 子句 </span> </a> </li> <li class=md-nav__item> <a href=#with-ties class=md-nav__link> <span class=md-ellipsis> 使用 WITH TIES </span> </a> </li> <li class=md-nav__item> <a href=#percent class=md-nav__link> <span class=md-ellipsis> 使用 PERCENT </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> <span class=md-ellipsis> 页结果 </span> </a> <nav class=md-nav aria-label=页结果> <ul class=md-nav__list> <li class=md-nav__item> <a href=#offset-fetch class=md-nav__link> <span class=md-ellipsis> OFFSET-FETCH 语法 </span> </a> </li> <li class=md-nav__item> <a href=#offset-fetch_1 class=md-nav__link> <span class=md-ellipsis> 使用 OFFSET-FETCH </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> <span class=md-ellipsis> 删除重复项 </span> </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> <span class=md-ellipsis> 用谓词筛选数据 </span> </a> <nav class=md-nav aria-label=用谓词筛选数据> <ul class=md-nav__list> <li class=md-nav__item> <a href=#where class=md-nav__link> <span class=md-ellipsis> WHERE 子句的结构 </span> </a> </li> <li class=md-nav__item> <a href=#is-null-is-not-null class=md-nav__link> <span class=md-ellipsis> IS NULL / IS NOT NULL </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> <span class=md-ellipsis> 多个条件 </span> </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> <span class=md-ellipsis> 比较运算符 </span> </a> <nav class=md-nav aria-label=比较运算符> <ul class=md-nav__list> <li class=md-nav__item> <a href=#in class=md-nav__link> <span class=md-ellipsis> IN </span> </a> </li> <li class=md-nav__item> <a href=#like class=md-nav__link> <span class=md-ellipsis> LIKE </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> <span class=md-ellipsis> 理解联接概念和语法 </span> </a> </li> <li class=md-nav__item> <a href=#from class=md-nav__link> <span class=md-ellipsis> FROM 子句和虚拟表 </span> </a> </li> <li class=md-nav__item> <a href=#_17 class=md-nav__link> <span class=md-ellipsis> 使用内部联接 </span> </a> <nav class=md-nav aria-label=使用内部联接> <ul class=md-nav__list> <li class=md-nav__item> <a href=#inner-join class=md-nav__link> <span class=md-ellipsis> 处理 INNER JOIN </span> </a> </li> <li class=md-nav__item> <a href=#inner-join_1 class=md-nav__link> <span class=md-ellipsis> INNER JOIN 语法 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> <span class=md-ellipsis> 使用外部联接 </span> </a> <nav class=md-nav aria-label=使用外部联接> <ul class=md-nav__list> <li class=md-nav__item> <a href=#outer-join class=md-nav__link> <span class=md-ellipsis> OUTER JOIN 语法 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> <span class=md-ellipsis> 使用交叉联接 </span> </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> <span class=md-ellipsis> 使用自联接 </span> </a> </li> <li class=md-nav__item> <a href=#_21 class=md-nav__link> <span class=md-ellipsis> 了解子查询 </span> </a> <nav class=md-nav aria-label=了解子查询> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_22 class=md-nav__link> <span class=md-ellipsis> 使用子查询 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_23 class=md-nav__link> <span class=md-ellipsis> 使用标量或多值子查询 </span> </a> <nav class=md-nav aria-label=使用标量或多值子查询> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_24 class=md-nav__link> <span class=md-ellipsis> 标量子查询 </span> </a> </li> <li class=md-nav__item> <a href=#_25 class=md-nav__link> <span class=md-ellipsis> 多值子查询 </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_26 class=md-nav__link> <span class=md-ellipsis> 使用自包含或关联子查询 </span> </a> <nav class=md-nav aria-label=使用自包含或关联子查询> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_27 class=md-nav__link> <span class=md-ellipsis> 使用关联子查询 </span> </a> </li> <li class=md-nav__item> <a href=#_28 class=md-nav__link> <span class=md-ellipsis> 写入关联子查询 </span> </a> </li> <li class=md-nav__item> <a href=#exists class=md-nav__link> <span class=md-ellipsis> 使用 EXISTS </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-content md-content--post" data-md-component=content> <div class="md-sidebar md-sidebar--post" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class="md-sidebar__inner md-post"> <nav class="md-nav md-nav--primary"> <div class=md-post__back> <div class="md-nav__title md-nav__container"> <a href=.. class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> <span class=md-ellipsis> 回到主页 </span> </a> </div> </div> <div class="md-post__authors md-typeset"> <div class="md-profile md-post__profile"> <span class="md-author md-author--long"> <img src=https://avatars.githubusercontent.com/u/188058604 alt=Tenax> </span> <span class=md-profile__description> <strong> Tenax </strong> <br> Developer </span> </div> </div> <ul class="md-post__meta md-nav__list"> <li class="md-nav__item md-nav__item--section"> <div class=md-post__title> <span class=md-ellipsis> 元数据 </span> </div> <nav class=md-nav> <ul class=md-nav__list> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 19H5V8h14m-3-7v2H8V1H6v2H5c-1.11 0-2 .89-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V5a2 2 0 0 0-2-2h-1V1m-1 11h-5v5h5z"/></svg> <time datetime="2025-03-26 00:00:00+00:00" class=md-ellipsis>2025年3月26日</time> </div> </li> <li class=md-nav__item> <div class=md-nav__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 20a8 8 0 0 0 8-8 8 8 0 0 0-8-8 8 8 0 0 0-8 8 8 8 0 0 0 8 8m0-18a10 10 0 0 1 10 10 10 10 0 0 1-10 10C6.47 22 2 17.5 2 12A10 10 0 0 1 12 2m.5 5v5.25l4.5 2.67-.75 1.23L11 13V7z"/></svg> <span class=md-ellipsis> 需要 24 分钟阅读时间 </span> </div> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <article class="md-content__inner md-typeset"> <nav class=md-tags> <a href=../tags/#tag:t-sql class=md-tag>T-SQL</a> </nav> <a href="https://github.com/Tenax-599/mkdocs-material/tree/main/docs/posts/Learning Transact-SQL.md" title=编辑此页 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4zm10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1z"/></svg> </a> <a href="https://github.com/Tenax-599/mkdocs-material/tree/main/docs/posts/Learning Transact-SQL.md" title=查看本页的源代码 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M17 18c.56 0 1 .44 1 1s-.44 1-1 1-1-.44-1-1 .44-1 1-1m0-3c-2.73 0-5.06 1.66-6 4 .94 2.34 3.27 4 6 4s5.06-1.66 6-4c-.94-2.34-3.27-4-6-4m0 6.5a2.5 2.5 0 0 1-2.5-2.5 2.5 2.5 0 0 1 2.5-2.5 2.5 2.5 0 0 1 2.5 2.5 2.5 2.5 0 0 1-2.5 2.5M9.27 20H6V4h7v5h5v4.07c.7.08 1.36.25 2 .49V8l-6-6H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4.5a8.2 8.2 0 0 1-1.23-2"/></svg> </a> <h1 id=transact-sql>Transact-SQL 笔记</h1> <!-- more --> <h2 id=_1>介绍</h2> <h3 id=_2><a href=https://learn.microsoft.com/zh-cn/training/modules/introduction-to-transact-sql/1-introduction>关系数据</a></h3> <p>SQL 最常（但并不总是）用来查询关系数据库中的数据。 关系数据库是一种已将数据组织到多个表中（技术上称为“关系”）的数据库，其中每个表代表一种特定类型的实体（例如客户、产品或销售订单）。 这些实体的属性（例如客户名称、产品价格或销售订单的订单日期）被定义为表的列或属性，而表中的每一行代表一个实体类型实例（例如特定客户、产品或销售订单）。</p> <p>数据库中的表通过键列相互关联，键列唯一标识所代表的特定实体。 为每个表定义一个主键，并将任意相关表中对此键的引用定义为外键。 通过示例可以更轻松地了解这些信息：</p> <p><a class=glightbox href=../assets/T-SQL/relational-database.avif data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt=一个包含四个表的关系数据库 src=../assets/T-SQL/relational-database.avif></a></p> <p>该图显示了一个包含四个表的关系数据库：</p> <ul> <li><strong>客户</strong></li> <li><strong>SalesOrderHeader</strong></li> <li><strong>SalesOrderDetail</strong></li> <li><strong>产品</strong></li> </ul> <p>每个客户由唯一的 CustomerID 字段标识 - 此字段是“客户”表的主键。 SalesOrderHeader 表中包含标识每个订单的主键，名为 OrderID，还包括引用“客户”表中主键的外键 CustomerID，它用于标识哪个客户与哪个订单相关联。 订单中各项的数据存储在 SalesOrderDetail 表中，它的主键是复合主键，即将 SalesOrderHeader 表中的 OrderID 与 LineItemNo 值结合在了一起。 这些值的组合用于唯一标识行项。 此外，“OrderID”字段用作外键来指示行项所属的订单，“ProductID”字段用作“产品”表中的 ProductID 主键的外键，指示订购的哪款产品。</p> <h2 id=sql>探索 SQL 语句的结构</h2> <p>在任何 SQL 方言中，SQL 语句都会组合成几种不同类型的语句。 这些不同类型包括：</p> <ul> <li>数据操作语言 (DML) 是侧重于查询和修改数据的 SQL 语句集。 DML 语句包括 SELECT（本训练的主要重点）以及 INSERT、UPDATE 和 DELETE 等修改语句。</li> <li>数据定义语言 (DDL) 是处理数据库对象（例如表、视图和过程）定义和生命周期的 SQL 语句集。 DDL 包括 CREATE、ALTER 和 DROP 等语句。</li> <li>数据控制语言 (DCL) 是用于管理用户和对象安全权限的 SQL 语句集。 DCL 包括 GRANT、REVOKE 和 DENY 等语句。</li> </ul> <p>有时，可能还会看到 TCL 被列为语句类型，这是指事务控制语言。 此外，有些列表可能会将 DML 重新定义为“数据修改语言”，其中不包括 SELECT 语句，但随后会添加数据查询语言 (DQL) 用于 SELECT 语句。</p> <p>在此模块中，我们将重点介绍 DML 语句。 数据分析师通常使用这些语句来检索用于报表和分析的数据。 应用程序开发人员也会使用 DML 语句来执行“CRUD”操作，以创建、读取、更新或删除应用程序数据。</p> <p><strong><a href=https://en.wikipedia.org/wiki/Composite_key>什么是复合主键</a></strong></p> <p>In database design, a composite key is a candidate key that consists of two or more attributes, (table columns) that together uniquely identify an entity occurrence (table row).【在数据库设计中，复合键是一种候选键，由两个或多个属性（表列）组成，共同唯一标识一个实体（表行）。】</p> <p>A compound key is a composite key for which each attribute that makes up the key is a foreign key in its own right.【复合键是一种复合键，其组成该键的每个属性本身就是一个外键。】</p> <p><u>唯一标识行？</u></p> <h2 id=select><a href="https://learn.microsoft.com/zh-cn/sql/t-sql/queries/select-transact-sql?view=sql-server-ver16">检查 SELECT 语句</a></h2> <div class="language-sql highlight"><pre><span></span><code><span id=__span-0-1><a id=__codelineno-0-1 name=__codelineno-0-1 href=#__codelineno-0-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>OrderDate</span><span class=p>,</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=n>OrderID</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Orders</span>
</span><span id=__span-0-2><a id=__codelineno-0-2 name=__codelineno-0-2 href=#__codelineno-0-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrder</span>
</span><span id=__span-0-3><a id=__codelineno-0-3 name=__codelineno-0-3 href=#__codelineno-0-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>Status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Shipped&#39;</span>
</span><span id=__span-0-4><a id=__codelineno-0-4 name=__codelineno-0-4 href=#__codelineno-0-4></a><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>OrderDate</span>
</span><span id=__span-0-5><a id=__codelineno-0-5 name=__codelineno-0-5 href=#__codelineno-0-5></a><span class=k>HAVING</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=n>OrderID</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>1</span>
</span><span id=__span-0-6><a id=__codelineno-0-6 name=__codelineno-0-6 href=#__codelineno-0-6></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>OrderDate</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>
</span></code></pre></div> <p>现在，你已了解每个子句的作用，接着我们来看 SQL Server 对它们的实际计算顺序：</p> <ol> <li>首先计算 FROM 子句，为其余语句提供源行。 这里将<u>创建一个虚拟表</u>并将其传递到下一步。</li> <li>接着，计算 WHERE 子句后，从源表中筛选出与谓词匹配的行。 将筛选后的虚拟表传递到下一步。</li> <li>然后计算 GROUP BY，根据 GROUP BY 列表中的唯一值来组织虚拟表中的行。 这时将创建一个包含组列表的新虚拟表，并将其传递到下一步。 从操作流的此刻开始，其他元素只能引用 GROUP BY 列表中的列或聚合函数。</li> <li>接下来，计算 HAVING 子句，根据谓词筛选出整个组。 筛选在步骤 3 中创建的虚拟表，并将其传递到下一步。</li> <li>最后执行 SELECT 子句，确定查询结果中显示哪些列。 由于 SELECT 子句在其他步骤之后计算，因此这时创建的任何列别名（在本例中为 Orders）都无法用于 GROUP BY 或 HAVING 子句。</li> <li>最后一步执行 ORDER BY，按列列表对确定的行排序。</li> </ol> <p>要将这种理解应用于示例查询，下面是上述 SELECT 语句运行时的逻辑顺序：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-1-1><a id=__codelineno-1-1 name=__codelineno-1-1 href=#__codelineno-1-1></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrder</span>
</span><span id=__span-1-2><a id=__codelineno-1-2 name=__codelineno-1-2 href=#__codelineno-1-2></a><span class=k>WHERE</span><span class=w> </span><span class=n>Status</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Shipped&#39;</span>
</span><span id=__span-1-3><a id=__codelineno-1-3 name=__codelineno-1-3 href=#__codelineno-1-3></a><span class=k>GROUP</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>OrderDate</span>
</span><span id=__span-1-4><a id=__codelineno-1-4 name=__codelineno-1-4 href=#__codelineno-1-4></a><span class=k>HAVING</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=n>OrderID</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>1</span>
</span><span id=__span-1-5><a id=__codelineno-1-5 name=__codelineno-1-5 href=#__codelineno-1-5></a><span class=k>SELECT</span><span class=w> </span><span class=n>OrderDate</span><span class=p>,</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=n>OrderID</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Orders</span>
</span><span id=__span-1-6><a id=__codelineno-1-6 name=__codelineno-1-6 href=#__codelineno-1-6></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>OrderDate</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>
</span></code></pre></div> <p>每个写入的 SELECT 语句并非都需要所有可能的子句。 唯一必需的子句是 SELECT 子句，它们在某些情况下可以单独使用。 通常还会包括 FROM 子句，用于标识要查询的表。 此外，Transact-SQL 还包含其他可添加的子句。</p> <p><strong>如你所见，写入 T-SQL 查询的顺序与其计算的逻辑顺序并不相同。 计算的运行时顺序决定哪些数据可用于哪些子句，因为子句仅有权访问已处理子句提供的信息。 因此，在写入查询时了解真正的逻辑处理顺序非常重要。</strong></p> <h3 id=_3>选择所有列</h3> <p>SELECT 子句通常称为 SELECT 列表，因为它会列出要在查询结果中返回的值。</p> <p>最简单的 SELECT 子句形式是使用星号字符 (_) 返回所有列。 在 T-SQL 查询中使用时，它被称为“星型”。 尽管 SELECT _ 适合用于快速测试，但应避免在生产工作中使用它们，原因如下：</p> <ul> <li>对表进行的添加列或重新排列列等更改会反映在查询结果中，进而可能导致使用该查询的应用程序或报表出现输出意外。</li> <li>如果源表包含大量行，则返回不需要的数据可能会减慢查询速度并导致性能问题。</li> </ul> <h3 id=_4>格式化查询</h3> <p>通过此部分的示例，你可能会注意到查询代码的格式可以灵活设置。 例如，可以每行写入一个子句（或整个查询），也可以将其拆分成多行写入。 在大多数数据库系统中，代码不区分大小写，并且有些 T-SQL 语言元素是可选项（包括前面提到的 AS 关键字，甚至是语句末尾的分号）。</p> <p>请考虑以下准则，让 T-SQL 代码容易阅读（从而更便于理解和调试！）：</p> <ul> <li>将 T-SQL 关键字（如 SELECT、FROM、AS 等）大写。 大写关键字是一种常用约定，这样查找复杂语句的每个子句会变得更加轻松。</li> <li>另起新的一行写入语句的每个主子句。</li> <li>如果 SELECT 列表不止有几列、几个表达式或别名，请考虑在每行列出其各列。</li> <li>缩进包含子子句或列的行，以明确每个代码属于哪个主子句。</li> </ul> <h2 id=_5>使用数据类型</h2> <h3 id=_6>数据类型转换</h3> <p>兼容的数据类型值可按要求隐式转换。 例如，假设可以使用 <strong>+</strong> 运算符向十进制数添加整数，或连接固定长度的 char 值和可变长度的 varchar 值。 但是，在某些情况下，可能需要将值从一种数据类型显式转换为另一种数据类型 - 例如，尝试使用 <strong>+</strong> 连接 varchar 值和十进制值将会出错，除非先将数值转换为兼容的字符串数据类型。</p> <details class=info> <summary>备注</summary> <p>隐式和显式转换适用于某些数据类型，有些转换是不可能的。 有关详细信息，请使用 <a href=https://learn.microsoft.com/zh-cn/sql/t-sql/data-types/data-type-conversion-database-engine>Transact-SQL 参考文档</a>中的图表。</p> </details> <h2 id=t-sql>T-SQL 包含有助于显式转换数据类型的函数</h2> <h3 id=cast-try_cast>CAST 和 TRY_CAST</h3> <p>CAST 函数可将值转换为指定的数据类型，但该值必须与目标数据类型兼容。 如果不兼容，将返回错误。</p> <p>例如，以下查询使用 CAST 将 ProductID 列中的整数值转换为 varchar 值（最多为 4 个字符），以便将它们与其他基于字符的值连接：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-2-1><a id=__codelineno-2-1 name=__codelineno-2-1 href=#__codelineno-2-1></a><span class=k>SELECT</span><span class=w> </span><span class=k>CAST</span><span class=p>(</span><span class=n>ProductID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>varchar</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;: &#39;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>ProductName</span>
</span><span id=__span-2-2><a id=__codelineno-2-2 name=__codelineno-2-2 href=#__codelineno-2-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span><span class=p>;</span>
</span><span id=__span-2-3><a id=__codelineno-2-3 name=__codelineno-2-3 href=#__codelineno-2-3></a>
</span><span id=__span-2-4><a id=__codelineno-2-4 name=__codelineno-2-4 href=#__codelineno-2-4></a><span class=cm>/*</span>
</span><span id=__span-2-5><a id=__codelineno-2-5 name=__codelineno-2-5 href=#__codelineno-2-5></a><span class=cm>该查询的结果可能如下所示：</span>
</span><span id=__span-2-6><a id=__codelineno-2-6 name=__codelineno-2-6 href=#__codelineno-2-6></a>
</span><span id=__span-2-7><a id=__codelineno-2-7 name=__codelineno-2-7 href=#__codelineno-2-7></a><span class=cm>ProductName</span>
</span><span id=__span-2-8><a id=__codelineno-2-8 name=__codelineno-2-8 href=#__codelineno-2-8></a>
</span><span id=__span-2-9><a id=__codelineno-2-9 name=__codelineno-2-9 href=#__codelineno-2-9></a><span class=cm>680：HL 公路车架 - 黑色，58</span>
</span><span id=__span-2-10><a id=__codelineno-2-10 name=__codelineno-2-10 href=#__codelineno-2-10></a>
</span><span id=__span-2-11><a id=__codelineno-2-11 name=__codelineno-2-11 href=#__codelineno-2-11></a><span class=cm>706：HL 公路车架 - 红色，58</span>
</span><span id=__span-2-12><a id=__codelineno-2-12 name=__codelineno-2-12 href=#__codelineno-2-12></a>
</span><span id=__span-2-13><a id=__codelineno-2-13 name=__codelineno-2-13 href=#__codelineno-2-13></a><span class=cm>707：Sport-100 头盔，红色</span>
</span><span id=__span-2-14><a id=__codelineno-2-14 name=__codelineno-2-14 href=#__codelineno-2-14></a>
</span><span id=__span-2-15><a id=__codelineno-2-15 name=__codelineno-2-15 href=#__codelineno-2-15></a><span class=cm>708：Sport-100 头盔，黑色</span>
</span><span id=__span-2-16><a id=__codelineno-2-16 name=__codelineno-2-16 href=#__codelineno-2-16></a>
</span><span id=__span-2-17><a id=__codelineno-2-17 name=__codelineno-2-17 href=#__codelineno-2-17></a><span class=cm>...</span>
</span><span id=__span-2-18><a id=__codelineno-2-18 name=__codelineno-2-18 href=#__codelineno-2-18></a><span class=cm>*/</span>
</span></code></pre></div> <p>但是，假设 Production.Product 表中的“大小”列是 nvarchar（可变长度，Unicode 文本数据）列，其中包含一些数值大小（例如 58）和一些基于文本的大小（例如“S”、“M”或“L”）。 以下查询尝试将此列中的值转换为“整数”数据类型：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-3-1><a id=__codelineno-3-1 name=__codelineno-3-1 href=#__codelineno-3-1></a><span class=k>SELECT</span><span class=w> </span><span class=k>CAST</span><span class=p>(</span><span class=k>Size</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>integer</span><span class=p>)</span><span class=w> </span><span class=k>As</span><span class=w> </span><span class=n>NumericSize</span>
</span><span id=__span-3-2><a id=__codelineno-3-2 name=__codelineno-3-2 href=#__codelineno-3-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span><span class=p>;</span>
</span></code></pre></div> <p>该查询将导致以下错误消息：</p> <blockquote> <p>错误：将 nvarchar 值“M”转换为 int 数据类型时转换失败。</p> </blockquote> <p>假设该列中至少有一些值是数值，你可能希望转换这些值，并忽略其他值。 可以使用 TRY_CAST 函数来转换数据类型。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-4-1><a id=__codelineno-4-1 name=__codelineno-4-1 href=#__codelineno-4-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>TRY_CAST</span><span class=p>(</span><span class=k>Size</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>integer</span><span class=p>)</span><span class=w> </span><span class=k>As</span><span class=w> </span><span class=n>NumericSize</span>
</span><span id=__span-4-2><a id=__codelineno-4-2 name=__codelineno-4-2 href=#__codelineno-4-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span><span class=p>;</span>
</span><span id=__span-4-3><a id=__codelineno-4-3 name=__codelineno-4-3 href=#__codelineno-4-3></a>
</span><span id=__span-4-4><a id=__codelineno-4-4 name=__codelineno-4-4 href=#__codelineno-4-4></a><span class=cm>/*</span>
</span><span id=__span-4-5><a id=__codelineno-4-5 name=__codelineno-4-5 href=#__codelineno-4-5></a><span class=cm>这次的结果可能如下所示：</span>
</span><span id=__span-4-6><a id=__codelineno-4-6 name=__codelineno-4-6 href=#__codelineno-4-6></a>
</span><span id=__span-4-7><a id=__codelineno-4-7 name=__codelineno-4-7 href=#__codelineno-4-7></a><span class=cm>NumericSize</span>
</span><span id=__span-4-8><a id=__codelineno-4-8 name=__codelineno-4-8 href=#__codelineno-4-8></a>
</span><span id=__span-4-9><a id=__codelineno-4-9 name=__codelineno-4-9 href=#__codelineno-4-9></a><span class=cm>58</span>
</span><span id=__span-4-10><a id=__codelineno-4-10 name=__codelineno-4-10 href=#__codelineno-4-10></a>
</span><span id=__span-4-11><a id=__codelineno-4-11 name=__codelineno-4-11 href=#__codelineno-4-11></a><span class=cm>58</span>
</span><span id=__span-4-12><a id=__codelineno-4-12 name=__codelineno-4-12 href=#__codelineno-4-12></a>
</span><span id=__span-4-13><a id=__codelineno-4-13 name=__codelineno-4-13 href=#__codelineno-4-13></a><span class=cm>Null</span>
</span><span id=__span-4-14><a id=__codelineno-4-14 name=__codelineno-4-14 href=#__codelineno-4-14></a>
</span><span id=__span-4-15><a id=__codelineno-4-15 name=__codelineno-4-15 href=#__codelineno-4-15></a><span class=cm>Null</span>
</span><span id=__span-4-16><a id=__codelineno-4-16 name=__codelineno-4-16 href=#__codelineno-4-16></a>
</span><span id=__span-4-17><a id=__codelineno-4-17 name=__codelineno-4-17 href=#__codelineno-4-17></a><span class=cm>...</span>
</span><span id=__span-4-18><a id=__codelineno-4-18 name=__codelineno-4-18 href=#__codelineno-4-18></a><span class=cm>*/</span>
</span></code></pre></div> <p>对于可转换为数值数据类型的值，将返回十进制值；对于不兼容的值，将返回 NULL，用于指示该值未知。</p> <h3 id=convert-try_convert>CONVERT 和 TRY_CONVERT</h3> <p>CAST 是 ANSI 标准 SQL 函数，用于转换数据类型，适用于许多数据库系统。 在 Transact-SQL 中还可以使用 CONVERT 函数，如下所示：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-5-1><a id=__codelineno-5-1 name=__codelineno-5-1 href=#__codelineno-5-1></a><span class=k>SELECT</span><span class=w> </span><span class=k>CONVERT</span><span class=p>(</span><span class=nb>varchar</span><span class=p>(</span><span class=mi>4</span><span class=p>),</span><span class=w> </span><span class=n>ProductID</span><span class=p>)</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s1>&#39;: &#39;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>ProductName</span>
</span><span id=__span-5-2><a id=__codelineno-5-2 name=__codelineno-5-2 href=#__codelineno-5-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span><span class=p>;</span>
</span><span id=__span-5-3><a id=__codelineno-5-3 name=__codelineno-5-3 href=#__codelineno-5-3></a>
</span><span id=__span-5-4><a id=__codelineno-5-4 name=__codelineno-5-4 href=#__codelineno-5-4></a><span class=cm>/*</span>
</span><span id=__span-5-5><a id=__codelineno-5-5 name=__codelineno-5-5 href=#__codelineno-5-5></a><span class=cm>同样，此查询将返回转换为指定数据类型的值，如下所示：</span>
</span><span id=__span-5-6><a id=__codelineno-5-6 name=__codelineno-5-6 href=#__codelineno-5-6></a>
</span><span id=__span-5-7><a id=__codelineno-5-7 name=__codelineno-5-7 href=#__codelineno-5-7></a><span class=cm>ProductName</span>
</span><span id=__span-5-8><a id=__codelineno-5-8 name=__codelineno-5-8 href=#__codelineno-5-8></a>
</span><span id=__span-5-9><a id=__codelineno-5-9 name=__codelineno-5-9 href=#__codelineno-5-9></a><span class=cm>680：HL 公路车架 - 黑色，58</span>
</span><span id=__span-5-10><a id=__codelineno-5-10 name=__codelineno-5-10 href=#__codelineno-5-10></a>
</span><span id=__span-5-11><a id=__codelineno-5-11 name=__codelineno-5-11 href=#__codelineno-5-11></a><span class=cm>706：HL 公路车架 - 红色，58</span>
</span><span id=__span-5-12><a id=__codelineno-5-12 name=__codelineno-5-12 href=#__codelineno-5-12></a>
</span><span id=__span-5-13><a id=__codelineno-5-13 name=__codelineno-5-13 href=#__codelineno-5-13></a><span class=cm>707：Sport-100 头盔，红色</span>
</span><span id=__span-5-14><a id=__codelineno-5-14 name=__codelineno-5-14 href=#__codelineno-5-14></a>
</span><span id=__span-5-15><a id=__codelineno-5-15 name=__codelineno-5-15 href=#__codelineno-5-15></a><span class=cm>708：Sport-100 头盔，黑色</span>
</span><span id=__span-5-16><a id=__codelineno-5-16 name=__codelineno-5-16 href=#__codelineno-5-16></a>
</span><span id=__span-5-17><a id=__codelineno-5-17 name=__codelineno-5-17 href=#__codelineno-5-17></a><span class=cm>...</span>
</span><span id=__span-5-18><a id=__codelineno-5-18 name=__codelineno-5-18 href=#__codelineno-5-18></a><span class=cm>*/</span>
</span></code></pre></div> <p>同 CAST 一样，CONVERT 包含 TRY_CONVERT 变量，对于不兼容的值将返回 NULL。</p> <p>相比 CAST，使用 CONVERT 的另一点好处是 CONVERT 还包括一个参数，该参数支持在将数值和日期值转换为字符串时指定格式样式。 例如，考虑以下查询：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-6-1><a id=__codelineno-6-1 name=__codelineno-6-1 href=#__codelineno-6-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>SellStartDate</span><span class=p>,</span>
</span><span id=__span-6-2><a id=__codelineno-6-2 name=__codelineno-6-2 href=#__codelineno-6-2></a><span class=w>       </span><span class=k>CONVERT</span><span class=p>(</span><span class=nb>varchar</span><span class=p>(</span><span class=mi>20</span><span class=p>),</span><span class=w> </span><span class=n>SellStartDate</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>StartDate</span><span class=p>,</span>
</span><span id=__span-6-3><a id=__codelineno-6-3 name=__codelineno-6-3 href=#__codelineno-6-3></a><span class=w>       </span><span class=k>CONVERT</span><span class=p>(</span><span class=nb>varchar</span><span class=p>(</span><span class=mi>10</span><span class=p>),</span><span class=w> </span><span class=n>SellStartDate</span><span class=p>,</span><span class=w> </span><span class=mi>101</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>FormattedStartDate</span><span class=w> </span>
</span><span id=__span-6-4><a id=__codelineno-6-4 name=__codelineno-6-4 href=#__codelineno-6-4></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span><span class=p>;</span>
</span><span id=__span-6-5><a id=__codelineno-6-5 name=__codelineno-6-5 href=#__codelineno-6-5></a>
</span><span id=__span-6-6><a id=__codelineno-6-6 name=__codelineno-6-6 href=#__codelineno-6-6></a><span class=cm>/*</span>
</span><span id=__span-6-7><a id=__codelineno-6-7 name=__codelineno-6-7 href=#__codelineno-6-7></a><span class=cm>该查询的结果可能如下所示：</span>
</span><span id=__span-6-8><a id=__codelineno-6-8 name=__codelineno-6-8 href=#__codelineno-6-8></a><span class=cm>SellStartDate          StartDate             FormattedStartDate</span>
</span><span id=__span-6-9><a id=__codelineno-6-9 name=__codelineno-6-9 href=#__codelineno-6-9></a><span class=cm>2002-06-01T00:00:00    Jun 1 2002 12:00AM    6/1/2002</span>
</span><span id=__span-6-10><a id=__codelineno-6-10 name=__codelineno-6-10 href=#__codelineno-6-10></a><span class=cm>2002-06-01T00:00:00    Jun 1 2002 12:00AM    6/1/2002</span>
</span><span id=__span-6-11><a id=__codelineno-6-11 name=__codelineno-6-11 href=#__codelineno-6-11></a><span class=cm>2005-07-01T00:00:00    Jul 1 2005 12:00AM    2005/7/1</span>
</span><span id=__span-6-12><a id=__codelineno-6-12 name=__codelineno-6-12 href=#__codelineno-6-12></a><span class=cm>2005-07-01T00:00:00    Jul 1 2005 12:00AM    2005/7/1</span>
</span><span id=__span-6-13><a id=__codelineno-6-13 name=__codelineno-6-13 href=#__codelineno-6-13></a><span class=cm>...                    ...                   ...</span>
</span><span id=__span-6-14><a id=__codelineno-6-14 name=__codelineno-6-14 href=#__codelineno-6-14></a><span class=cm>*/</span>
</span></code></pre></div> <details class=info> <summary>备注</summary> <p>隐式和显式转换适用于某些数据类型，有些转换是不可能的。 有关详细信息，请使用 <a href="https://learn.microsoft.com/zh-cn/sql/t-sql/functions/cast-and-convert-transact-sql?view=sql-server-ver16">Transact-SQL 参考文档</a>中的图表。</p> </details> <h3 id=parse-try_parse>PARSE 和 TRY_PARSE</h3> <p>PARSE 函数旨在转换代表数值或日期/时间值的格式化字符串。 例如，请考虑以下查询（使用文本值，而不是表中列的值）：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-7-1><a id=__codelineno-7-1 name=__codelineno-7-1 href=#__codelineno-7-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>PARSE</span><span class=p>(</span><span class=s1>&#39;01/01/2021&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=nb>date</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>DateValue</span><span class=p>,</span>
</span><span id=__span-7-2><a id=__codelineno-7-2 name=__codelineno-7-2 href=#__codelineno-7-2></a><span class=w>   </span><span class=n>PARSE</span><span class=p>(</span><span class=s1>&#39;$199.99&#39;</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>money</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>MoneyValue</span><span class=p>;</span>
</span><span id=__span-7-3><a id=__codelineno-7-3 name=__codelineno-7-3 href=#__codelineno-7-3></a>
</span><span id=__span-7-4><a id=__codelineno-7-4 name=__codelineno-7-4 href=#__codelineno-7-4></a><span class=cm>/*</span>
</span><span id=__span-7-5><a id=__codelineno-7-5 name=__codelineno-7-5 href=#__codelineno-7-5></a><span class=cm>该查询的结果如下所示：</span>
</span><span id=__span-7-6><a id=__codelineno-7-6 name=__codelineno-7-6 href=#__codelineno-7-6></a>
</span><span id=__span-7-7><a id=__codelineno-7-7 name=__codelineno-7-7 href=#__codelineno-7-7></a><span class=cm>DateValue                MoneyValue</span>
</span><span id=__span-7-8><a id=__codelineno-7-8 name=__codelineno-7-8 href=#__codelineno-7-8></a>
</span><span id=__span-7-9><a id=__codelineno-7-9 name=__codelineno-7-9 href=#__codelineno-7-9></a><span class=cm>2021-01-01T00:00:00      199.99</span>
</span><span id=__span-7-10><a id=__codelineno-7-10 name=__codelineno-7-10 href=#__codelineno-7-10></a><span class=cm>*/</span>
</span></code></pre></div> <p>同 CAST 和 CONVERT 类似，PARSE 包含一个 TRY_PARSE 变量，对于不兼容的值将返回 NULL。</p> <h3 id=str><a href="https://learn.microsoft.com/zh-cn/sql/t-sql/functions/str-transact-sql?view=sql-server-ver16">STR</a></h3> <p>STR 函数可将数值转换为 varchar。</p> <p>例如：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-8-1><a id=__codelineno-8-1 name=__codelineno-8-1 href=#__codelineno-8-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductID</span><span class=p>,</span><span class=w>  </span><span class=s1>&#39;$&#39;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>STR</span><span class=p>(</span><span class=n>ListPrice</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Price</span>
</span><span id=__span-8-2><a id=__codelineno-8-2 name=__codelineno-8-2 href=#__codelineno-8-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span><span class=p>;</span>
</span><span id=__span-8-3><a id=__codelineno-8-3 name=__codelineno-8-3 href=#__codelineno-8-3></a>
</span><span id=__span-8-4><a id=__codelineno-8-4 name=__codelineno-8-4 href=#__codelineno-8-4></a><span class=cm>/*</span>
</span><span id=__span-8-5><a id=__codelineno-8-5 name=__codelineno-8-5 href=#__codelineno-8-5></a><span class=cm>结果将如下所示：</span>
</span><span id=__span-8-6><a id=__codelineno-8-6 name=__codelineno-8-6 href=#__codelineno-8-6></a>
</span><span id=__span-8-7><a id=__codelineno-8-7 name=__codelineno-8-7 href=#__codelineno-8-7></a><span class=cm>ProductID                价格</span>
</span><span id=__span-8-8><a id=__codelineno-8-8 name=__codelineno-8-8 href=#__codelineno-8-8></a>
</span><span id=__span-8-9><a id=__codelineno-8-9 name=__codelineno-8-9 href=#__codelineno-8-9></a><span class=cm>680                      $1432.00</span>
</span><span id=__span-8-10><a id=__codelineno-8-10 name=__codelineno-8-10 href=#__codelineno-8-10></a>
</span><span id=__span-8-11><a id=__codelineno-8-11 name=__codelineno-8-11 href=#__codelineno-8-11></a><span class=cm>706                      $1432.00</span>
</span><span id=__span-8-12><a id=__codelineno-8-12 name=__codelineno-8-12 href=#__codelineno-8-12></a>
</span><span id=__span-8-13><a id=__codelineno-8-13 name=__codelineno-8-13 href=#__codelineno-8-13></a><span class=cm>707                      $35.00</span>
</span><span id=__span-8-14><a id=__codelineno-8-14 name=__codelineno-8-14 href=#__codelineno-8-14></a>
</span><span id=__span-8-15><a id=__codelineno-8-15 name=__codelineno-8-15 href=#__codelineno-8-15></a><span class=cm>...                      ...</span>
</span><span id=__span-8-16><a id=__codelineno-8-16 name=__codelineno-8-16 href=#__codelineno-8-16></a><span class=cm>*/</span>
</span><span id=__span-8-17><a id=__codelineno-8-17 name=__codelineno-8-17 href=#__codelineno-8-17></a>
</span><span id=__span-8-18><a id=__codelineno-8-18 name=__codelineno-8-18 href=#__codelineno-8-18></a><span class=cm>/* 注意</span>
</span><span id=__span-8-19><a id=__codelineno-8-19 name=__codelineno-8-19 href=#__codelineno-8-19></a><span class=cm>STR(RevisionNumber, 1)</span>
</span><span id=__span-8-20><a id=__codelineno-8-20 name=__codelineno-8-20 href=#__codelineno-8-20></a><span class=cm>SO71895 (2)                   2008.06.01</span>
</span><span id=__span-8-21><a id=__codelineno-8-21 name=__codelineno-8-21 href=#__codelineno-8-21></a>
</span><span id=__span-8-22><a id=__codelineno-8-22 name=__codelineno-8-22 href=#__codelineno-8-22></a><span class=cm>STR(RevisionNumber)</span>
</span><span id=__span-8-23><a id=__codelineno-8-23 name=__codelineno-8-23 href=#__codelineno-8-23></a><span class=cm>SO71938 (         2)                   2008.06.01</span>
</span></code></pre></div> <h2 id=null>处理 NULL</h2> <p>NULL 值表示“无值”或“未知”。 不是指零或空白，也不表示空字符串。 这些值并不是未知。 NULL 值可用于表示尚未提供的值，例如客户尚未提供电子邮件地址时。 如前文所述，当某个值与目标数据类型不兼容时，一些转换函数也可能返回 NULL 值。</p> <p>要处理 NULL，通常需要采取特殊的步骤。 NULL 实际上是非值。 它是未知的。 不等于任何内容，也等于任何内容。 NULL 不大于或小于任何内容。 对于它是什么，我们一无所解，但有时我们需要处理 NULL 值。 令人欣慰的是，T-SQL 提供用于转换或替换 NULL 值的函数。</p> <h3 id=isnull>ISNULL</h3> <p>COUNTX 函数有两个参数。 第一个是我们要测试的表达式。 如果第一个参数为 NULL，则该函数将返回第二个参数。 如果第一个表达式不是 NULL，则返回不变的值。</p> <p>例如，假设数据库中的 Sales.Customer 表包含一个允许 NULL 值的 MiddleName 列。 查询此表时，可以选择返回特定值（如“无”），而不是在结果中返回 NULL。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-9-1><a id=__codelineno-9-1 name=__codelineno-9-1 href=#__codelineno-9-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>FirstName</span><span class=p>,</span>
</span><span id=__span-9-2><a id=__codelineno-9-2 name=__codelineno-9-2 href=#__codelineno-9-2></a><span class=w>      </span><span class=k>ISNULL</span><span class=p>(</span><span class=n>MiddleName</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;None&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>MiddleIfAny</span><span class=p>,</span>
</span><span id=__span-9-3><a id=__codelineno-9-3 name=__codelineno-9-3 href=#__codelineno-9-3></a><span class=w>      </span><span class=n>LastName</span>
</span><span id=__span-9-4><a id=__codelineno-9-4 name=__codelineno-9-4 href=#__codelineno-9-4></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>Customer</span><span class=p>;</span>
</span><span id=__span-9-5><a id=__codelineno-9-5 name=__codelineno-9-5 href=#__codelineno-9-5></a>
</span><span id=__span-9-6><a id=__codelineno-9-6 name=__codelineno-9-6 href=#__codelineno-9-6></a><span class=cm>/*</span>
</span><span id=__span-9-7><a id=__codelineno-9-7 name=__codelineno-9-7 href=#__codelineno-9-7></a><span class=cm>FirstName            MiddleIfAny          LastName</span>
</span><span id=__span-9-8><a id=__codelineno-9-8 name=__codelineno-9-8 href=#__codelineno-9-8></a><span class=cm>奥兰多                N.                   Gee</span>
</span><span id=__span-9-9><a id=__codelineno-9-9 name=__codelineno-9-9 href=#__codelineno-9-9></a><span class=cm>Keith                无                   Howard</span>
</span><span id=__span-9-10><a id=__codelineno-9-10 name=__codelineno-9-10 href=#__codelineno-9-10></a><span class=cm>...                  ...                  ...</span>
</span><span id=__span-9-11><a id=__codelineno-9-11 name=__codelineno-9-11 href=#__codelineno-9-11></a><span class=cm>*/</span>
</span></code></pre></div> <p><strong>替换 NULL 的值必须与要计算的表达式的数据类型相同。 在以上示例中，MiddleName 是 varchar 类型，因此替换值不能是数值。 此外，需要选择不会作为常规值在数据中显示的值。 有时，可能很难找到永远不会出现在数据中的值。</strong></p> <p>前面示例处理了源表中的 NULL 值，但可以对可能返回 NULL 的任何表达式使用 ISNULL，包括在 ISNULL 函数中嵌套 TRY_CONVERT 函数。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-10-1><a id=__codelineno-10-1 name=__codelineno-10-1 href=#__codelineno-10-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>OrderID</span><span class=p>,</span>
</span><span id=__span-10-2><a id=__codelineno-10-2 name=__codelineno-10-2 href=#__codelineno-10-2></a><span class=w>       </span><span class=k>ISNULL</span><span class=p>(</span><span class=n>TRY_CONVERT</span><span class=p>(</span><span class=nb>decimal</span><span class=p>(</span><span class=mi>10</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>),</span><span class=w> </span><span class=n>Amount</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>ValidAmount</span>
</span><span id=__span-10-3><a id=__codelineno-10-3 name=__codelineno-10-3 href=#__codelineno-10-3></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=k>Order</span><span class=p>;</span>
</span><span id=__span-10-4><a id=__codelineno-10-4 name=__codelineno-10-4 href=#__codelineno-10-4></a>
</span><span id=__span-10-5><a id=__codelineno-10-5 name=__codelineno-10-5 href=#__codelineno-10-5></a><span class=cm>/*</span>
</span><span id=__span-10-6><a id=__codelineno-10-6 name=__codelineno-10-6 href=#__codelineno-10-6></a><span class=cm>示例：</span>
</span><span id=__span-10-7><a id=__codelineno-10-7 name=__codelineno-10-7 href=#__codelineno-10-7></a><span class=cm>假设 Sales.Order 表中的数据如下：</span>
</span><span id=__span-10-8><a id=__codelineno-10-8 name=__codelineno-10-8 href=#__codelineno-10-8></a>
</span><span id=__span-10-9><a id=__codelineno-10-9 name=__codelineno-10-9 href=#__codelineno-10-9></a><span class=cm>OrderID Amount</span>
</span><span id=__span-10-10><a id=__codelineno-10-10 name=__codelineno-10-10 href=#__codelineno-10-10></a><span class=cm>1   100.50</span>
</span><span id=__span-10-11><a id=__codelineno-10-11 name=__codelineno-10-11 href=#__codelineno-10-11></a><span class=cm>2   NULL</span>
</span><span id=__span-10-12><a id=__codelineno-10-12 name=__codelineno-10-12 href=#__codelineno-10-12></a><span class=cm>3   &#39;Invalid&#39;</span>
</span><span id=__span-10-13><a id=__codelineno-10-13 name=__codelineno-10-13 href=#__codelineno-10-13></a><span class=cm>4   150.75</span>
</span><span id=__span-10-14><a id=__codelineno-10-14 name=__codelineno-10-14 href=#__codelineno-10-14></a><span class=cm>执行上述查询后，你会得到：</span>
</span><span id=__span-10-15><a id=__codelineno-10-15 name=__codelineno-10-15 href=#__codelineno-10-15></a>
</span><span id=__span-10-16><a id=__codelineno-10-16 name=__codelineno-10-16 href=#__codelineno-10-16></a><span class=cm>OrderID ValidAmount</span>
</span><span id=__span-10-17><a id=__codelineno-10-17 name=__codelineno-10-17 href=#__codelineno-10-17></a><span class=cm>1   100.50</span>
</span><span id=__span-10-18><a id=__codelineno-10-18 name=__codelineno-10-18 href=#__codelineno-10-18></a><span class=cm>2   0.00</span>
</span><span id=__span-10-19><a id=__codelineno-10-19 name=__codelineno-10-19 href=#__codelineno-10-19></a><span class=cm>3   0.00</span>
</span><span id=__span-10-20><a id=__codelineno-10-20 name=__codelineno-10-20 href=#__codelineno-10-20></a><span class=cm>4   150.75</span>
</span><span id=__span-10-21><a id=__codelineno-10-21 name=__codelineno-10-21 href=#__codelineno-10-21></a><span class=cm>*/</span>
</span></code></pre></div> <h3 id=coalesce>COALESCE</h3> <p>ISNULL 函数不是 ANSI 标准函数，因此你可能希望改为使用 COALESCE 函数。 COALESCE 稍微灵活一些，它可以采用可变数量的参数，每个参数都是一个表达式。 <u>它将返回列表中第一个不为 NULL 的表达式</u>。</p> <p>如果只有两个参数，则 COALESCE 的行为与 ISNULL 类似。 但是，对于两个以上参数，COALESCE 可以用作使用 ISNULL 的多部分 CASE 表达式的替代项。</p> <p>如果所有参数均为 NULL，则 COALESCE 返回 NULL。 所有表达式必须返回相同或兼容的数据类型。</p> <p>语法如下：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-11-1><a id=__codelineno-11-1 name=__codelineno-11-1 href=#__codelineno-11-1></a><span class=k>SELECT</span><span class=w> </span><span class=k>COALESCE</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=n>expression1</span><span class=p>,</span><span class=w> </span><span class=n>expression2</span><span class=p>,</span><span class=w> </span><span class=p>[</span><span class=w> </span><span class=p>,...</span><span class=n>n</span><span class=w> </span><span class=p>]</span><span class=w> </span><span class=p>)</span>
</span></code></pre></div> <p>以下示例使用一个名为 HR.Wages 的虚构表，其中包括三列有关雇员每周收益的信息：每小时费率、每周工资和每单位销售的佣金。 但是，每个雇员只能接受一种付款方式。 对于每位雇员，三列中有一列会包含一个值，其他两列将为 NULL。 要确定支付给每位雇员的总金额，可以使用 COALESCE 仅返回在这三列中找到的非 null 值。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-12-1><a id=__codelineno-12-1 name=__codelineno-12-1 href=#__codelineno-12-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>EmployeeID</span><span class=p>,</span>
</span><span id=__span-12-2><a id=__codelineno-12-2 name=__codelineno-12-2 href=#__codelineno-12-2></a><span class=w>      </span><span class=k>COALESCE</span><span class=p>(</span><span class=n>HourlyRate</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>40</span><span class=p>,</span>
</span><span id=__span-12-3><a id=__codelineno-12-3 name=__codelineno-12-3 href=#__codelineno-12-3></a><span class=w>                </span><span class=n>WeeklySalary</span><span class=p>,</span>
</span><span id=__span-12-4><a id=__codelineno-12-4 name=__codelineno-12-4 href=#__codelineno-12-4></a><span class=w>                </span><span class=n>Commission</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>SalesQty</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>WeeklyEarnings</span>
</span><span id=__span-12-5><a id=__codelineno-12-5 name=__codelineno-12-5 href=#__codelineno-12-5></a><span class=k>FROM</span><span class=w> </span><span class=n>HR</span><span class=p>.</span><span class=n>Wages</span><span class=p>;</span>
</span><span id=__span-12-6><a id=__codelineno-12-6 name=__codelineno-12-6 href=#__codelineno-12-6></a>
</span><span id=__span-12-7><a id=__codelineno-12-7 name=__codelineno-12-7 href=#__codelineno-12-7></a><span class=cm>/*</span>
</span><span id=__span-12-8><a id=__codelineno-12-8 name=__codelineno-12-8 href=#__codelineno-12-8></a><span class=cm>结果可能如下所示：</span>
</span><span id=__span-12-9><a id=__codelineno-12-9 name=__codelineno-12-9 href=#__codelineno-12-9></a>
</span><span id=__span-12-10><a id=__codelineno-12-10 name=__codelineno-12-10 href=#__codelineno-12-10></a><span class=cm>EmployeeID             WeeklyEarnings</span>
</span><span id=__span-12-11><a id=__codelineno-12-11 name=__codelineno-12-11 href=#__codelineno-12-11></a>
</span><span id=__span-12-12><a id=__codelineno-12-12 name=__codelineno-12-12 href=#__codelineno-12-12></a><span class=cm>1                      899.76</span>
</span><span id=__span-12-13><a id=__codelineno-12-13 name=__codelineno-12-13 href=#__codelineno-12-13></a>
</span><span id=__span-12-14><a id=__codelineno-12-14 name=__codelineno-12-14 href=#__codelineno-12-14></a><span class=cm>2                      1001.00</span>
</span><span id=__span-12-15><a id=__codelineno-12-15 name=__codelineno-12-15 href=#__codelineno-12-15></a>
</span><span id=__span-12-16><a id=__codelineno-12-16 name=__codelineno-12-16 href=#__codelineno-12-16></a><span class=cm>3                      1298.77</span>
</span><span id=__span-12-17><a id=__codelineno-12-17 name=__codelineno-12-17 href=#__codelineno-12-17></a>
</span><span id=__span-12-18><a id=__codelineno-12-18 name=__codelineno-12-18 href=#__codelineno-12-18></a><span class=cm>...                    ...</span>
</span><span id=__span-12-19><a id=__codelineno-12-19 name=__codelineno-12-19 href=#__codelineno-12-19></a><span class=cm>*/</span>
</span></code></pre></div> <h3 id=nullif>NULLIF</h3> <p>NULLIF 函数允许在某些条件下返回 NULL。 在数据清理等领域想要将空白或占位符字符替换为 NULL 时，该函数十分有用。</p> <p>NULLIF 采用两个参数，如果它们等效，则返回 NULL。 如果它们不相等，则 NULLIF 将返回第一个参数。</p> <p>在此示例中，NULLIF 将折扣 0 替换成了 NULL。 如果折扣值不是 0，则返回该折扣值：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-13-1><a id=__codelineno-13-1 name=__codelineno-13-1 href=#__codelineno-13-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>SalesOrderID</span><span class=p>,</span>
</span><span id=__span-13-2><a id=__codelineno-13-2 name=__codelineno-13-2 href=#__codelineno-13-2></a><span class=w>      </span><span class=n>ProductID</span><span class=p>,</span>
</span><span id=__span-13-3><a id=__codelineno-13-3 name=__codelineno-13-3 href=#__codelineno-13-3></a><span class=w>      </span><span class=n>UnitPrice</span><span class=p>,</span>
</span><span id=__span-13-4><a id=__codelineno-13-4 name=__codelineno-13-4 href=#__codelineno-13-4></a><span class=w>      </span><span class=k>NULLIF</span><span class=p>(</span><span class=n>UnitPriceDiscount</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Discount</span>
</span><span id=__span-13-5><a id=__codelineno-13-5 name=__codelineno-13-5 href=#__codelineno-13-5></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrderDetail</span><span class=p>;</span>
</span><span id=__span-13-6><a id=__codelineno-13-6 name=__codelineno-13-6 href=#__codelineno-13-6></a>
</span><span id=__span-13-7><a id=__codelineno-13-7 name=__codelineno-13-7 href=#__codelineno-13-7></a><span class=cm>/*</span>
</span><span id=__span-13-8><a id=__codelineno-13-8 name=__codelineno-13-8 href=#__codelineno-13-8></a><span class=cm>结果可能如下所示：</span>
</span><span id=__span-13-9><a id=__codelineno-13-9 name=__codelineno-13-9 href=#__codelineno-13-9></a>
</span><span id=__span-13-10><a id=__codelineno-13-10 name=__codelineno-13-10 href=#__codelineno-13-10></a><span class=cm>销售订单 ID         ProductID          单价            折扣</span>
</span><span id=__span-13-11><a id=__codelineno-13-11 name=__codelineno-13-11 href=#__codelineno-13-11></a>
</span><span id=__span-13-12><a id=__codelineno-13-12 name=__codelineno-13-12 href=#__codelineno-13-12></a><span class=cm>71774              836                356.898        Null</span>
</span><span id=__span-13-13><a id=__codelineno-13-13 name=__codelineno-13-13 href=#__codelineno-13-13></a>
</span><span id=__span-13-14><a id=__codelineno-13-14 name=__codelineno-13-14 href=#__codelineno-13-14></a><span class=cm>71780              988                112.998        0.4               </span>
</span><span id=__span-13-15><a id=__codelineno-13-15 name=__codelineno-13-15 href=#__codelineno-13-15></a>
</span><span id=__span-13-16><a id=__codelineno-13-16 name=__codelineno-13-16 href=#__codelineno-13-16></a><span class=cm>71781              748                818.7          Null</span>
</span><span id=__span-13-17><a id=__codelineno-13-17 name=__codelineno-13-17 href=#__codelineno-13-17></a>
</span><span id=__span-13-18><a id=__codelineno-13-18 name=__codelineno-13-18 href=#__codelineno-13-18></a><span class=cm>71781              985                112.998        0.4</span>
</span><span id=__span-13-19><a id=__codelineno-13-19 name=__codelineno-13-19 href=#__codelineno-13-19></a>
</span><span id=__span-13-20><a id=__codelineno-13-20 name=__codelineno-13-20 href=#__codelineno-13-20></a><span class=cm>...                ...                ...            ...</span>
</span></code></pre></div> <h2 id=_7>插入数据</h2> <h3 id=insert>INSERT 语句</h3> <p>INSERT 语句用于向表中添加一行或多行。 语句的形式有数种。</p> <p>简单 INSERT 语句的基本语法如下所示：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-14-1><a id=__codelineno-14-1 name=__codelineno-14-1 href=#__codelineno-14-1></a><span class=k>INSERT</span><span class=w> </span><span class=p>[</span><span class=k>INTO</span><span class=p>]</span><span class=w> </span><span class=o>&lt;</span><span class=k>Table</span><span class=o>&gt;</span><span class=w> </span><span class=p>[(</span><span class=n>column_list</span><span class=p>)]</span>
</span><span id=__span-14-2><a id=__codelineno-14-2 name=__codelineno-14-2 href=#__codelineno-14-2></a><span class=k>VALUES</span><span class=w> </span><span class=p>([</span><span class=n>ColumnName</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=n>an</span><span class=w> </span><span class=n>expression</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=k>DEFAULT</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=k>NULL</span><span class=p>],</span><span class=err>…</span><span class=n>n</span><span class=p>)</span>
</span></code></pre></div> <p>利用这种形式的 INSERT 语句（称为“插入值”），可以指定将在其中放置值的列以及为插入表中的每一行显示数据的顺序。 column_list 是可选的，但建议使用。 在没有 column_list 的情况下，INSERT 语句对表中的每一列都期望一个值，顺序与定义列的顺序相同。 还可以作为逗号分隔列表来提供这些列的值。</p> <p>列出值时，关键字 DEFAULT 表示将使用某个预定义值（表创建表时指定）。 可通过三种方式确定默认值：</p> <ul> <li>如果列已定义为具有自动生成的值，则将使用该值。 本模块后续部分中将讨论自动生成值。</li> <li>创建表时，可以为列提供默认值，如果指定了 DEFAULT，则使用该默认值。</li> <li>如果列已定义为允许 NULL 值，并且该列不是自动生成的列，且没有定义默认值，则 NULL 将作为 DEFAULT 插入。</li> </ul> <p>表创建的细节超出了本模块的范围。 但是，查看表中有哪些列通常很有用。 最简单的方法就是对表执行 SELECT 语句，而不返回任何行。 通过使用永远不会返回 TRUE 值的 WHERE 条件，不能返回任何行。</p> <table> <thead> <tr> <th>PromotionName</th> <th>StartDate</th> <th>ProductModelID</th> <th>折扣</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td></td> <td></td> <td></td> <td></td> <td></td> </tr> </tbody> </table> <div class="language-sql highlight"><pre><span></span><code><span id=__span-15-1><a id=__codelineno-15-1 name=__codelineno-15-1 href=#__codelineno-15-1></a><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>Promotion</span><span class=w> </span><span class=p>(</span><span class=n>PromotionName</span><span class=p>,</span><span class=n>StartDate</span><span class=p>,</span><span class=n>ProductModelID</span><span class=p>,</span><span class=n>Discount</span><span class=p>,</span><span class=n>Notes</span><span class=p>)</span>
</span><span id=__span-15-2><a id=__codelineno-15-2 name=__codelineno-15-2 href=#__codelineno-15-2></a><span class=k>VALUES</span>
</span><span id=__span-15-3><a id=__codelineno-15-3 name=__codelineno-15-3 href=#__codelineno-15-3></a><span class=p>(</span><span class=s1>&#39;Clearance Sale&#39;</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;01/01/2021&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>23</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;10% discount&#39;</span><span class=p>);</span>
</span><span id=__span-15-4><a id=__codelineno-15-4 name=__codelineno-15-4 href=#__codelineno-15-4></a><span class=c1>-- 对于上面的示例，可以省略列清单，因为我们按正确的顺序为每列提供一个值：</span>
</span><span id=__span-15-5><a id=__codelineno-15-5 name=__codelineno-15-5 href=#__codelineno-15-5></a>
</span><span id=__span-15-6><a id=__codelineno-15-6 name=__codelineno-15-6 href=#__codelineno-15-6></a><span class=c1>-- 假设表定义为：当前日期的默认值应用于 StartDate 列，并且 Notes 列允许 NULL 值。 可以明确指示想要使用这些值，如下所示：</span>
</span><span id=__span-15-7><a id=__codelineno-15-7 name=__codelineno-15-7 href=#__codelineno-15-7></a>
</span><span id=__span-15-8><a id=__codelineno-15-8 name=__codelineno-15-8 href=#__codelineno-15-8></a><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>Promotion</span>
</span><span id=__span-15-9><a id=__codelineno-15-9 name=__codelineno-15-9 href=#__codelineno-15-9></a><span class=k>VALUES</span>
</span><span id=__span-15-10><a id=__codelineno-15-10 name=__codelineno-15-10 href=#__codelineno-15-10></a><span class=p>(</span><span class=s1>&#39;Pull your socks up&#39;</span><span class=p>,</span><span class=w> </span><span class=k>DEFAULT</span><span class=p>,</span><span class=w> </span><span class=mi>24</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>25</span><span class=p>,</span><span class=w> </span><span class=k>NULL</span><span class=p>);</span>
</span><span id=__span-15-11><a id=__codelineno-15-11 name=__codelineno-15-11 href=#__codelineno-15-11></a>
</span><span id=__span-15-12><a id=__codelineno-15-12 name=__codelineno-15-12 href=#__codelineno-15-12></a><span class=cm>/*或者，可以省略 INSERT 语句中的值，如果省略，则使用默认值（如果已定义），如果没有默认值，但列允许 NULL 值，则将插入 NULL。 如果没有为所有列提供值，则必须包含列清单，指出为哪些列提供了值。*/</span>
</span><span id=__span-15-13><a id=__codelineno-15-13 name=__codelineno-15-13 href=#__codelineno-15-13></a>
</span><span id=__span-15-14><a id=__codelineno-15-14 name=__codelineno-15-14 href=#__codelineno-15-14></a><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>Promotion</span><span class=w> </span><span class=p>(</span><span class=n>PromotionName</span><span class=p>,</span><span class=w> </span><span class=n>ProductModelID</span><span class=p>,</span><span class=w> </span><span class=n>Discount</span><span class=p>)</span>
</span><span id=__span-15-15><a id=__codelineno-15-15 name=__codelineno-15-15 href=#__codelineno-15-15></a><span class=k>VALUES</span>
</span><span id=__span-15-16><a id=__codelineno-15-16 name=__codelineno-15-16 href=#__codelineno-15-16></a><span class=p>(</span><span class=s1>&#39;Caps Locked&#39;</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>2</span><span class=p>);</span>
</span><span id=__span-15-17><a id=__codelineno-15-17 name=__codelineno-15-17 href=#__codelineno-15-17></a>
</span><span id=__span-15-18><a id=__codelineno-15-18 name=__codelineno-15-18 href=#__codelineno-15-18></a><span class=cm>/* INSERT VALUES 语句除了能够一次插入一行之外，还可用于插入多行，方法是提供多个逗号分隔的值集。 值集也用逗号分隔，如下所示：</span>
</span><span id=__span-15-19><a id=__codelineno-15-19 name=__codelineno-15-19 href=#__codelineno-15-19></a><span class=cm>(col1_val,col2_val,col3_val),</span>
</span><span id=__span-15-20><a id=__codelineno-15-20 name=__codelineno-15-20 href=#__codelineno-15-20></a><span class=cm>(col1_val,col2_val,col3_val)</span>
</span><span id=__span-15-21><a id=__codelineno-15-21 name=__codelineno-15-21 href=#__codelineno-15-21></a><span class=cm>*/</span>
</span><span id=__span-15-22><a id=__codelineno-15-22 name=__codelineno-15-22 href=#__codelineno-15-22></a><span class=c1>-- 这一值列表称为表值构造函数。 下面的示例使用表值构造函数将另外两行插入表中：</span>
</span><span id=__span-15-23><a id=__codelineno-15-23 name=__codelineno-15-23 href=#__codelineno-15-23></a>
</span><span id=__span-15-24><a id=__codelineno-15-24 name=__codelineno-15-24 href=#__codelineno-15-24></a><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>Promotion</span>
</span><span id=__span-15-25><a id=__codelineno-15-25 name=__codelineno-15-25 href=#__codelineno-15-25></a><span class=k>VALUES</span>
</span><span id=__span-15-26><a id=__codelineno-15-26 name=__codelineno-15-26 href=#__codelineno-15-26></a><span class=p>(</span><span class=s1>&#39;The gloves are off!&#39;</span><span class=p>,</span><span class=w> </span><span class=k>DEFAULT</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>25</span><span class=p>,</span><span class=w> </span><span class=k>NULL</span><span class=p>),</span>
</span><span id=__span-15-27><a id=__codelineno-15-27 name=__codelineno-15-27 href=#__codelineno-15-27></a><span class=p>(</span><span class=s1>&#39;The gloves are off!&#39;</span><span class=p>,</span><span class=w> </span><span class=k>DEFAULT</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>25</span><span class=p>,</span><span class=w> </span><span class=k>NULL</span><span class=p>);</span>
</span></code></pre></div> <h3 id=insert-select>INSERT ... SELECT</h3> <p>除了在 INSERT 语句中指定一组文本值以外，T-SQL 还支持使用其他运算的结果来提供 INSERT 的值。 可以使用 SELECT 语句的结果或存储过程的输出来提供 INSERT 语句的值。</p> <p>要将 INSERT 与嵌套 SELECT 一起使用，请生成一个 SELECT 语句来替换 VALUES 子句。 通过这种格式（称为 INSERT SELECT），<u>可将 SELECT 查询返回的行集插入到目标表中</u>。 使用 INSERT SELECT 时，将显示与 INSERT VALUES 相同的注意事项：</p> <ul> <li>可以选择在表名称后面指定列清单。</li> <li>必须为每个列提供列值或默认值，或者提供 DEFAULT 或 NULL。</li> </ul> <p>以下语法说明了 INSERT SELECT 的用法：</p> <p>以下语法说明了 INSERT SELECT 的用法：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-16-1><a id=__codelineno-16-1 name=__codelineno-16-1 href=#__codelineno-16-1></a><span class=k>INSERT</span><span class=w> </span><span class=p>[</span><span class=k>INTO</span><span class=p>]</span><span class=w> </span><span class=o>&lt;</span><span class=k>table</span><span class=w> </span><span class=k>or</span><span class=w> </span><span class=k>view</span><span class=o>&gt;</span><span class=w> </span><span class=p>[(</span><span class=n>column_list</span><span class=p>)]</span>
</span><span id=__span-16-2><a id=__codelineno-16-2 name=__codelineno-16-2 href=#__codelineno-16-2></a><span class=k>SELECT</span><span class=w> </span><span class=o>&lt;</span><span class=n>column_list</span><span class=o>&gt;</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=o>&lt;</span><span class=n>table_list</span><span class=o>&gt;</span><span class=p>...;</span>
</span></code></pre></div> <p><strong>也可以将来自存储过程（甚至动态批处理）的结果集用作 INSERT 语句的输入。 这种格式的 INSERT（称为 INSERT EXEC）在概念上类似于 INSERT SELECT，并且将显示相同的注意事项。 但是，存储过程可能会返回多个结果集，因此需要格外小心。</strong></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-17-1><a id=__codelineno-17-1 name=__codelineno-17-1 href=#__codelineno-17-1></a><span class=c1>-- 以下示例将为名为 Get Framed 的新促销插入多行，方法是：从 Production.ProductModel（这是一个表，列出了名称中包含“frame”的所有模型）中检索模型 ID 和模型名称。</span>
</span><span id=__span-17-2><a id=__codelineno-17-2 name=__codelineno-17-2 href=#__codelineno-17-2></a>
</span><span id=__span-17-3><a id=__codelineno-17-3 name=__codelineno-17-3 href=#__codelineno-17-3></a><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>Promotion</span><span class=w> </span><span class=p>(</span><span class=n>PromotionName</span><span class=p>,</span><span class=w> </span><span class=n>ProductModelID</span><span class=p>,</span><span class=w> </span><span class=n>Discount</span><span class=p>,</span><span class=w> </span><span class=n>Notes</span><span class=p>)</span>
</span><span id=__span-17-4><a id=__codelineno-17-4 name=__codelineno-17-4 href=#__codelineno-17-4></a><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=s1>&#39;Get Framed&#39;</span><span class=p>,</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>ProductModelID</span><span class=p>,</span><span class=w> </span><span class=mi>0</span><span class=p>.</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=s1>&#39;10% off &#39;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>Name</span>
</span><span id=__span-17-5><a id=__codelineno-17-5 name=__codelineno-17-5 href=#__codelineno-17-5></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>ProductModel</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>m</span>
</span><span id=__span-17-6><a id=__codelineno-17-6 name=__codelineno-17-6 href=#__codelineno-17-6></a><span class=k>WHERE</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>Name</span><span class=w> </span><span class=k>LIKE</span><span class=w> </span><span class=s1>&#39;%frame%&#39;</span><span class=p>;</span>
</span><span id=__span-17-7><a id=__codelineno-17-7 name=__codelineno-17-7 href=#__codelineno-17-7></a>
</span><span id=__span-17-8><a id=__codelineno-17-8 name=__codelineno-17-8 href=#__codelineno-17-8></a><span class=c1>-- 与子查询不同，与 INSERT 一起使用的嵌套 SELECT 不用括号括起。</span>
</span></code></pre></div> <h3 id=select-into>SELECT ... INTO</h3> <p>插入行的另一种选择是 SELECT INTO 语句，该语句与 INSERT SELECT 语句类似。 INSERT SELECT 和 SELECT INTO 的最大区别在于，<u>SELECT INTO 不能用于将行插入到现有表中，因为 SELECT INTO 始终会根据 SELECT 的结果创建一个新表。 新表中的每列的名称、数据类型、为 null 性均与 SELECT 列表中对应的列（或表达式）相同。</u></p> <p>要使用 SELECT INTO，请在查询的 SELECT 子句中添加 &lt;&gt;（就在 FROM 子句前面）。 下面的示例将 Sales.SalesOrderHeader 表中的数据提取到名为 Sales.Invoice 的新表中。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-18-1><a id=__codelineno-18-1 name=__codelineno-18-1 href=#__codelineno-18-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>SalesOrderID</span><span class=p>,</span><span class=w> </span><span class=n>CustomerID</span><span class=p>,</span><span class=w> </span><span class=n>OrderDate</span><span class=p>,</span><span class=w> </span><span class=n>PurchaseOrderNumber</span><span class=p>,</span><span class=w> </span><span class=n>TotalDue</span>
</span><span id=__span-18-2><a id=__codelineno-18-2 name=__codelineno-18-2 href=#__codelineno-18-2></a><span class=k>INTO</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>Invoice</span>
</span><span id=__span-18-3><a id=__codelineno-18-3 name=__codelineno-18-3 href=#__codelineno-18-3></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrderHeader</span><span class=p>;</span>
</span></code></pre></div> <p><strong>如果已经存在一个表名与 INTO 后面指定的名称相同，则 SELECT INTO 将失败</strong>。 创建表后，可以像处理任何其他表一样处理该表。 可以选择这个表，将其联接到其他表，或在表中插入更多行。</p> <p><a href=https://microsoftlearning.github.io/dp-080-Transact-SQL/Instructions/Labs/00-setup.html>SQL Server labs</a>（Microsoft Azure Data Studio连接不上）</p> <p><a href=../assets/T-SQL/adventureworkslt.sql>adventureworkslt.sql</a> （本地数据库跑一个）</p> <p><a href=https://microsoftlearning.github.io/dp-080-Transact-SQL/Instructions/Labs/01-get-started-with-tsql.html>练习 - 使用 SELECT 语句</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-19-1><a id=__codelineno-19-1 name=__codelineno-19-1 href=#__codelineno-19-1></a><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>SalesOrderID</span><span class=p>,</span><span class=w> </span><span class=n>OrderDate</span><span class=p>,</span>
</span><span id=__span-19-2><a id=__codelineno-19-2 name=__codelineno-19-2 href=#__codelineno-19-2></a><span class=w>     </span><span class=k>CASE</span>
</span><span id=__span-19-3><a id=__codelineno-19-3 name=__codelineno-19-3 href=#__codelineno-19-3></a><span class=w>         </span><span class=k>WHEN</span><span class=w> </span><span class=n>ShipDate</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NULL</span><span class=w> </span><span class=k>THEN</span><span class=w> </span><span class=s1>&#39;Awaiting Shipment&#39;</span>
</span><span id=__span-19-4><a id=__codelineno-19-4 name=__codelineno-19-4 href=#__codelineno-19-4></a><span class=w>         </span><span class=k>ELSE</span><span class=w> </span><span class=s1>&#39;Shipped&#39;</span>
</span><span id=__span-19-5><a id=__codelineno-19-5 name=__codelineno-19-5 href=#__codelineno-19-5></a><span class=w>     </span><span class=k>END</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>ShippingStatus</span>
</span><span id=__span-19-6><a id=__codelineno-19-6 name=__codelineno-19-6 href=#__codelineno-19-6></a><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>SalesOrderHeader</span><span class=p>;</span>
</span></code></pre></div> <p><a href=https://learn.microsoft.com/zh-cn/shows/programming-databases-with-t-sql-for-beginners/rdbms-and-setup-1-of-7-programming-databases-with-t-sql-for-beginners/ >RDBMS 和安装程序（第 1 部分（共 7 部分） |使用 T-SQL 为初学者编程数据库</a></p> <p><a href=https://learn.microsoft.com/zh-cn/shows/programming-databases-with-t-sql-for-beginners/introduction-to-transact-sql-2-of-7-programming-databases-with-t-sql-for-beginners/ >Transact-SQL 简介（第 2 部分（共 7 部分） |使用 T-SQL 为初学者编程数据库</a></p> <hr> <h2 id=_8>对结果进行排序</h2> <p>在查询处理的逻辑顺序中，ORDER BY 是要执行的 SELECT 语句的最后一个阶段。 ORDER BY 可用于控制从 SQL Server 返回到客户端应用程序的行的排序。 SQL Server 无法保证表中的行的物理顺序，要控制行返回到客户端的顺序，只能使用 ORDER BY 子句。 此行为与关系理论一致。</p> <h3 id=order-by>使用 ORDER BY 子句</h3> <p>要命令 SQL Server 以特定顺序返回查询结果，请以以下格式添加 ORDER BY 子句：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-20-1><a id=__codelineno-20-1 name=__codelineno-20-1 href=#__codelineno-20-1></a><span class=k>SELECT</span><span class=o>&lt;</span><span class=n>select_list</span><span class=o>&gt;</span>
</span><span id=__span-20-2><a id=__codelineno-20-2 name=__codelineno-20-2 href=#__codelineno-20-2></a><span class=k>FROM</span><span class=w> </span><span class=o>&lt;</span><span class=n>table_source</span><span class=o>&gt;</span>
</span><span id=__span-20-3><a id=__codelineno-20-3 name=__codelineno-20-3 href=#__codelineno-20-3></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>&lt;</span><span class=n>order_by_list</span><span class=o>&gt;</span><span class=w> </span><span class=p>[</span><span class=k>ASC</span><span class=o>|</span><span class=k>DESC</span><span class=p>];</span>
</span></code></pre></div> <p>ORDER BY 可以使用其列表中的多种类型的元素：</p> <ul> <li>按名称排序的列。 可以指定结果排序所依据的列的名称。 结果按第一列的顺序返回，然后依次按其他每个列进行次排序。</li> <li>列的别名。 由于是先处理 SELECT 子句再处理 ORDER BY，因此 ORDER BY 可以访问 SELECT 列表中定义的别名。</li> <li>按 SELECT 列表中的<u>序号位置</u>排序的列。 不建议在应用程序中使用该位置，因为可读性会降低，并且需要额外注意让 ORDER BY 列表保持最新。 但是，对于 SELECT 列表中的复杂表达式，在故障排除过程中使用位置编号可能很有用。</li> <li><strong>列未包含在 SELECT 列表中，但可从 FROM 子句中列出的表中获得</strong>。 如果查询使用 DISTINCT 选项，则 ORDER BY 列表中的任何列都必须包含在 SELECT 列表中。</li> </ul> <h3 id=_9>排序方向</h3> <p>除了指定用于确定排序顺序的列之外，还可以控制排序的方向。 可以使用 ASC 进行升序（A-Z、0-9）或使用 DESC 进行降序（Z-A，9-0）。 默认为升序排序。 每列都可以指定自己的方向，如以下示例所示：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-21-1><a id=__codelineno-21-1 name=__codelineno-21-1 href=#__codelineno-21-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Category</span><span class=p>,</span><span class=w> </span><span class=n>ProductName</span>
</span><span id=__span-21-2><a id=__codelineno-21-2 name=__codelineno-21-2 href=#__codelineno-21-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-21-3><a id=__codelineno-21-3 name=__codelineno-21-3 href=#__codelineno-21-3></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>Category</span><span class=w> </span><span class=k>ASC</span><span class=p>,</span><span class=w> </span><span class=n>Price</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>
</span></code></pre></div> <p>多列排序的情况下例如<code>ORDER BY Category ASC, Price DESC;</code>中<code>Price</code>的排序只在<code>Category</code>相同的情况下才会生效。在这种情况下相同的情况下才会生效。在这种情况下，<code>Category</code> 排序可能对结果的排序影响较小，甚至可以说是次要的。如果希望 <code>Category</code> 排序更加突出，可以考虑修改排序的优先级（比如交换排序的列顺序）。</p> <h2 id=_10>限制排序结果</h2> <p>TOP 子句是 SELECT 子句的 Microsoft 专属扩展。 TOP 可用于指定要返回的行数，可以是正整数，也可以是所有符合条件的行的百分比。 行数可以指定为常量或表达式。 TOP 经常与 ORDER BY 一起使用，但也可以与无序数据一起使用。</p> <h3 id=top>使用 TOP 子句</h3> <p>与 ORDER BY 一起使用的 TOP 子句的简化语法如下所示：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-22-1><a id=__codelineno-22-1 name=__codelineno-22-1 href=#__codelineno-22-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>TOP</span><span class=w> </span><span class=p>(</span><span class=n>N</span><span class=p>)</span><span class=w> </span><span class=o>&lt;</span><span class=n>column_list</span><span class=o>&gt;</span>
</span><span id=__span-22-2><a id=__codelineno-22-2 name=__codelineno-22-2 href=#__codelineno-22-2></a><span class=k>FROM</span><span class=w> </span><span class=o>&lt;</span><span class=n>table_source</span><span class=o>&gt;</span>
</span><span id=__span-22-3><a id=__codelineno-22-3 name=__codelineno-22-3 href=#__codelineno-22-3></a><span class=k>WHERE</span><span class=w> </span><span class=o>&lt;</span><span class=n>search_condition</span><span class=o>&gt;</span>
</span><span id=__span-22-4><a id=__codelineno-22-4 name=__codelineno-22-4 href=#__codelineno-22-4></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=o>&lt;</span><span class=k>order</span><span class=w> </span><span class=n>list</span><span class=o>&gt;</span><span class=w> </span><span class=p>[</span><span class=k>ASC</span><span class=o>|</span><span class=k>DESC</span><span class=p>];</span>
</span></code></pre></div> <p>例如，要仅从“Production.Product”表中检索 10 个价格最高的产品，请使用以下查询：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-23-1><a id=__codelineno-23-1 name=__codelineno-23-1 href=#__codelineno-23-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>TOP</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>ListPrice</span>
</span><span id=__span-23-2><a id=__codelineno-23-2 name=__codelineno-23-2 href=#__codelineno-23-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-23-3><a id=__codelineno-23-3 name=__codelineno-23-3 href=#__codelineno-23-3></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>ListPrice</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>
</span><span id=__span-23-4><a id=__codelineno-23-4 name=__codelineno-23-4 href=#__codelineno-23-4></a>
</span><span id=__span-23-5><a id=__codelineno-23-5 name=__codelineno-23-5 href=#__codelineno-23-5></a><span class=cm>/*</span>
</span><span id=__span-23-6><a id=__codelineno-23-6 name=__codelineno-23-6 href=#__codelineno-23-6></a><span class=cm>结果应如下所示：</span>
</span><span id=__span-23-7><a id=__codelineno-23-7 name=__codelineno-23-7 href=#__codelineno-23-7></a><span class=cm>名称                      ListPrice</span>
</span><span id=__span-23-8><a id=__codelineno-23-8 name=__codelineno-23-8 href=#__codelineno-23-8></a>
</span><span id=__span-23-9><a id=__codelineno-23-9 name=__codelineno-23-9 href=#__codelineno-23-9></a><span class=cm>Road-150 Red, 62          3578.27</span>
</span><span id=__span-23-10><a id=__codelineno-23-10 name=__codelineno-23-10 href=#__codelineno-23-10></a>
</span><span id=__span-23-11><a id=__codelineno-23-11 name=__codelineno-23-11 href=#__codelineno-23-11></a><span class=cm>Road-150 Red, 44          3578.27</span>
</span><span id=__span-23-12><a id=__codelineno-23-12 name=__codelineno-23-12 href=#__codelineno-23-12></a>
</span><span id=__span-23-13><a id=__codelineno-23-13 name=__codelineno-23-13 href=#__codelineno-23-13></a><span class=cm>Road-150 Red, 48          3578.27</span>
</span><span id=__span-23-14><a id=__codelineno-23-14 name=__codelineno-23-14 href=#__codelineno-23-14></a>
</span><span id=__span-23-15><a id=__codelineno-23-15 name=__codelineno-23-15 href=#__codelineno-23-15></a><span class=cm>Road-150 Red, 52          3578.27</span>
</span><span id=__span-23-16><a id=__codelineno-23-16 name=__codelineno-23-16 href=#__codelineno-23-16></a>
</span><span id=__span-23-17><a id=__codelineno-23-17 name=__codelineno-23-17 href=#__codelineno-23-17></a><span class=cm>Road-150 Red, 56          3578.27</span>
</span><span id=__span-23-18><a id=__codelineno-23-18 name=__codelineno-23-18 href=#__codelineno-23-18></a>
</span><span id=__span-23-19><a id=__codelineno-23-19 name=__codelineno-23-19 href=#__codelineno-23-19></a><span class=cm>Mountain-100 Silver, 38   3399.99</span>
</span><span id=__span-23-20><a id=__codelineno-23-20 name=__codelineno-23-20 href=#__codelineno-23-20></a>
</span><span id=__span-23-21><a id=__codelineno-23-21 name=__codelineno-23-21 href=#__codelineno-23-21></a><span class=cm>Mountain-100 Silver, 42   3399.99</span>
</span><span id=__span-23-22><a id=__codelineno-23-22 name=__codelineno-23-22 href=#__codelineno-23-22></a>
</span><span id=__span-23-23><a id=__codelineno-23-23 name=__codelineno-23-23 href=#__codelineno-23-23></a><span class=cm>Mountain-100 Silver, 44   3399.99</span>
</span><span id=__span-23-24><a id=__codelineno-23-24 name=__codelineno-23-24 href=#__codelineno-23-24></a>
</span><span id=__span-23-25><a id=__codelineno-23-25 name=__codelineno-23-25 href=#__codelineno-23-25></a><span class=cm>Mountain-100 Silver, 48   3399.99</span>
</span><span id=__span-23-26><a id=__codelineno-23-26 name=__codelineno-23-26 href=#__codelineno-23-26></a>
</span><span id=__span-23-27><a id=__codelineno-23-27 name=__codelineno-23-27 href=#__codelineno-23-27></a><span class=cm>Mountain-100 Black, 38    3374.99</span>
</span><span id=__span-23-28><a id=__codelineno-23-28 name=__codelineno-23-28 href=#__codelineno-23-28></a><span class=cm>*/</span>
</span></code></pre></div> <p>TOP 运算符依赖 ORDER BY 子句来提供所选行的有意义优先级。 使用 TOP 时可以不带 ORDER BY，但在这种情况下，无法预测将返回的行。 此示例中，如果没有 ORDER BY 子句，<u>可能会返回任意 10 个订单</u>。</p> <h3 id=with-ties>使用 WITH TIES</h3> <p>除了指定要返回的固定行数外，TOP 关键字还接受 WITH TIES 选项，该选项将检索可能在所选前 N 行找到其值的任何行。</p> <p>在上一个示例中，查询按价格降序返回前 10 个产品。 但是，通过将 WITH TIES 选项添加到 TOP 子句，将看到更多行有资格包含价格最高产品前 10 名中：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-24-1><a id=__codelineno-24-1 name=__codelineno-24-1 href=#__codelineno-24-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>TOP</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=k>WITH</span><span class=w> </span><span class=n>TIES</span><span class=w> </span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>ListPrice</span>
</span><span id=__span-24-2><a id=__codelineno-24-2 name=__codelineno-24-2 href=#__codelineno-24-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-24-3><a id=__codelineno-24-3 name=__codelineno-24-3 href=#__codelineno-24-3></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>ListPrice</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>
</span><span id=__span-24-4><a id=__codelineno-24-4 name=__codelineno-24-4 href=#__codelineno-24-4></a>
</span><span id=__span-24-5><a id=__codelineno-24-5 name=__codelineno-24-5 href=#__codelineno-24-5></a><span class=cm>/*</span>
</span><span id=__span-24-6><a id=__codelineno-24-6 name=__codelineno-24-6 href=#__codelineno-24-6></a><span class=cm>修改后的查询将返回以下结果：</span>
</span><span id=__span-24-7><a id=__codelineno-24-7 name=__codelineno-24-7 href=#__codelineno-24-7></a>
</span><span id=__span-24-8><a id=__codelineno-24-8 name=__codelineno-24-8 href=#__codelineno-24-8></a><span class=cm>名称                    ListPrice</span>
</span><span id=__span-24-9><a id=__codelineno-24-9 name=__codelineno-24-9 href=#__codelineno-24-9></a>
</span><span id=__span-24-10><a id=__codelineno-24-10 name=__codelineno-24-10 href=#__codelineno-24-10></a><span class=cm>Road-150 Red, 62        3578.27</span>
</span><span id=__span-24-11><a id=__codelineno-24-11 name=__codelineno-24-11 href=#__codelineno-24-11></a>
</span><span id=__span-24-12><a id=__codelineno-24-12 name=__codelineno-24-12 href=#__codelineno-24-12></a><span class=cm>Road-150 Red, 44        3578.27</span>
</span><span id=__span-24-13><a id=__codelineno-24-13 name=__codelineno-24-13 href=#__codelineno-24-13></a>
</span><span id=__span-24-14><a id=__codelineno-24-14 name=__codelineno-24-14 href=#__codelineno-24-14></a><span class=cm>Road-150 Red, 48        3578.27</span>
</span><span id=__span-24-15><a id=__codelineno-24-15 name=__codelineno-24-15 href=#__codelineno-24-15></a>
</span><span id=__span-24-16><a id=__codelineno-24-16 name=__codelineno-24-16 href=#__codelineno-24-16></a><span class=cm>Road-150 Red, 52        3578.27</span>
</span><span id=__span-24-17><a id=__codelineno-24-17 name=__codelineno-24-17 href=#__codelineno-24-17></a>
</span><span id=__span-24-18><a id=__codelineno-24-18 name=__codelineno-24-18 href=#__codelineno-24-18></a><span class=cm>Road-150 Red, 56        3578.27</span>
</span><span id=__span-24-19><a id=__codelineno-24-19 name=__codelineno-24-19 href=#__codelineno-24-19></a>
</span><span id=__span-24-20><a id=__codelineno-24-20 name=__codelineno-24-20 href=#__codelineno-24-20></a><span class=cm>Mountain-100 Silver, 38 3399.99</span>
</span><span id=__span-24-21><a id=__codelineno-24-21 name=__codelineno-24-21 href=#__codelineno-24-21></a>
</span><span id=__span-24-22><a id=__codelineno-24-22 name=__codelineno-24-22 href=#__codelineno-24-22></a><span class=cm>Mountain-100 Silver, 42 3399.99</span>
</span><span id=__span-24-23><a id=__codelineno-24-23 name=__codelineno-24-23 href=#__codelineno-24-23></a>
</span><span id=__span-24-24><a id=__codelineno-24-24 name=__codelineno-24-24 href=#__codelineno-24-24></a><span class=cm>Mountain-100 Silver, 44 3399.99</span>
</span><span id=__span-24-25><a id=__codelineno-24-25 name=__codelineno-24-25 href=#__codelineno-24-25></a>
</span><span id=__span-24-26><a id=__codelineno-24-26 name=__codelineno-24-26 href=#__codelineno-24-26></a><span class=cm>Mountain-100 Silver, 48 3399.99</span>
</span><span id=__span-24-27><a id=__codelineno-24-27 name=__codelineno-24-27 href=#__codelineno-24-27></a>
</span><span id=__span-24-28><a id=__codelineno-24-28 name=__codelineno-24-28 href=#__codelineno-24-28></a><span class=cm>Mountain-100 Black, 38  3374.99</span>
</span><span id=__span-24-29><a id=__codelineno-24-29 name=__codelineno-24-29 href=#__codelineno-24-29></a>
</span><span id=__span-24-30><a id=__codelineno-24-30 name=__codelineno-24-30 href=#__codelineno-24-30></a><span class=cm>Mountain-100 Black, 42  3374.99</span>
</span><span id=__span-24-31><a id=__codelineno-24-31 name=__codelineno-24-31 href=#__codelineno-24-31></a>
</span><span id=__span-24-32><a id=__codelineno-24-32 name=__codelineno-24-32 href=#__codelineno-24-32></a><span class=cm>Mountain-100 Black, 44  3374.99</span>
</span><span id=__span-24-33><a id=__codelineno-24-33 name=__codelineno-24-33 href=#__codelineno-24-33></a>
</span><span id=__span-24-34><a id=__codelineno-24-34 name=__codelineno-24-34 href=#__codelineno-24-34></a><span class=cm>Mountain-100 Black, 48  3374.99</span>
</span></code></pre></div> <p>如果查询中使用了 <code>WITH TIES</code>，那么不仅会返回这些前 10 名的产品（从 <code>Product A</code> 到 <code>Product J</code>），还会包括其他所有价格为 <code>3578.27</code> 的产品（即 <code>Product K</code>, <code>Product L</code>, 等等），即使它们的排名超出了前 10 名。</p> <p>决定是否包含 WITH TIES 取决于对源数据的了解、其唯一值的可能性以及正在编写的查询的要求。</p> <h3 id=percent>使用 PERCENT</h3> <p>要返回符合条件的行的百分比，请将 PERCENT 选项与 TOP 一起使用，而不是用固定数字。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-25-1><a id=__codelineno-25-1 name=__codelineno-25-1 href=#__codelineno-25-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>TOP</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=n>PERCENT</span><span class=w> </span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>ListPrice</span>
</span><span id=__span-25-2><a id=__codelineno-25-2 name=__codelineno-25-2 href=#__codelineno-25-2></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-25-3><a id=__codelineno-25-3 name=__codelineno-25-3 href=#__codelineno-25-3></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>ListPrice</span><span class=w> </span><span class=k>DESC</span><span class=p>;</span>
</span></code></pre></div> <p>PERCENT 还可以与 WITH TIES 选项一起使用。</p> <p><strong>出于统计行数的目的，TOP (N) PERCENT 将向上取整到最接近的整数。</strong></p> <p>许多 SQL Server 专业人员使用 TOP 选项作为一种方法，以仅检索某特个特定范围的行。 但在使用 TOP 时，请考虑以下事实：</p> <ul> <li>TOP 是 T-SQL 专有的。</li> <li>TOP 本身不支持跳过行。</li> <li>由于 TOP 依赖于 ORDER BY 子句，因此无法：使用一种排序顺序来确定按 TOP 筛选的行，同时使用另一种排序顺序来确定输出顺序。</li> </ul> <h2 id=_11>页结果</h2> <h3 id=offset-fetch>OFFSET-FETCH 语法</h3> <p>OFFSET-FETCH 子句的语法在技术方面是 ORDER BY 子句的一部分，如下所示：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-26-1><a id=__codelineno-26-1 name=__codelineno-26-1 href=#__codelineno-26-1></a><span class=k>OFFSET</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=n>integer_constant</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>offset_row_count_expression</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=k>ROW</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ROWS</span><span class=w> </span><span class=err>}</span>
</span><span id=__span-26-2><a id=__codelineno-26-2 name=__codelineno-26-2 href=#__codelineno-26-2></a><span class=p>[</span><span class=k>FETCH</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=k>FIRST</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>NEXT</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=err>{</span><span class=n>integer_constant</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>fetch_row_count_expression</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=err>{</span><span class=w> </span><span class=k>ROW</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=k>ROWS</span><span class=w> </span><span class=err>}</span><span class=w> </span><span class=k>ONLY</span><span class=p>]</span>
</span></code></pre></div> <h3 id=offset-fetch_1>使用 OFFSET-FETCH</h3> <p>要使用 OFFSET-FETCH，需要提供起始 OFFSET 值（可能为零）和可选的要返回的行数，如以下示例所示：</p> <p>此示例将返回前 10 行，然后根据“ListPrice”返回接下来的 10 行产品数据：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-27-1><a id=__codelineno-27-1 name=__codelineno-27-1 href=#__codelineno-27-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductID</span><span class=p>,</span><span class=w> </span><span class=n>ProductName</span><span class=p>,</span><span class=w> </span><span class=n>ListPrice</span>
</span><span id=__span-27-2><a id=__codelineno-27-2 name=__codelineno-27-2 href=#__codelineno-27-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-27-3><a id=__codelineno-27-3 name=__codelineno-27-3 href=#__codelineno-27-3></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>ListPrice</span><span class=w> </span><span class=k>DESC</span><span class=w> </span>
</span><span id=__span-27-4><a id=__codelineno-27-4 name=__codelineno-27-4 href=#__codelineno-27-4></a><span class=k>OFFSET</span><span class=w> </span><span class=mi>0</span><span class=w> </span><span class=k>ROWS</span><span class=w> </span><span class=c1>--Skip zero rows</span>
</span><span id=__span-27-5><a id=__codelineno-27-5 name=__codelineno-27-5 href=#__codelineno-27-5></a><span class=k>FETCH</span><span class=w> </span><span class=k>NEXT</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=k>ROWS</span><span class=w> </span><span class=k>ONLY</span><span class=p>;</span><span class=w> </span><span class=c1>--Get the next 10</span>
</span></code></pre></div> <p>要检索下一页产品数据，请使用 OFFSET 子句指定要跳过的行数：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-28-1><a id=__codelineno-28-1 name=__codelineno-28-1 href=#__codelineno-28-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductID</span><span class=p>,</span><span class=w> </span><span class=n>ProductName</span><span class=p>,</span><span class=w> </span><span class=n>ListPrice</span>
</span><span id=__span-28-2><a id=__codelineno-28-2 name=__codelineno-28-2 href=#__codelineno-28-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-28-3><a id=__codelineno-28-3 name=__codelineno-28-3 href=#__codelineno-28-3></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>ListPrice</span><span class=w> </span><span class=k>DESC</span><span class=w> </span>
</span><span id=__span-28-4><a id=__codelineno-28-4 name=__codelineno-28-4 href=#__codelineno-28-4></a><span class=k>OFFSET</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=k>ROWS</span><span class=w> </span><span class=c1>--Skip 10 rows</span>
</span><span id=__span-28-5><a id=__codelineno-28-5 name=__codelineno-28-5 href=#__codelineno-28-5></a><span class=k>FETCH</span><span class=w> </span><span class=k>NEXT</span><span class=w> </span><span class=mi>10</span><span class=w> </span><span class=k>ROWS</span><span class=w> </span><span class=k>ONLY</span><span class=p>;</span><span class=w> </span><span class=c1>--Get the next 10</span>
</span></code></pre></div> <p>在语法定义中，可以看到需要 OFFSET 子句，但不需要 FETCH 子句。 如果省略 FETCH 子句，则将返回 OFFSET 之后的所有行。 用户还会发现，关键字 ROW 和 ROWS 可以互换，就像 FIRST 和 NEXT 一样，这可实现更自然语法。</p> <p>要确保结果的准确性，尤其是切换不同的数据页时，<u>务必要构造一个 ORDER BY 子句，该子句将提供唯一排序并产生确定的结果</u>。 由于 SQL Server 的查询优化器的工作方式，在多页上显示行在技术上可以实现，除非行范围是确定性的。</p> <h2 id=_12>删除重复项</h2> <p>尽管表中的行应始终唯一，但如果仅选择列的某个子集，结果行也可能不唯一，即使原始行是唯一的。 例如，可能有一个供应商表，其中要求城市和省州（或自治区/直辖市）是唯一的，以便任何城市中都不会有多个供应商。 但是，如果只想查看供应商所在的城市和国家/地区，则返回的结果可能不是唯一的。 假设编写下面的查询：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-29-1><a id=__codelineno-29-1 name=__codelineno-29-1 href=#__codelineno-29-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>City</span><span class=p>,</span><span class=w> </span><span class=n>CountryRegion</span>
</span><span id=__span-29-2><a id=__codelineno-29-2 name=__codelineno-29-2 href=#__codelineno-29-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Supplier</span>
</span><span id=__span-29-3><a id=__codelineno-29-3 name=__codelineno-29-3 href=#__codelineno-29-3></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>CountryRegion</span><span class=p>,</span><span class=w> </span><span class=n>City</span><span class=p>;</span>
</span><span id=__span-29-4><a id=__codelineno-29-4 name=__codelineno-29-4 href=#__codelineno-29-4></a>
</span><span id=__span-29-5><a id=__codelineno-29-5 name=__codelineno-29-5 href=#__codelineno-29-5></a><span class=cm>/*</span>
</span><span id=__span-29-6><a id=__codelineno-29-6 name=__codelineno-29-6 href=#__codelineno-29-6></a><span class=cm>该查询可能返回如下所示的结果：</span>
</span><span id=__span-29-7><a id=__codelineno-29-7 name=__codelineno-29-7 href=#__codelineno-29-7></a>
</span><span id=__span-29-8><a id=__codelineno-29-8 name=__codelineno-29-8 href=#__codelineno-29-8></a><span class=cm>城市                  CountryRegion</span>
</span><span id=__span-29-9><a id=__codelineno-29-9 name=__codelineno-29-9 href=#__codelineno-29-9></a>
</span><span id=__span-29-10><a id=__codelineno-29-10 name=__codelineno-29-10 href=#__codelineno-29-10></a><span class=cm>Aurora                加拿大</span>
</span><span id=__span-29-11><a id=__codelineno-29-11 name=__codelineno-29-11 href=#__codelineno-29-11></a>
</span><span id=__span-29-12><a id=__codelineno-29-12 name=__codelineno-29-12 href=#__codelineno-29-12></a><span class=cm>Barrie                加拿大</span>
</span><span id=__span-29-13><a id=__codelineno-29-13 name=__codelineno-29-13 href=#__codelineno-29-13></a>
</span><span id=__span-29-14><a id=__codelineno-29-14 name=__codelineno-29-14 href=#__codelineno-29-14></a><span class=cm>Brampton              加拿大</span>
</span><span id=__span-29-15><a id=__codelineno-29-15 name=__codelineno-29-15 href=#__codelineno-29-15></a>
</span><span id=__span-29-16><a id=__codelineno-29-16 name=__codelineno-29-16 href=#__codelineno-29-16></a><span class=cm>Brossard              加拿大</span>
</span><span id=__span-29-17><a id=__codelineno-29-17 name=__codelineno-29-17 href=#__codelineno-29-17></a>
</span><span id=__span-29-18><a id=__codelineno-29-18 name=__codelineno-29-18 href=#__codelineno-29-18></a><span class=cm>Brossard              加拿大</span>
</span><span id=__span-29-19><a id=__codelineno-29-19 name=__codelineno-29-19 href=#__codelineno-29-19></a>
</span><span id=__span-29-20><a id=__codelineno-29-20 name=__codelineno-29-20 href=#__codelineno-29-20></a><span class=cm>Burnaby               加拿大</span>
</span><span id=__span-29-21><a id=__codelineno-29-21 name=__codelineno-29-21 href=#__codelineno-29-21></a>
</span><span id=__span-29-22><a id=__codelineno-29-22 name=__codelineno-29-22 href=#__codelineno-29-22></a><span class=cm>Burnaby               加拿大</span>
</span><span id=__span-29-23><a id=__codelineno-29-23 name=__codelineno-29-23 href=#__codelineno-29-23></a>
</span><span id=__span-29-24><a id=__codelineno-29-24 name=__codelineno-29-24 href=#__codelineno-29-24></a><span class=cm>Burnaby               加拿大</span>
</span><span id=__span-29-25><a id=__codelineno-29-25 name=__codelineno-29-25 href=#__codelineno-29-25></a>
</span><span id=__span-29-26><a id=__codelineno-29-26 name=__codelineno-29-26 href=#__codelineno-29-26></a><span class=cm>Calgary               加拿大</span>
</span><span id=__span-29-27><a id=__codelineno-29-27 name=__codelineno-29-27 href=#__codelineno-29-27></a>
</span><span id=__span-29-28><a id=__codelineno-29-28 name=__codelineno-29-28 href=#__codelineno-29-28></a><span class=cm>Calgary               加拿大</span>
</span><span id=__span-29-29><a id=__codelineno-29-29 name=__codelineno-29-29 href=#__codelineno-29-29></a>
</span><span id=__span-29-30><a id=__codelineno-29-30 name=__codelineno-29-30 href=#__codelineno-29-30></a><span class=cm>...                   ...</span>
</span><span id=__span-29-31><a id=__codelineno-29-31 name=__codelineno-29-31 href=#__codelineno-29-31></a><span class=cm>*/</span>
</span></code></pre></div> <p>默认情况下，SELECT 子句包括一个导致此行为的隐式 ALL 关键字：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-30-1><a id=__codelineno-30-1 name=__codelineno-30-1 href=#__codelineno-30-1></a><span class=k>SELECT</span><span class=w> </span><span class=k>ALL</span><span class=w> </span><span class=n>City</span><span class=p>,</span><span class=w> </span><span class=n>CountryRegion</span>
</span><span id=__span-30-2><a id=__codelineno-30-2 name=__codelineno-30-2 href=#__codelineno-30-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Supplier</span>
</span><span id=__span-30-3><a id=__codelineno-30-3 name=__codelineno-30-3 href=#__codelineno-30-3></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>CountryRegion</span><span class=p>,</span><span class=w> </span><span class=n>City</span><span class=p>;</span>
</span></code></pre></div> <p>T-SQL 还支持备用的 DISTINCT 关键字，该关键字删除所有重复的结果行：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-31-1><a id=__codelineno-31-1 name=__codelineno-31-1 href=#__codelineno-31-1></a><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>City</span><span class=p>,</span><span class=w> </span><span class=n>CountryRegion</span>
</span><span id=__span-31-2><a id=__codelineno-31-2 name=__codelineno-31-2 href=#__codelineno-31-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Supplier</span>
</span><span id=__span-31-3><a id=__codelineno-31-3 name=__codelineno-31-3 href=#__codelineno-31-3></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>CountryRegion</span><span class=p>,</span><span class=w> </span><span class=n>City</span><span class=p>;</span>
</span><span id=__span-31-4><a id=__codelineno-31-4 name=__codelineno-31-4 href=#__codelineno-31-4></a><span class=cm>/*</span>
</span><span id=__span-31-5><a id=__codelineno-31-5 name=__codelineno-31-5 href=#__codelineno-31-5></a><span class=cm>使用 DISTINCT 时，示例仅返回 SELECT 列表中值的其中一个唯一组合：</span>
</span><span id=__span-31-6><a id=__codelineno-31-6 name=__codelineno-31-6 href=#__codelineno-31-6></a>
</span><span id=__span-31-7><a id=__codelineno-31-7 name=__codelineno-31-7 href=#__codelineno-31-7></a><span class=cm>城市             CountryRegion</span>
</span><span id=__span-31-8><a id=__codelineno-31-8 name=__codelineno-31-8 href=#__codelineno-31-8></a>
</span><span id=__span-31-9><a id=__codelineno-31-9 name=__codelineno-31-9 href=#__codelineno-31-9></a><span class=cm>Aurora           加拿大</span>
</span><span id=__span-31-10><a id=__codelineno-31-10 name=__codelineno-31-10 href=#__codelineno-31-10></a>
</span><span id=__span-31-11><a id=__codelineno-31-11 name=__codelineno-31-11 href=#__codelineno-31-11></a><span class=cm>Barrie           加拿大</span>
</span><span id=__span-31-12><a id=__codelineno-31-12 name=__codelineno-31-12 href=#__codelineno-31-12></a>
</span><span id=__span-31-13><a id=__codelineno-31-13 name=__codelineno-31-13 href=#__codelineno-31-13></a><span class=cm>Brampton         加拿大</span>
</span><span id=__span-31-14><a id=__codelineno-31-14 name=__codelineno-31-14 href=#__codelineno-31-14></a>
</span><span id=__span-31-15><a id=__codelineno-31-15 name=__codelineno-31-15 href=#__codelineno-31-15></a><span class=cm>Brossard         加拿大</span>
</span><span id=__span-31-16><a id=__codelineno-31-16 name=__codelineno-31-16 href=#__codelineno-31-16></a>
</span><span id=__span-31-17><a id=__codelineno-31-17 name=__codelineno-31-17 href=#__codelineno-31-17></a><span class=cm>Burnaby          加拿大</span>
</span><span id=__span-31-18><a id=__codelineno-31-18 name=__codelineno-31-18 href=#__codelineno-31-18></a>
</span><span id=__span-31-19><a id=__codelineno-31-19 name=__codelineno-31-19 href=#__codelineno-31-19></a><span class=cm>Calgary          加拿大</span>
</span><span id=__span-31-20><a id=__codelineno-31-20 name=__codelineno-31-20 href=#__codelineno-31-20></a>
</span><span id=__span-31-21><a id=__codelineno-31-21 name=__codelineno-31-21 href=#__codelineno-31-21></a><span class=cm>...              ...</span>
</span><span id=__span-31-22><a id=__codelineno-31-22 name=__codelineno-31-22 href=#__codelineno-31-22></a><span class=cm>*/</span>
</span></code></pre></div> <h2 id=_13>用谓词筛选数据</h2> <p>仅包含 SELECT 和 FROM 子句的最简单 SELECT 语句将计算表中的每一行。 通过使用 WHERE 子句，可以定义确定将处理哪些行并可能减少结果集的条件。</p> <h3 id=where>WHERE 子句的结构</h3> <p>WHERE 子句由一个或多个搜索条件组成，每个搜索条件对表中的每一行必须求值为 TRUE、FALSE 或“未知”。 仅当 WHERE 子句的计算结果为 TRUE 时，才会返回行。 <u>各个条件充当数据的筛选器，称为“谓词”</u>。 每个谓词包括一个正在测试的条件，通常使用基本比较运算符：</p> <ul> <li>=（等于）</li> <li>&lt;&gt;（不等于）</li> <li>&gt;（大于）</li> <li>&gt;=（大于或等于）</li> <li>&lt;（小于）</li> <li>&lt;=（小于或等于）</li> </ul> <p>例如，以下查询返回 ProductCategoryID 值为 2 的所有产品：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-32-1><a id=__codelineno-32-1 name=__codelineno-32-1 href=#__codelineno-32-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Category</span><span class=p>,</span><span class=w> </span><span class=n>ProductName</span>
</span><span id=__span-32-2><a id=__codelineno-32-2 name=__codelineno-32-2 href=#__codelineno-32-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-32-3><a id=__codelineno-32-3 name=__codelineno-32-3 href=#__codelineno-32-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
</span></code></pre></div> <p>同样，以下查询返回 ListPrice 小于 10.00 的所有产品：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-33-1><a id=__codelineno-33-1 name=__codelineno-33-1 href=#__codelineno-33-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Category</span><span class=p>,</span><span class=w> </span><span class=n>ProductName</span>
</span><span id=__span-33-2><a id=__codelineno-33-2 name=__codelineno-33-2 href=#__codelineno-33-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-33-3><a id=__codelineno-33-3 name=__codelineno-33-3 href=#__codelineno-33-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>ListPrice</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>.</span><span class=mi>00</span><span class=p>;</span>
</span></code></pre></div> <h3 id=is-null-is-not-null>IS NULL / IS NOT NULL</h3> <p>还可以使用“IS NULL”或“IS NOT NULL”轻松筛选以允许或排除“未知”或 NULL 值。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-34-1><a id=__codelineno-34-1 name=__codelineno-34-1 href=#__codelineno-34-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Category</span><span class=p>,</span><span class=w> </span><span class=n>ProductName</span>
</span><span id=__span-34-2><a id=__codelineno-34-2 name=__codelineno-34-2 href=#__codelineno-34-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-34-3><a id=__codelineno-34-3 name=__codelineno-34-3 href=#__codelineno-34-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>ProductName</span><span class=w> </span><span class=k>IS</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>NULL</span><span class=p>;</span>
</span></code></pre></div> <h2 id=_14>多个条件</h2> <p>多个谓词可以与 AND 和 OR 运算符以及括号结合使用。 但是 SQL Server 一次只处理两个条件。 使用 AND 运算符连接多个条件时，所有条件都必须为 TRUE。 使用 OR 运算符连接两个条件时，对于结果集，其中的一个或两个条件可以为 TRUE。</p> <p>例如，下面的查询返回类别 2 中成本低于 10.00 的产品：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-35-1><a id=__codelineno-35-1 name=__codelineno-35-1 href=#__codelineno-35-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Category</span><span class=p>,</span><span class=w> </span><span class=n>ProductName</span>
</span><span id=__span-35-2><a id=__codelineno-35-2 name=__codelineno-35-2 href=#__codelineno-35-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-35-3><a id=__codelineno-35-3 name=__codelineno-35-3 href=#__codelineno-35-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span>
</span><span id=__span-35-4><a id=__codelineno-35-4 name=__codelineno-35-4 href=#__codelineno-35-4></a><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>ListPrice</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>.</span><span class=mi>00</span><span class=p>;</span>
</span></code></pre></div> <p>除非使用括号，否则先处理 OR 运算符，然后再处理 AND 运算符。 最佳做法是，在使用两个以上的谓词时使用括号。 以下查询将返回类别 2 或 3 中成本低于 10.00 的产品：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-36-1><a id=__codelineno-36-1 name=__codelineno-36-1 href=#__codelineno-36-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Category</span><span class=p>,</span><span class=w> </span><span class=n>ProductName</span>
</span><span id=__span-36-2><a id=__codelineno-36-2 name=__codelineno-36-2 href=#__codelineno-36-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-36-3><a id=__codelineno-36-3 name=__codelineno-36-3 href=#__codelineno-36-3></a><span class=k>WHERE</span><span class=w> </span><span class=p>(</span><span class=n>ProductCategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=p>)</span>
</span><span id=__span-36-4><a id=__codelineno-36-4 name=__codelineno-36-4 href=#__codelineno-36-4></a><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=n>ListPrice</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>10</span><span class=p>.</span><span class=mi>00</span><span class=p>);</span>
</span></code></pre></div> <h2 id=_15>比较运算符</h2> <p>Transact-SQL 包括可帮助简化 WHERE 子句的比较运算符。</p> <h3 id=in>IN</h3> <p>对于使用 OR 连接的同一个列，IN 运算符是多个等式条件的快捷方法。 在查询中使用多个 OR 条件没有任何问题，如以下示例所示：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-37-1><a id=__codelineno-37-1 name=__codelineno-37-1 href=#__codelineno-37-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Category</span><span class=p>,</span><span class=w> </span><span class=n>ProductName</span>
</span><span id=__span-37-2><a id=__codelineno-37-2 name=__codelineno-37-2 href=#__codelineno-37-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-37-3><a id=__codelineno-37-3 name=__codelineno-37-3 href=#__codelineno-37-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span>
</span><span id=__span-37-4><a id=__codelineno-37-4 name=__codelineno-37-4 href=#__codelineno-37-4></a><span class=w>    </span><span class=k>OR</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span>
</span><span id=__span-37-5><a id=__codelineno-37-5 name=__codelineno-37-5 href=#__codelineno-37-5></a><span class=w>    </span><span class=k>OR</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>4</span><span class=p>;</span>
</span></code></pre></div> <p>但是，使用 IN 清晰简洁，而且查询的性能不会受到影响。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-38-1><a id=__codelineno-38-1 name=__codelineno-38-1 href=#__codelineno-38-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Category</span><span class=p>,</span><span class=w> </span><span class=n>ProductName</span>
</span><span id=__span-38-2><a id=__codelineno-38-2 name=__codelineno-38-2 href=#__codelineno-38-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Production</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-38-3><a id=__codelineno-38-3 name=__codelineno-38-3 href=#__codelineno-38-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>ProductCategoryID</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>);</span>
</span></code></pre></div> <h3 id=like>LIKE</h3> <p>最终比较运算符只能用于字符数据，并且允许使用通配符和正则表达式模式。 使用通配符，可以指定部分字符串。 例如，可以使用以下查询返回名称中包含单词“mountain”的所有产品：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-39-1><a id=__codelineno-39-1 name=__codelineno-39-1 href=#__codelineno-39-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>ListPrice</span>
</span><span id=__span-39-2><a id=__codelineno-39-2 name=__codelineno-39-2 href=#__codelineno-39-2></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-39-3><a id=__codelineno-39-3 name=__codelineno-39-3 href=#__codelineno-39-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>Name</span><span class=w> </span><span class=k>LIKE</span><span class=w> </span><span class=s1>&#39;%mountain%&#39;</span><span class=p>;</span>
</span><span id=__span-39-4><a id=__codelineno-39-4 name=__codelineno-39-4 href=#__codelineno-39-4></a>
</span><span id=__span-39-5><a id=__codelineno-39-5 name=__codelineno-39-5 href=#__codelineno-39-5></a><span class=cm>/*</span>
</span><span id=__span-39-6><a id=__codelineno-39-6 name=__codelineno-39-6 href=#__codelineno-39-6></a><span class=cm>% 通配符表示 0 个或更多字符的任何字符串，因此结果包括名称中任意位置有单词“mountain”的产品，如下所示：</span>
</span><span id=__span-39-7><a id=__codelineno-39-7 name=__codelineno-39-7 href=#__codelineno-39-7></a>
</span><span id=__span-39-8><a id=__codelineno-39-8 name=__codelineno-39-8 href=#__codelineno-39-8></a><span class=cm>名称                            ListPrice</span>
</span><span id=__span-39-9><a id=__codelineno-39-9 name=__codelineno-39-9 href=#__codelineno-39-9></a>
</span><span id=__span-39-10><a id=__codelineno-39-10 name=__codelineno-39-10 href=#__codelineno-39-10></a><span class=cm>山地自行车袜，M                  9.50</span>
</span><span id=__span-39-11><a id=__codelineno-39-11 name=__codelineno-39-11 href=#__codelineno-39-11></a>
</span><span id=__span-39-12><a id=__codelineno-39-12 name=__codelineno-39-12 href=#__codelineno-39-12></a><span class=cm>Mountain Bike Socks, L         9.50</span>
</span><span id=__span-39-13><a id=__codelineno-39-13 name=__codelineno-39-13 href=#__codelineno-39-13></a>
</span><span id=__span-39-14><a id=__codelineno-39-14 name=__codelineno-39-14 href=#__codelineno-39-14></a><span class=cm>HL Mountain Frame - Silver, 42 1364.0</span>
</span><span id=__span-39-15><a id=__codelineno-39-15 name=__codelineno-39-15 href=#__codelineno-39-15></a>
</span><span id=__span-39-16><a id=__codelineno-39-16 name=__codelineno-39-16 href=#__codelineno-39-16></a><span class=cm>HL Mountain Frame - Black, 42  1349.60</span>
</span><span id=__span-39-17><a id=__codelineno-39-17 name=__codelineno-39-17 href=#__codelineno-39-17></a>
</span><span id=__span-39-18><a id=__codelineno-39-18 name=__codelineno-39-18 href=#__codelineno-39-18></a><span class=cm>HL Mountain Frame - Silver, 38 1364.50</span>
</span><span id=__span-39-19><a id=__codelineno-39-19 name=__codelineno-39-19 href=#__codelineno-39-19></a>
</span><span id=__span-39-20><a id=__codelineno-39-20 name=__codelineno-39-20 href=#__codelineno-39-20></a><span class=cm>Mountain-100 Silver, 38        3399.99</span>
</span><span id=__span-39-21><a id=__codelineno-39-21 name=__codelineno-39-21 href=#__codelineno-39-21></a><span class=cm>*/</span>
</span></code></pre></div> <p>可以使用 _ 通配符来表示单个字符，如下所示：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-40-1><a id=__codelineno-40-1 name=__codelineno-40-1 href=#__codelineno-40-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductName</span><span class=p>,</span><span class=w> </span><span class=n>ListPrice</span>
</span><span id=__span-40-2><a id=__codelineno-40-2 name=__codelineno-40-2 href=#__codelineno-40-2></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-40-3><a id=__codelineno-40-3 name=__codelineno-40-3 href=#__codelineno-40-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>ProductName</span><span class=w> </span><span class=k>LIKE</span><span class=w> </span><span class=s1>&#39;Mountain Bike Socks, _&#39;</span><span class=p>;</span>
</span><span id=__span-40-4><a id=__codelineno-40-4 name=__codelineno-40-4 href=#__codelineno-40-4></a>
</span><span id=__span-40-5><a id=__codelineno-40-5 name=__codelineno-40-5 href=#__codelineno-40-5></a><span class=cm>/*</span>
</span><span id=__span-40-6><a id=__codelineno-40-6 name=__codelineno-40-6 href=#__codelineno-40-6></a><span class=cm>以下结果仅包括以“山地自行车袜子”开头的产品，以及后面的单个字符：</span>
</span><span id=__span-40-7><a id=__codelineno-40-7 name=__codelineno-40-7 href=#__codelineno-40-7></a>
</span><span id=__span-40-8><a id=__codelineno-40-8 name=__codelineno-40-8 href=#__codelineno-40-8></a><span class=cm>ProductName            ListPrice</span>
</span><span id=__span-40-9><a id=__codelineno-40-9 name=__codelineno-40-9 href=#__codelineno-40-9></a>
</span><span id=__span-40-10><a id=__codelineno-40-10 name=__codelineno-40-10 href=#__codelineno-40-10></a><span class=cm>山地自行车袜，M          9.50</span>
</span><span id=__span-40-11><a id=__codelineno-40-11 name=__codelineno-40-11 href=#__codelineno-40-11></a>
</span><span id=__span-40-12><a id=__codelineno-40-12 name=__codelineno-40-12 href=#__codelineno-40-12></a><span class=cm>Mountain Bike Socks, L 9.50</span>
</span></code></pre></div> <p>还可以定义要查找的复杂模式字符串。 例如，以下查询搜索了名称以“山地-”开头的产品，后跟：</p> <ul> <li>0 到 9 之间的三个字符</li> <li>1 个空格</li> <li>任何字符串</li> <li>一个逗号</li> <li>1 个空格</li> <li>介于 0 和 9 之间的两个字符</li> </ul> <div class="language-sql highlight"><pre><span></span><code><span id=__span-41-1><a id=__codelineno-41-1 name=__codelineno-41-1 href=#__codelineno-41-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductName</span><span class=p>,</span><span class=w> </span><span class=n>ListPrice</span>
</span><span id=__span-41-2><a id=__codelineno-41-2 name=__codelineno-41-2 href=#__codelineno-41-2></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-41-3><a id=__codelineno-41-3 name=__codelineno-41-3 href=#__codelineno-41-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>ProductName</span><span class=w> </span><span class=k>LIKE</span><span class=w> </span><span class=s1>&#39;Mountain-[0-9][0-9][0-9] %, [0-9][0-9]&#39;</span><span class=p>;</span>
</span><span id=__span-41-4><a id=__codelineno-41-4 name=__codelineno-41-4 href=#__codelineno-41-4></a>
</span><span id=__span-41-5><a id=__codelineno-41-5 name=__codelineno-41-5 href=#__codelineno-41-5></a><span class=cm>/*</span>
</span><span id=__span-41-6><a id=__codelineno-41-6 name=__codelineno-41-6 href=#__codelineno-41-6></a><span class=cm>该查询的结果可能如下所示：</span>
</span><span id=__span-41-7><a id=__codelineno-41-7 name=__codelineno-41-7 href=#__codelineno-41-7></a>
</span><span id=__span-41-8><a id=__codelineno-41-8 name=__codelineno-41-8 href=#__codelineno-41-8></a><span class=cm>ProductName                ListPrice</span>
</span><span id=__span-41-9><a id=__codelineno-41-9 name=__codelineno-41-9 href=#__codelineno-41-9></a>
</span><span id=__span-41-10><a id=__codelineno-41-10 name=__codelineno-41-10 href=#__codelineno-41-10></a><span class=cm>Mountain-100 Silver, 38    3399.99</span>
</span><span id=__span-41-11><a id=__codelineno-41-11 name=__codelineno-41-11 href=#__codelineno-41-11></a>
</span><span id=__span-41-12><a id=__codelineno-41-12 name=__codelineno-41-12 href=#__codelineno-41-12></a><span class=cm>Mountain-100 Silver, 42    3399.99</span>
</span><span id=__span-41-13><a id=__codelineno-41-13 name=__codelineno-41-13 href=#__codelineno-41-13></a>
</span><span id=__span-41-14><a id=__codelineno-41-14 name=__codelineno-41-14 href=#__codelineno-41-14></a><span class=cm>Mountain-100 Black, 38     3399.99</span>
</span><span id=__span-41-15><a id=__codelineno-41-15 name=__codelineno-41-15 href=#__codelineno-41-15></a>
</span><span id=__span-41-16><a id=__codelineno-41-16 name=__codelineno-41-16 href=#__codelineno-41-16></a><span class=cm>Mountain-100 Black, 42     3399.99</span>
</span><span id=__span-41-17><a id=__codelineno-41-17 name=__codelineno-41-17 href=#__codelineno-41-17></a>
</span><span id=__span-41-18><a id=__codelineno-41-18 name=__codelineno-41-18 href=#__codelineno-41-18></a><span class=cm>Mountain-200 Silver, 38    2319.99</span>
</span><span id=__span-41-19><a id=__codelineno-41-19 name=__codelineno-41-19 href=#__codelineno-41-19></a>
</span><span id=__span-41-20><a id=__codelineno-41-20 name=__codelineno-41-20 href=#__codelineno-41-20></a><span class=cm>Mountain-200 Silver, 42    2319.99</span>
</span><span id=__span-41-21><a id=__codelineno-41-21 name=__codelineno-41-21 href=#__codelineno-41-21></a>
</span><span id=__span-41-22><a id=__codelineno-41-22 name=__codelineno-41-22 href=#__codelineno-41-22></a><span class=cm>Mountain-200 Black, 38     2319.99</span>
</span><span id=__span-41-23><a id=__codelineno-41-23 name=__codelineno-41-23 href=#__codelineno-41-23></a>
</span><span id=__span-41-24><a id=__codelineno-41-24 name=__codelineno-41-24 href=#__codelineno-41-24></a><span class=cm>Mountain-200 Black, 42     2319.99</span>
</span></code></pre></div> <p>要了解有关使用 <strong>LIKE</strong> 运算符进行模式匹配的更多信息，请参阅 <a href=https://docs.microsoft.com/sql/t-sql/language-elements/like-transact-sql>Transact-SQL 文档 </a>。</p> <p><a href=https://microsoftlearning.github.io/dp-080-Transact-SQL/Instructions/Labs/02-filter-sort.html>练习 - 对查询结果进行排序和筛选</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-42-1><a id=__codelineno-42-1 name=__codelineno-42-1 href=#__codelineno-42-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>Name</span>
</span><span id=__span-42-2><a id=__codelineno-42-2 name=__codelineno-42-2 href=#__codelineno-42-2></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-42-3><a id=__codelineno-42-3 name=__codelineno-42-3 href=#__codelineno-42-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>SellEndDate</span><span class=w> </span><span class=k>BETWEEN</span><span class=w> </span><span class=s1>&#39;2006/1/1&#39;</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=s1>&#39;2006/12/31&#39;</span><span class=p>;</span>
</span></code></pre></div> <div class="language-sql highlight"><pre><span></span><code><span id=__span-43-1><a id=__codelineno-43-1 name=__codelineno-43-1 href=#__codelineno-43-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductNumber</span><span class=p>,</span><span class=w> </span><span class=n>Name</span>
</span><span id=__span-43-2><a id=__codelineno-43-2 name=__codelineno-43-2 href=#__codelineno-43-2></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-43-3><a id=__codelineno-43-3 name=__codelineno-43-3 href=#__codelineno-43-3></a><span class=k>WHERE</span><span class=w> </span><span class=p>(</span><span class=n>Color</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Black&#39;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Color</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Red&#39;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=n>Color</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;White&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=p>(</span><span class=k>Size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;S&#39;</span><span class=w> </span><span class=k>OR</span><span class=w> </span><span class=k>Size</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;M&#39;</span><span class=p>);</span>
</span><span id=__span-43-4><a id=__codelineno-43-4 name=__codelineno-43-4 href=#__codelineno-43-4></a>
</span><span id=__span-43-5><a id=__codelineno-43-5 name=__codelineno-43-5 href=#__codelineno-43-5></a><span class=c1>-- 等效</span>
</span><span id=__span-43-6><a id=__codelineno-43-6 name=__codelineno-43-6 href=#__codelineno-43-6></a>
</span><span id=__span-43-7><a id=__codelineno-43-7 name=__codelineno-43-7 href=#__codelineno-43-7></a><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>ProductNumber</span><span class=p>,</span><span class=w> </span><span class=n>Name</span>
</span><span id=__span-43-8><a id=__codelineno-43-8 name=__codelineno-43-8 href=#__codelineno-43-8></a><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-43-9><a id=__codelineno-43-9 name=__codelineno-43-9 href=#__codelineno-43-9></a><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>Color</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;Black&#39;</span><span class=p>,</span><span class=s1>&#39;Red&#39;</span><span class=p>,</span><span class=s1>&#39;White&#39;</span><span class=p>)</span><span class=w> </span><span class=k>AND</span><span class=w> </span><span class=k>Size</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=s1>&#39;S&#39;</span><span class=p>,</span><span class=s1>&#39;M&#39;</span><span class=p>);</span>
</span></code></pre></div> <p><a href=https://learn.microsoft.com/zh-cn/shows/programming-databases-with-t-sql-for-beginners/sort-and-filter-results-in-transact-sql-3-of-7-programming-databases-with-t-sql-for-beginners>在 Transact-SQL 中对结果进行排序和筛选 （第 3 部分（共 7 部分） |使用 T-SQL 为初学者编程数据库</a></p> <hr> <h2 id=_16>理解联接概念和语法</h2> <p>合并多个表中的数据的最基本且最常用的方法是使用 JOIN 运算。 有些人将 <u>JOIN 视为 SELECT 语句中的单独子句</u>，<u>而其他人则将其视为 FROM 子句的一部分</u>。 本模块主要将其视为 FROM 子句的一部分。 在本模块中，我们将了解 T-SQL SELECT 语句中的 FROM 子句如何创建中间虚拟表，这些虚拟表将在查询的后续阶段使用。</p> <div class="language-sql highlight"><span class=filename>JOIN 作为 FROM 子句的一部分</span><pre><span></span><code><span id=__span-44-1><a id=__codelineno-44-1 name=__codelineno-44-1 href=#__codelineno-44-1></a><span class=c1>-- 这是最常见的情况，JOIN 是直接写在 FROM 子句之后，表示不同表之间的连接。</span>
</span><span id=__span-44-2><a id=__codelineno-44-2 name=__codelineno-44-2 href=#__codelineno-44-2></a>
</span><span id=__span-44-3><a id=__codelineno-44-3 name=__codelineno-44-3 href=#__codelineno-44-3></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-44-4><a id=__codelineno-44-4 name=__codelineno-44-4 href=#__codelineno-44-4></a><span class=w>    </span><span class=n>p</span><span class=p>.</span><span class=n>ProductNumber</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>Name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>CategoryName</span>
</span><span id=__span-44-5><a id=__codelineno-44-5 name=__codelineno-44-5 href=#__codelineno-44-5></a><span class=k>FROM</span><span class=w> </span>
</span><span id=__span-44-6><a id=__codelineno-44-6 name=__codelineno-44-6 href=#__codelineno-44-6></a><span class=w>    </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span><span class=w> </span><span class=n>p</span>
</span><span id=__span-44-7><a id=__codelineno-44-7 name=__codelineno-44-7 href=#__codelineno-44-7></a><span class=k>JOIN</span><span class=w> </span>
</span><span id=__span-44-8><a id=__codelineno-44-8 name=__codelineno-44-8 href=#__codelineno-44-8></a><span class=w>    </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>ProductCategory</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>ProductCategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>ProductCategoryID</span>
</span><span id=__span-44-9><a id=__codelineno-44-9 name=__codelineno-44-9 href=#__codelineno-44-9></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span>
</span><span id=__span-44-10><a id=__codelineno-44-10 name=__codelineno-44-10 href=#__codelineno-44-10></a><span class=w>    </span><span class=n>p</span><span class=p>.</span><span class=n>Name</span><span class=p>;</span>
</span></code></pre></div> <ul> <li><code>JOIN</code> 在 <code>FROM</code> 子句中，直接连接了 <code>SalesLT.Product</code> 和 <code>SalesLT.ProductCategory</code> 两个表。</li> <li><code>p.ProductCategoryID = c.ProductCategoryID</code> 作为连接条件。</li> </ul> <p>这种写法是标准的 SQL 语法，<code>JOIN</code> 明确是 <code>FROM</code> 子句的一部分。</p> <div class="language-sql highlight"><span class=filename>将 JOIN 视为 SELECT 语句中的单独子句</span><pre><span></span><code><span id=__span-45-1><a id=__codelineno-45-1 name=__codelineno-45-1 href=#__codelineno-45-1></a><span class=c1>-- 在一些情况下，虽然 JOIN 仍然写在 FROM 子句中，但它可能被认为是单独的子句，特别是在某些 SQL 教程或文档中，强调 JOIN 是从表中“获取”数据的一种方式。</span>
</span><span id=__span-45-2><a id=__codelineno-45-2 name=__codelineno-45-2 href=#__codelineno-45-2></a>
</span><span id=__span-45-3><a id=__codelineno-45-3 name=__codelineno-45-3 href=#__codelineno-45-3></a><span class=k>SELECT</span><span class=w> </span>
</span><span id=__span-45-4><a id=__codelineno-45-4 name=__codelineno-45-4 href=#__codelineno-45-4></a><span class=w>    </span><span class=n>p</span><span class=p>.</span><span class=n>ProductNumber</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>Name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>CategoryName</span>
</span><span id=__span-45-5><a id=__codelineno-45-5 name=__codelineno-45-5 href=#__codelineno-45-5></a><span class=k>FROM</span><span class=w> </span>
</span><span id=__span-45-6><a id=__codelineno-45-6 name=__codelineno-45-6 href=#__codelineno-45-6></a><span class=w>    </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span><span class=w> </span><span class=n>p</span>
</span><span id=__span-45-7><a id=__codelineno-45-7 name=__codelineno-45-7 href=#__codelineno-45-7></a><span class=k>WHERE</span><span class=w> </span>
</span><span id=__span-45-8><a id=__codelineno-45-8 name=__codelineno-45-8 href=#__codelineno-45-8></a><span class=w>    </span><span class=n>p</span><span class=p>.</span><span class=n>ListPrice</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>100</span>
</span><span id=__span-45-9><a id=__codelineno-45-9 name=__codelineno-45-9 href=#__codelineno-45-9></a><span class=k>JOIN</span><span class=w> </span>
</span><span id=__span-45-10><a id=__codelineno-45-10 name=__codelineno-45-10 href=#__codelineno-45-10></a><span class=w>    </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>ProductCategory</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>ProductCategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>ProductCategoryID</span>
</span><span id=__span-45-11><a id=__codelineno-45-11 name=__codelineno-45-11 href=#__codelineno-45-11></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span>
</span><span id=__span-45-12><a id=__codelineno-45-12 name=__codelineno-45-12 href=#__codelineno-45-12></a><span class=w>    </span><span class=n>p</span><span class=p>.</span><span class=n>Name</span><span class=p>;</span>
</span></code></pre></div> <ul> <li>在这个查询中，<code>JOIN</code> 仍然是连接 <code>SalesLT.Product</code> 和 <code>SalesLT.ProductCategory</code> 表，但在某些教程或文档中，这种写法可能被看作 <code>JOIN</code> 是一个独立的操作，因为它位于 <code>WHERE</code> 子句之后（虽然这是不推荐的写法，标准 SQL 语法要求 <code>JOIN</code> 在 <code>FROM</code> 子句中）。</li> </ul> <p>这种方式有时出现在非正式或教学性内容中，目的是帮助理解 SQL 的联接逻辑，但在实际应用中通常会遵循第一种方式（<code>JOIN</code> 在 <code>FROM</code> 子句中）。在标准 SQL 中，不应该把 <code>JOIN</code> 放在 <code>WHERE</code> 子句之后。</p> <h2 id=from><a href=https://learn.microsoft.com/zh-cn/training/modules/query-multiple-tables-with-joins/2-join-concepts>FROM 子句和虚拟表</a></h2> <p>如果你已了解 SQL Server 处理查询时执行的运算的逻辑顺序，则会发现 SELECT 语句的 FROM 子句是第一个要处理的子句。 此子句确定哪个表或哪些表将成为查询的行源。 FROM 可以引用单个表或将多个表组合在一起作为查询的数据源。 <u>可以将 FROM 子句视为创建和填充一个<strong>虚拟表</strong>。 该虚拟表将保存 FROM 子句的输出，并由稍后应用的 SELECT 语句的子句使用，例如 WHERE 子句</u>。 在向 FROM 子句添加额外的功能（例如<a href="https://learn.microsoft.com/zh-cn/sql/relational-databases/performance/joins?view=sql-server-ver16">联接运算符</a>）时，可以将 FROM 子句元素的目的理解为在虚拟表中添加或删除行。</p> <div class="language-sql highlight"><span class=filename>FROM 子句元素的目的理解为在虚拟表中添加或删除行</span><pre><span></span><code><span id=__span-46-1><a id=__codelineno-46-1 name=__codelineno-46-1 href=#__codelineno-46-1></a><span class=c1>-- Products 表</span>
</span><span id=__span-46-2><a id=__codelineno-46-2 name=__codelineno-46-2 href=#__codelineno-46-2></a><span class=n>ProductID</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ProductName</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CategoryID</span>
</span><span id=__span-46-3><a id=__codelineno-46-3 name=__codelineno-46-3 href=#__codelineno-46-3></a><span class=c1>----------------------------------</span>
</span><span id=__span-46-4><a id=__codelineno-46-4 name=__codelineno-46-4 href=#__codelineno-46-4></a><span class=mi>1</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Bike</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=mi>10</span>
</span><span id=__span-46-5><a id=__codelineno-46-5 name=__codelineno-46-5 href=#__codelineno-46-5></a><span class=mi>2</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Helmet</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=mi>20</span>
</span><span id=__span-46-6><a id=__codelineno-46-6 name=__codelineno-46-6 href=#__codelineno-46-6></a><span class=mi>3</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Tire</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=mi>10</span>
</span><span id=__span-46-7><a id=__codelineno-46-7 name=__codelineno-46-7 href=#__codelineno-46-7></a><span class=mi>4</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Gloves</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=mi>30</span>
</span><span id=__span-46-8><a id=__codelineno-46-8 name=__codelineno-46-8 href=#__codelineno-46-8></a>
</span><span id=__span-46-9><a id=__codelineno-46-9 name=__codelineno-46-9 href=#__codelineno-46-9></a><span class=c1>-- Categories 表</span>
</span><span id=__span-46-10><a id=__codelineno-46-10 name=__codelineno-46-10 href=#__codelineno-46-10></a><span class=n>CategoryID</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CategoryName</span>
</span><span id=__span-46-11><a id=__codelineno-46-11 name=__codelineno-46-11 href=#__codelineno-46-11></a><span class=c1>--------------------------</span>
</span><span id=__span-46-12><a id=__codelineno-46-12 name=__codelineno-46-12 href=#__codelineno-46-12></a><span class=mi>10</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Cycling</span>
</span><span id=__span-46-13><a id=__codelineno-46-13 name=__codelineno-46-13 href=#__codelineno-46-13></a><span class=mi>20</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Sports</span>
</span><span id=__span-46-14><a id=__codelineno-46-14 name=__codelineno-46-14 href=#__codelineno-46-14></a><span class=mi>30</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Accessories</span>
</span><span id=__span-46-15><a id=__codelineno-46-15 name=__codelineno-46-15 href=#__codelineno-46-15></a>
</span><span id=__span-46-16><a id=__codelineno-46-16 name=__codelineno-46-16 href=#__codelineno-46-16></a><span class=k>SELECT</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>ProductName</span><span class=p>,</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CategoryName</span>
</span><span id=__span-46-17><a id=__codelineno-46-17 name=__codelineno-46-17 href=#__codelineno-46-17></a><span class=k>FROM</span><span class=w> </span><span class=n>Products</span><span class=w> </span><span class=n>p</span>
</span><span id=__span-46-18><a id=__codelineno-46-18 name=__codelineno-46-18 href=#__codelineno-46-18></a><span class=k>JOIN</span><span class=w> </span><span class=n>Categories</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>CategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CategoryID</span><span class=p>;</span>
</span><span id=__span-46-19><a id=__codelineno-46-19 name=__codelineno-46-19 href=#__codelineno-46-19></a><span class=c1>-- 通过联接操作，虚拟表中会生成新的行，包含 ProductName 和 CategoryName 字段。</span>
</span><span id=__span-46-20><a id=__codelineno-46-20 name=__codelineno-46-20 href=#__codelineno-46-20></a>
</span><span id=__span-46-21><a id=__codelineno-46-21 name=__codelineno-46-21 href=#__codelineno-46-21></a><span class=n>ProductName</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CategoryName</span>
</span><span id=__span-46-22><a id=__codelineno-46-22 name=__codelineno-46-22 href=#__codelineno-46-22></a><span class=c1>--------------------------</span>
</span><span id=__span-46-23><a id=__codelineno-46-23 name=__codelineno-46-23 href=#__codelineno-46-23></a><span class=n>Bike</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=n>Cycling</span>
</span><span id=__span-46-24><a id=__codelineno-46-24 name=__codelineno-46-24 href=#__codelineno-46-24></a><span class=n>Tire</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=n>Cycling</span>
</span><span id=__span-46-25><a id=__codelineno-46-25 name=__codelineno-46-25 href=#__codelineno-46-25></a><span class=n>Helmet</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>Sports</span>
</span><span id=__span-46-26><a id=__codelineno-46-26 name=__codelineno-46-26 href=#__codelineno-46-26></a><span class=n>Gloves</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>Accessories</span>
</span><span id=__span-46-27><a id=__codelineno-46-27 name=__codelineno-46-27 href=#__codelineno-46-27></a>
</span><span id=__span-46-28><a id=__codelineno-46-28 name=__codelineno-46-28 href=#__codelineno-46-28></a><span class=k>SELECT</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>ProductName</span><span class=p>,</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CategoryName</span>
</span><span id=__span-46-29><a id=__codelineno-46-29 name=__codelineno-46-29 href=#__codelineno-46-29></a><span class=k>FROM</span><span class=w> </span><span class=n>Products</span><span class=w> </span><span class=n>p</span>
</span><span id=__span-46-30><a id=__codelineno-46-30 name=__codelineno-46-30 href=#__codelineno-46-30></a><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>Categories</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>CategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CategoryID</span><span class=p>;</span>
</span><span id=__span-46-31><a id=__codelineno-46-31 name=__codelineno-46-31 href=#__codelineno-46-31></a><span class=c1>-- 通过左联接操作，Categories 表中的每一行都会尝试与 Products 表进行匹配。如果没有匹配项，Products 表中的行仍然会保留，只是 CategoryName 会返回 NULL。这里并没有行被“删除”，即使有某些商品没有匹配的类别，左联接会保留它们并用 NULL 填充。</span>
</span><span id=__span-46-32><a id=__codelineno-46-32 name=__codelineno-46-32 href=#__codelineno-46-32></a><span class=n>ProductName</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CategoryName</span>
</span><span id=__span-46-33><a id=__codelineno-46-33 name=__codelineno-46-33 href=#__codelineno-46-33></a><span class=c1>--------------------------</span>
</span><span id=__span-46-34><a id=__codelineno-46-34 name=__codelineno-46-34 href=#__codelineno-46-34></a><span class=n>Bike</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=n>Cycling</span>
</span><span id=__span-46-35><a id=__codelineno-46-35 name=__codelineno-46-35 href=#__codelineno-46-35></a><span class=n>Tire</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=n>Cycling</span>
</span><span id=__span-46-36><a id=__codelineno-46-36 name=__codelineno-46-36 href=#__codelineno-46-36></a><span class=n>Helmet</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>Sports</span>
</span><span id=__span-46-37><a id=__codelineno-46-37 name=__codelineno-46-37 href=#__codelineno-46-37></a><span class=n>Gloves</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>Accessories</span>
</span><span id=__span-46-38><a id=__codelineno-46-38 name=__codelineno-46-38 href=#__codelineno-46-38></a>
</span><span id=__span-46-39><a id=__codelineno-46-39 name=__codelineno-46-39 href=#__codelineno-46-39></a><span class=c1>-- 修改后的 Products 表</span>
</span><span id=__span-46-40><a id=__codelineno-46-40 name=__codelineno-46-40 href=#__codelineno-46-40></a><span class=n>ProductID</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>ProductName</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CategoryID</span>
</span><span id=__span-46-41><a id=__codelineno-46-41 name=__codelineno-46-41 href=#__codelineno-46-41></a><span class=c1>----------------------------------</span>
</span><span id=__span-46-42><a id=__codelineno-46-42 name=__codelineno-46-42 href=#__codelineno-46-42></a><span class=mi>1</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Bike</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=mi>10</span>
</span><span id=__span-46-43><a id=__codelineno-46-43 name=__codelineno-46-43 href=#__codelineno-46-43></a><span class=mi>2</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Helmet</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=mi>20</span>
</span><span id=__span-46-44><a id=__codelineno-46-44 name=__codelineno-46-44 href=#__codelineno-46-44></a><span class=mi>3</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Tire</span><span class=w>       </span><span class=o>|</span><span class=w> </span><span class=mi>10</span>
</span><span id=__span-46-45><a id=__codelineno-46-45 name=__codelineno-46-45 href=#__codelineno-46-45></a><span class=mi>4</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=n>Gloves</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=mi>30</span>
</span><span id=__span-46-46><a id=__codelineno-46-46 name=__codelineno-46-46 href=#__codelineno-46-46></a><span class=mi>5</span><span class=w>         </span><span class=o>|</span><span class=w> </span><span class=k>Unknown</span><span class=w>    </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span><span class=w>  </span><span class=c1>-- 新添加的没有类别的商品</span>
</span><span id=__span-46-47><a id=__codelineno-46-47 name=__codelineno-46-47 href=#__codelineno-46-47></a>
</span><span id=__span-46-48><a id=__codelineno-46-48 name=__codelineno-46-48 href=#__codelineno-46-48></a><span class=k>SELECT</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>ProductName</span><span class=p>,</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CategoryName</span>
</span><span id=__span-46-49><a id=__codelineno-46-49 name=__codelineno-46-49 href=#__codelineno-46-49></a><span class=k>FROM</span><span class=w> </span><span class=n>Products</span><span class=w> </span><span class=n>p</span>
</span><span id=__span-46-50><a id=__codelineno-46-50 name=__codelineno-46-50 href=#__codelineno-46-50></a><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>Categories</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>CategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CategoryID</span><span class=p>;</span>
</span><span id=__span-46-51><a id=__codelineno-46-51 name=__codelineno-46-51 href=#__codelineno-46-51></a>
</span><span id=__span-46-52><a id=__codelineno-46-52 name=__codelineno-46-52 href=#__codelineno-46-52></a><span class=c1>-- 在这种情况下，Unknown 商品会被删除，因为它没有匹配的类别（NULL），INNER JOIN 只返回两个表中都有的匹配行。</span>
</span><span id=__span-46-53><a id=__codelineno-46-53 name=__codelineno-46-53 href=#__codelineno-46-53></a><span class=n>ProductName</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CategoryName</span>
</span><span id=__span-46-54><a id=__codelineno-46-54 name=__codelineno-46-54 href=#__codelineno-46-54></a><span class=c1>--------------------------</span>
</span><span id=__span-46-55><a id=__codelineno-46-55 name=__codelineno-46-55 href=#__codelineno-46-55></a><span class=n>Bike</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=n>Cycling</span>
</span><span id=__span-46-56><a id=__codelineno-46-56 name=__codelineno-46-56 href=#__codelineno-46-56></a><span class=n>Tire</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=n>Cycling</span>
</span><span id=__span-46-57><a id=__codelineno-46-57 name=__codelineno-46-57 href=#__codelineno-46-57></a><span class=n>Helmet</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>Sports</span>
</span><span id=__span-46-58><a id=__codelineno-46-58 name=__codelineno-46-58 href=#__codelineno-46-58></a><span class=n>Gloves</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>Accessories</span>
</span><span id=__span-46-59><a id=__codelineno-46-59 name=__codelineno-46-59 href=#__codelineno-46-59></a>
</span><span id=__span-46-60><a id=__codelineno-46-60 name=__codelineno-46-60 href=#__codelineno-46-60></a><span class=k>SELECT</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>ProductName</span><span class=p>,</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CategoryName</span>
</span><span id=__span-46-61><a id=__codelineno-46-61 name=__codelineno-46-61 href=#__codelineno-46-61></a><span class=k>FROM</span><span class=w> </span><span class=n>Products</span><span class=w> </span><span class=n>p</span>
</span><span id=__span-46-62><a id=__codelineno-46-62 name=__codelineno-46-62 href=#__codelineno-46-62></a><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>Categories</span><span class=w> </span><span class=k>c</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>CategoryID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CategoryID</span><span class=p>;</span>
</span><span id=__span-46-63><a id=__codelineno-46-63 name=__codelineno-46-63 href=#__codelineno-46-63></a>
</span><span id=__span-46-64><a id=__codelineno-46-64 name=__codelineno-46-64 href=#__codelineno-46-64></a><span class=c1>-- 这里 Unknown 商品的行被保留，虽然没有匹配的类别，但仍然保留了商品名称，并且 CategoryName 返回了 NULL。</span>
</span><span id=__span-46-65><a id=__codelineno-46-65 name=__codelineno-46-65 href=#__codelineno-46-65></a><span class=n>ProductName</span><span class=w> </span><span class=o>|</span><span class=w> </span><span class=n>CategoryName</span>
</span><span id=__span-46-66><a id=__codelineno-46-66 name=__codelineno-46-66 href=#__codelineno-46-66></a><span class=c1>--------------------------</span>
</span><span id=__span-46-67><a id=__codelineno-46-67 name=__codelineno-46-67 href=#__codelineno-46-67></a><span class=n>Bike</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=n>Cycling</span>
</span><span id=__span-46-68><a id=__codelineno-46-68 name=__codelineno-46-68 href=#__codelineno-46-68></a><span class=n>Tire</span><span class=w>        </span><span class=o>|</span><span class=w> </span><span class=n>Cycling</span>
</span><span id=__span-46-69><a id=__codelineno-46-69 name=__codelineno-46-69 href=#__codelineno-46-69></a><span class=n>Helmet</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>Sports</span>
</span><span id=__span-46-70><a id=__codelineno-46-70 name=__codelineno-46-70 href=#__codelineno-46-70></a><span class=n>Gloves</span><span class=w>      </span><span class=o>|</span><span class=w> </span><span class=n>Accessories</span>
</span><span id=__span-46-71><a id=__codelineno-46-71 name=__codelineno-46-71 href=#__codelineno-46-71></a><span class=k>Unknown</span><span class=w>     </span><span class=o>|</span><span class=w> </span><span class=k>NULL</span>
</span></code></pre></div> <ul> <li><strong><code>JOIN</code> 操作</strong> 在 <code>FROM</code> 子句中，实际上是 <strong>添加行</strong> 或 <strong>删除行</strong> 的操作。<code>INNER JOIN</code> 会将不符合联接条件的行删除，而 <code>LEFT JOIN</code> 则会保留这些行并用 <code>NULL</code> 填充缺失的值。</li> <li>在虚拟表中，<code>JOIN</code> 操作增加了新的行，或者按联接条件删除不匹配的行。</li> </ul> <p>这就是为什么可以将 <code>FROM</code> 子句理解为“创建和填充一个虚拟表”的原因，<code>JOIN</code> 操作通过匹配条件将不同表中的数据合并，并根据联接类型（内联接、左联接等）来决定最终虚拟表中的行数。</p> <p>由 FROM 子句创建的虚拟表只是逻辑实体。 在 SQL Server 中，不会创建任何物理表（无论是永久的还是临时的）来保存 FROM 子句的结果，因为该表将传递给 WHERE 子句或查询的其他部分。</p> <p>由 FROM 子句创建的虚拟表包含来自所有联接表的数据。 可以将结果视为集，并将联接结果概念化为维恩图。</p> <p><a class=glightbox href=../assets/T-SQL/join-venn-diagram.avif data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt="显示联接到 SalesOrder 表的 Employee 表集的维恩图" src=../assets/T-SQL/join-venn-diagram.avif></a></p> <p>在 T-SQL 语言的整个历史中，它经过不断扩展，反映了 SQL 语言的美国国家标准协会 (ANSI) 标准的更改。 体现这些更改的最明显的地方之一是 FROM 子句中的联接语法。 在 <a href=https://archive.org/details/federalinformati1271nati/mode/2up>ANSI SQL-89</a> 标准中，通过在以逗号分隔的列表中的 FROM 子句中包含多个表来指定联接。 用于确定要包括哪些行的任何筛选均在 WHERE 子句中执行，如下所示：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-47-1><a id=__codelineno-47-1 name=__codelineno-47-1 href=#__codelineno-47-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>ProductID</span><span class=p>,</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>Name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>Name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Product</span>
</span><span id=__span-47-2><a id=__codelineno-47-2 name=__codelineno-47-2 href=#__codelineno-47-2></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>ProductModel</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>m</span>
</span><span id=__span-47-3><a id=__codelineno-47-3 name=__codelineno-47-3 href=#__codelineno-47-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>ProductModelID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>ProductModelID</span><span class=p>;</span>
</span></code></pre></div> <p>SQL Server 仍支持此语法，但是由于表示复杂联接的筛选器很复杂，因此不建议使用。 此外，如果意外省略了 WHERE 子句，则 ANSI SQL-89 样式的联接很容易成为<strong><a href=https://zh.wikipedia.org/wiki/%E7%AC%9B%E5%8D%A1%E5%84%BF%E7%A7%AF>笛卡尔乘积</a></strong>，并返回过多的结果行，从而导致性能问题，并可能生成错误的结果。</p> <p>...</p> <p>在数据库中，笛卡尔乘积是将一个表中的每一行与另一个表中的每一行相结合的结果。 一个包含 10 行的表和一个包含 100 行的表的乘积是一个包含 1,000 行的结果集。 JOIN 运算的基本结果是笛卡尔乘积，但是对于大多数 T-SQL 查询来说，笛卡尔乘积并不是期望的结果。 在 T-SQL 中，当联接两个输入表，而不考虑它们之间的任何关系时，就会产生笛卡尔乘积。 如果没有关于关系的信息，SQL Server 查询处理器将返回所有可能的行组合。 尽管此结果可能有一定的实际应用价值，例如生成测试数据，但通常并没有用，并且可能会对性能产生严重影响。</p> <p>随着 <a href=https://www.contrib.andrew.cmu.edu/~shadow/sql/sql1992.txt>ANSI SQL-92</a> 标准的出现，添加了对关键字 JOIN 和 ON 子句的支持。 T-SQL 也支持此语法。 在 FROM 子句中通过使用相应的 JOIN 运算符来表示联接。 在 ON 子句中指定了表之间的逻辑关系，该关系成为筛选谓词。</p> <p>下面的示例使用较新的语法重述了前面的查询：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-48-1><a id=__codelineno-48-1 name=__codelineno-48-1 href=#__codelineno-48-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>ProductID</span><span class=p>,</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>Name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Model</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>Name</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Product</span>
</span><span id=__span-48-2><a id=__codelineno-48-2 name=__codelineno-48-2 href=#__codelineno-48-2></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>p</span>
</span><span id=__span-48-3><a id=__codelineno-48-3 name=__codelineno-48-3 href=#__codelineno-48-3></a><span class=k>JOIN</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>ProductModel</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>m</span>
</span><span id=__span-48-4><a id=__codelineno-48-4 name=__codelineno-48-4 href=#__codelineno-48-4></a><span class=w>    </span><span class=k>ON</span><span class=w> </span><span class=n>p</span><span class=p>.</span><span class=n>ProductModelID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>m</span><span class=p>.</span><span class=n>ProductModelID</span><span class=p>;</span>
</span></code></pre></div> <p><strong>ANSI SQL-92 语法使创建偶然的笛卡尔乘积变得更加困难。 添加关键字 JOIN 后，除非将 JOIN 指定为 CROSS JOIN，否则在缺少 ON 子句的情况下将引发语法错误。</strong></p> <h2 id=_17>使用内部联接</h2> <p>T-SQL 查询中最常见的 JOIN 类型是 INNER JOIN。 内部联接用于解决许多常见的业务问题，尤其是在高度规范化的数据库环境中。 要在多个表中检索已存储的数据，通常需要通过 INNER JOIN 查询将其合并。 <u>INNER JOIN 以笛卡尔乘积的形式开始其逻辑处理阶段，然后对其进行筛选以删除与谓词不匹配的所有行</u>。</p> <h3 id=inner-join>处理 INNER JOIN</h3> <p>我们来看看 SQL Server 对 JOIN 查询进行逻辑处理的步骤。 为了清楚起见，在以下假设示例中添加了行号：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-49-1><a id=__codelineno-49-1 name=__codelineno-49-1 href=#__codelineno-49-1></a><span class=mi>1</span><span class=p>)</span><span class=w> </span><span class=k>SELECT</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>FirstName</span><span class=p>,</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>Amount</span>
</span><span id=__span-49-2><a id=__codelineno-49-2 name=__codelineno-49-2 href=#__codelineno-49-2></a><span class=mi>2</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>HR</span><span class=p>.</span><span class=n>Employee</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>emp</span><span class=w> </span>
</span><span id=__span-49-3><a id=__codelineno-49-3 name=__codelineno-49-3 href=#__codelineno-49-3></a><span class=mi>3</span><span class=p>)</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrder</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>ord</span>
</span><span id=__span-49-4><a id=__codelineno-49-4 name=__codelineno-49-4 href=#__codelineno-49-4></a><span class=mi>4</span><span class=p>)</span><span class=w>      </span><span class=k>ON</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>EmployeeID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>EmployeeID</span><span class=p>;</span>
</span></code></pre></div> <p>你应该知道，FROM 子句将在 SELECT 子句之前处理。 让我们从第 2 行开始跟踪处理过程：</p> <ul> <li>FROM 子句将“HR.Employee”表指定为输入表之一，并为其提供别名“emp”。</li> <li>第 3 行中的 <u>JOIN 运算符反映了 INNER JOIN（T-SQL 中的默认类型）</u>的用法，并将“Sales.SalesOrder”指定为另一个输入表，其别名为“ord”。</li> <li>SQL Server 将对这些表执行逻辑笛卡尔联接，并将结果作为虚拟表传递到下一步。 （查询的物理处理实际上可能不会执行笛卡尔乘积运算，具体取决于优化器的决策。但是，可以想象一下正在创建笛卡尔乘积。）</li> <li>使用 ON 子句，SQL Server 将筛选虚拟表，仅保留“emp”表中 EmployeeID 值与“ord”表中的 EmployeeID 匹配的那些行。</li> <li>其余的行将留在虚拟表中，并移交给 SELECT 语句中的下一步。 在此示例中，虚拟表接下来由 SELECT 子句处理，并将两个指定的列返回到客户端应用程序。</li> </ul> <p>已完成的查询生成一个员工及其订单数量的列表。 ON 子句会筛选掉没有任何关联订单的员工，也会筛选掉拥有任何恰巧包含 EmployeeID 但与“HR.Employee”表中条目不对应的订单的员工。</p> <p><a class=glightbox href=../assets/T-SQL/inner-join-venn-diagram.avif data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt="显示 Employee 和 SalesOrder 集的匹配成员的维恩图" src=../assets/T-SQL/inner-join-venn-diagram.avif></a></p> <h3 id=inner-join_1>INNER JOIN 语法</h3> <p><strong>INNER JOIN 是 JOIN 的默认类型，可选的 INNER 关键字在 JOIN 子句中是隐式的</strong>。 在混合和匹配联接类型时，显式指定联接类型可能很有用，如以下假设示例所示：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-50-1><a id=__codelineno-50-1 name=__codelineno-50-1 href=#__codelineno-50-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>FirstName</span><span class=p>,</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>Amount</span>
</span><span id=__span-50-2><a id=__codelineno-50-2 name=__codelineno-50-2 href=#__codelineno-50-2></a><span class=k>FROM</span><span class=w> </span><span class=n>HR</span><span class=p>.</span><span class=n>Employee</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>emp</span><span class=w> </span>
</span><span id=__span-50-3><a id=__codelineno-50-3 name=__codelineno-50-3 href=#__codelineno-50-3></a><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrder</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>ord</span>
</span><span id=__span-50-4><a id=__codelineno-50-4 name=__codelineno-50-4 href=#__codelineno-50-4></a><span class=w>    </span><span class=k>ON</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>EmployeeID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>EmployeeID</span><span class=p>;</span>
</span></code></pre></div> <p>使用内部联接编写查询时，请考虑以下准则：</p> <ul> <li>表别名不仅是 SELECT 列表的首选，也是编写 ON 子句时的首选。</li> <li>内部联接可以针对单个匹配列（例如 OrderID）执行，也可以针对多个匹配属性（例如 OrderID 和 ProductID 的组合）执行。 <u>指定多个匹配列的联接称为复合联接</u>。</li> <li>对于 SQL Server 优化器来说，INNER JOIN 的 FROM 子句中列出的表的顺序并不重要。 从概念上讲，联接将从左到右进行评估。</li> <li>对于 FROM 列表中的每对联接表使用一次 JOIN 关键字。 对于两个表的查询，请指定一个联接。 对于三个表的查询，将使用两次 JOIN；一次是在前两个表之间，一次是在前两个表和第三个表之间的 JOIN 输出之间。</li> </ul> <div class="language-sql highlight"><span class=filename>什么是复合连接</span><pre><span></span><code><span id=__span-51-1><a id=__codelineno-51-1 name=__codelineno-51-1 href=#__codelineno-51-1></a><span class=cm>/*</span>
</span><span id=__span-51-2><a id=__codelineno-51-2 name=__codelineno-51-2 href=#__codelineno-51-2></a><span class=cm>Orders 表：</span>
</span><span id=__span-51-3><a id=__codelineno-51-3 name=__codelineno-51-3 href=#__codelineno-51-3></a><span class=cm>OrderID OrderDate   CustomerID</span>
</span><span id=__span-51-4><a id=__codelineno-51-4 name=__codelineno-51-4 href=#__codelineno-51-4></a><span class=cm>1001    2025-01-01  A123</span>
</span><span id=__span-51-5><a id=__codelineno-51-5 name=__codelineno-51-5 href=#__codelineno-51-5></a><span class=cm>1002    2025-02-01  B456</span>
</span><span id=__span-51-6><a id=__codelineno-51-6 name=__codelineno-51-6 href=#__codelineno-51-6></a><span class=cm>1003    2025-03-01  C789</span>
</span><span id=__span-51-7><a id=__codelineno-51-7 name=__codelineno-51-7 href=#__codelineno-51-7></a>
</span><span id=__span-51-8><a id=__codelineno-51-8 name=__codelineno-51-8 href=#__codelineno-51-8></a><span class=cm>OrderDetails 表：</span>
</span><span id=__span-51-9><a id=__codelineno-51-9 name=__codelineno-51-9 href=#__codelineno-51-9></a><span class=cm>OrderID ProductID   Quantity    Price</span>
</span><span id=__span-51-10><a id=__codelineno-51-10 name=__codelineno-51-10 href=#__codelineno-51-10></a><span class=cm>1001    101         2           15.5</span>
</span><span id=__span-51-11><a id=__codelineno-51-11 name=__codelineno-51-11 href=#__codelineno-51-11></a><span class=cm>1001    102         1           25.0</span>
</span><span id=__span-51-12><a id=__codelineno-51-12 name=__codelineno-51-12 href=#__codelineno-51-12></a><span class=cm>1002    103         3           10.0</span>
</span><span id=__span-51-13><a id=__codelineno-51-13 name=__codelineno-51-13 href=#__codelineno-51-13></a><span class=cm>1003    104         5           12.0</span>
</span><span id=__span-51-14><a id=__codelineno-51-14 name=__codelineno-51-14 href=#__codelineno-51-14></a><span class=cm>1003    105         2           18.0</span>
</span><span id=__span-51-15><a id=__codelineno-51-15 name=__codelineno-51-15 href=#__codelineno-51-15></a><span class=cm>*/</span>
</span><span id=__span-51-16><a id=__codelineno-51-16 name=__codelineno-51-16 href=#__codelineno-51-16></a>
</span><span id=__span-51-17><a id=__codelineno-51-17 name=__codelineno-51-17 href=#__codelineno-51-17></a><span class=c1>-- 我们通常会使用单一列来联接这两个表，例如 OrderID，来查询每个订单的商品详情。</span>
</span><span id=__span-51-18><a id=__codelineno-51-18 name=__codelineno-51-18 href=#__codelineno-51-18></a><span class=k>SELECT</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>OrderID</span><span class=p>,</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>OrderDate</span><span class=p>,</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>ProductID</span><span class=p>,</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>Quantity</span><span class=p>,</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>Price</span>
</span><span id=__span-51-19><a id=__codelineno-51-19 name=__codelineno-51-19 href=#__codelineno-51-19></a><span class=k>FROM</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=n>ord</span>
</span><span id=__span-51-20><a id=__codelineno-51-20 name=__codelineno-51-20 href=#__codelineno-51-20></a><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>OrderDetails</span><span class=w> </span><span class=n>od</span>
</span><span id=__span-51-21><a id=__codelineno-51-21 name=__codelineno-51-21 href=#__codelineno-51-21></a><span class=w>    </span><span class=k>ON</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>OrderID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>OrderID</span><span class=p>;</span>
</span><span id=__span-51-22><a id=__codelineno-51-22 name=__codelineno-51-22 href=#__codelineno-51-22></a>
</span><span id=__span-51-23><a id=__codelineno-51-23 name=__codelineno-51-23 href=#__codelineno-51-23></a><span class=cm>/*</span>
</span><span id=__span-51-24><a id=__codelineno-51-24 name=__codelineno-51-24 href=#__codelineno-51-24></a><span class=cm>结果：</span>
</span><span id=__span-51-25><a id=__codelineno-51-25 name=__codelineno-51-25 href=#__codelineno-51-25></a><span class=cm>OrderID OrderDate   ProductID   Quantity    Price</span>
</span><span id=__span-51-26><a id=__codelineno-51-26 name=__codelineno-51-26 href=#__codelineno-51-26></a><span class=cm>1001    2025-01-01  101         2           15.5</span>
</span><span id=__span-51-27><a id=__codelineno-51-27 name=__codelineno-51-27 href=#__codelineno-51-27></a><span class=cm>1001    2025-01-01  102         1           25.0</span>
</span><span id=__span-51-28><a id=__codelineno-51-28 name=__codelineno-51-28 href=#__codelineno-51-28></a><span class=cm>1002    2025-02-01  103         3           10.0</span>
</span><span id=__span-51-29><a id=__codelineno-51-29 name=__codelineno-51-29 href=#__codelineno-51-29></a><span class=cm>1003    2025-03-01  104         5           12.0</span>
</span><span id=__span-51-30><a id=__codelineno-51-30 name=__codelineno-51-30 href=#__codelineno-51-30></a><span class=cm>1003    2025-03-01  105         2           18.0</span>
</span><span id=__span-51-31><a id=__codelineno-51-31 name=__codelineno-51-31 href=#__codelineno-51-31></a><span class=cm>*/</span>
</span><span id=__span-51-32><a id=__codelineno-51-32 name=__codelineno-51-32 href=#__codelineno-51-32></a>
</span><span id=__span-51-33><a id=__codelineno-51-33 name=__codelineno-51-33 href=#__codelineno-51-33></a><span class=c1>-- 复合联接则涉及多个列来进行匹配。在这种情况下，我们不仅需要 OrderID 来匹配订单，还可能需要 ProductID 来确定每个订单的具体商品。假设我们想要根据 OrderID 和 ProductID 两个条件来联合 Orders 表和 OrderDetails 表：</span>
</span><span id=__span-51-34><a id=__codelineno-51-34 name=__codelineno-51-34 href=#__codelineno-51-34></a>
</span><span id=__span-51-35><a id=__codelineno-51-35 name=__codelineno-51-35 href=#__codelineno-51-35></a><span class=k>SELECT</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>OrderID</span><span class=p>,</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>OrderDate</span><span class=p>,</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>ProductID</span><span class=p>,</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>Quantity</span><span class=p>,</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>Price</span>
</span><span id=__span-51-36><a id=__codelineno-51-36 name=__codelineno-51-36 href=#__codelineno-51-36></a><span class=k>FROM</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=n>ord</span>
</span><span id=__span-51-37><a id=__codelineno-51-37 name=__codelineno-51-37 href=#__codelineno-51-37></a><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>OrderDetails</span><span class=w> </span><span class=n>od</span>
</span><span id=__span-51-38><a id=__codelineno-51-38 name=__codelineno-51-38 href=#__codelineno-51-38></a><span class=w>    </span><span class=k>ON</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>OrderID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>OrderID</span>
</span><span id=__span-51-39><a id=__codelineno-51-39 name=__codelineno-51-39 href=#__codelineno-51-39></a><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>CustomerID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;A123&#39;</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 复合联接，根据 OrderID 和 CustomerID</span>
</span><span id=__span-51-40><a id=__codelineno-51-40 name=__codelineno-51-40 href=#__codelineno-51-40></a>
</span><span id=__span-51-41><a id=__codelineno-51-41 name=__codelineno-51-41 href=#__codelineno-51-41></a><span class=c1>-- 假设我们不仅想要按 OrderID 匹配，而且还想根据 ProductID 匹配，来确保订单和每个商品的详细信息正确匹配：</span>
</span><span id=__span-51-42><a id=__codelineno-51-42 name=__codelineno-51-42 href=#__codelineno-51-42></a>
</span><span id=__span-51-43><a id=__codelineno-51-43 name=__codelineno-51-43 href=#__codelineno-51-43></a><span class=k>SELECT</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>OrderID</span><span class=p>,</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>OrderDate</span><span class=p>,</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>ProductID</span><span class=p>,</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>Quantity</span><span class=p>,</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>Price</span>
</span><span id=__span-51-44><a id=__codelineno-51-44 name=__codelineno-51-44 href=#__codelineno-51-44></a><span class=k>FROM</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=n>ord</span>
</span><span id=__span-51-45><a id=__codelineno-51-45 name=__codelineno-51-45 href=#__codelineno-51-45></a><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>OrderDetails</span><span class=w> </span><span class=n>od</span>
</span><span id=__span-51-46><a id=__codelineno-51-46 name=__codelineno-51-46 href=#__codelineno-51-46></a><span class=w>    </span><span class=k>ON</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>OrderID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>OrderID</span>
</span><span id=__span-51-47><a id=__codelineno-51-47 name=__codelineno-51-47 href=#__codelineno-51-47></a><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>od</span><span class=p>.</span><span class=n>ProductID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>101</span><span class=p>;</span><span class=w>  </span><span class=c1>-- 按照 OrderID 和 ProductID 两列进行复合联接</span>
</span><span id=__span-51-48><a id=__codelineno-51-48 name=__codelineno-51-48 href=#__codelineno-51-48></a>
</span><span id=__span-51-49><a id=__codelineno-51-49 name=__codelineno-51-49 href=#__codelineno-51-49></a><span class=cm>/*</span>
</span><span id=__span-51-50><a id=__codelineno-51-50 name=__codelineno-51-50 href=#__codelineno-51-50></a><span class=cm>结果：</span>
</span><span id=__span-51-51><a id=__codelineno-51-51 name=__codelineno-51-51 href=#__codelineno-51-51></a><span class=cm>OrderID OrderDate   ProductID   Quantity    Price</span>
</span><span id=__span-51-52><a id=__codelineno-51-52 name=__codelineno-51-52 href=#__codelineno-51-52></a><span class=cm>1001    2025-01-01  101         2           15.5</span>
</span><span id=__span-51-53><a id=__codelineno-51-53 name=__codelineno-51-53 href=#__codelineno-51-53></a><span class=cm>*/</span>
</span></code></pre></div> <div class="language-sql highlight"><span class=filename>为什么说优化器不关心表的顺序？</span><pre><span></span><code><span id=__span-52-1><a id=__codelineno-52-1 name=__codelineno-52-1 href=#__codelineno-52-1></a><span class=c1>-- FROM 子句</span>
</span><span id=__span-52-2><a id=__codelineno-52-2 name=__codelineno-52-2 href=#__codelineno-52-2></a><span class=k>FROM</span><span class=w> </span><span class=n>HR</span><span class=p>.</span><span class=n>Employee</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>emp</span><span class=w> </span>
</span><span id=__span-52-3><a id=__codelineno-52-3 name=__codelineno-52-3 href=#__codelineno-52-3></a><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrder</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>ord</span>
</span><span id=__span-52-4><a id=__codelineno-52-4 name=__codelineno-52-4 href=#__codelineno-52-4></a>
</span><span id=__span-52-5><a id=__codelineno-52-5 name=__codelineno-52-5 href=#__codelineno-52-5></a><span class=cm>/*</span>
</span><span id=__span-52-6><a id=__codelineno-52-6 name=__codelineno-52-6 href=#__codelineno-52-6></a><span class=cm>SQL Server 的优化器会尝试选择最有效的查询执行计划来执行查询，考虑多种因素，如索引、表大小、统计信息等。在执行 INNER JOIN 时，理论上，表的顺序不会影响最终的结果，因为 INNER JOIN 是一个对称的操作——无论哪个表先被列出，最终都会执行相同的联接操作。然而，优化器可以根据实际情况选择最优的执行顺序。</span>
</span><span id=__span-52-7><a id=__codelineno-52-7 name=__codelineno-52-7 href=#__codelineno-52-7></a><span class=cm>*/</span>
</span><span id=__span-52-8><a id=__codelineno-52-8 name=__codelineno-52-8 href=#__codelineno-52-8></a>
</span><span id=__span-52-9><a id=__codelineno-52-9 name=__codelineno-52-9 href=#__codelineno-52-9></a><span class=c1>-- 即使我们交换 FROM 和 JOIN 的表顺序，SQL Server 会根据其优化规则来决定执行顺序：</span>
</span><span id=__span-52-10><a id=__codelineno-52-10 name=__codelineno-52-10 href=#__codelineno-52-10></a><span class=c1>-- 表顺序交换</span>
</span><span id=__span-52-11><a id=__codelineno-52-11 name=__codelineno-52-11 href=#__codelineno-52-11></a><span class=k>SELECT</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>FirstName</span><span class=p>,</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>Amount</span>
</span><span id=__span-52-12><a id=__codelineno-52-12 name=__codelineno-52-12 href=#__codelineno-52-12></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrder</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>ord</span>
</span><span id=__span-52-13><a id=__codelineno-52-13 name=__codelineno-52-13 href=#__codelineno-52-13></a><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>HR</span><span class=p>.</span><span class=n>Employee</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>emp</span>
</span><span id=__span-52-14><a id=__codelineno-52-14 name=__codelineno-52-14 href=#__codelineno-52-14></a><span class=w>    </span><span class=k>ON</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>EmployeeID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>EmployeeID</span><span class=p>;</span>
</span><span id=__span-52-15><a id=__codelineno-52-15 name=__codelineno-52-15 href=#__codelineno-52-15></a>
</span><span id=__span-52-16><a id=__codelineno-52-16 name=__codelineno-52-16 href=#__codelineno-52-16></a><span class=c1>-- 虽然表的顺序不同，但因为 INNER JOIN 是对称的，最终结果还是一样的。优化器会根据表的大小、索引等来选择最佳的执行顺序，而不一定是按你写的顺序来评估。</span>
</span></code></pre></div> <h2 id=_18>使用外部联接</h2> <div class="language-sql highlight"><pre><span></span><code><span id=__span-53-1><a id=__codelineno-53-1 name=__codelineno-53-1 href=#__codelineno-53-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>FirstName</span><span class=p>,</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>Amount</span>
</span><span id=__span-53-2><a id=__codelineno-53-2 name=__codelineno-53-2 href=#__codelineno-53-2></a><span class=k>FROM</span><span class=w> </span><span class=n>HR</span><span class=p>.</span><span class=n>Employee</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>emp</span>
</span><span id=__span-53-3><a id=__codelineno-53-3 name=__codelineno-53-3 href=#__codelineno-53-3></a><span class=k>LEFT</span><span class=w> </span><span class=k>OUTER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrder</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>ord</span>
</span><span id=__span-53-4><a id=__codelineno-53-4 name=__codelineno-53-4 href=#__codelineno-53-4></a><span class=w>    </span><span class=k>ON</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>EmployeeID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>EmployeeID</span><span class=p>;</span>
</span></code></pre></div> <p>本示例使用 LEFT OUTER JOIN 运算符，该运算符指示查询处理器保留左侧表（“HR.Employee”）中的所有行，并显示“Sales.SalesOrder”中匹配行的 Amount 值。 但是，无论员工是否取得了销售订单，都会返回所有员工。 对于没有匹配销售订单的员工，查询将返回 NULL 来代替 Amount 值。</p> <p><a class=glightbox href=../assets/T-SQL/outer-join-venn-diagram.avif data-type=image data-width=auto data-height=auto data-desc-position=bottom><img alt="A Venn diagram showing the outer join results of the Employee and SalesOrder sets" src=../assets/T-SQL/outer-join-venn-diagram.avif></a></p> <h3 id=outer-join>OUTER JOIN 语法</h3> <p>外部联接的表示方法是，在 OUTER JOIN 之前使用关键字 LEFT、RIGHT 或 FULL。 关键字的目的在于指示应保留哪个表（在关键字 JOIN 的哪一侧），并显示其所有行（匹配或不匹配）。</p> <p><u>使用 LEFT、RIGHT 或 FULL 定义联接时，可以省略 OUTER 关键字</u>，如下所示：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-54-1><a id=__codelineno-54-1 name=__codelineno-54-1 href=#__codelineno-54-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>FirstName</span><span class=p>,</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>Amount</span>
</span><span id=__span-54-2><a id=__codelineno-54-2 name=__codelineno-54-2 href=#__codelineno-54-2></a><span class=k>FROM</span><span class=w> </span><span class=n>HR</span><span class=p>.</span><span class=n>Employee</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>emp</span>
</span><span id=__span-54-3><a id=__codelineno-54-3 name=__codelineno-54-3 href=#__codelineno-54-3></a><span class=k>LEFT</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrder</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>ord</span>
</span><span id=__span-54-4><a id=__codelineno-54-4 name=__codelineno-54-4 href=#__codelineno-54-4></a><span class=w>    </span><span class=k>ON</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>EmployeeID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>EmployeeID</span><span class=p>;</span>
</span></code></pre></div> <ul> <li>但是，像 INNER 关键字一样，编写关于所使用的联接类型的显式代码通常会很有帮助。</li> </ul> <p>使用 OUTER JOIN 编写查询时，请考虑以下准则：</p> <ul> <li>如你所见，<u>表别名不仅是 SELECT 列表的首选，也是 ON 子句的首选</u>。</li> <li>与 INNER JOIN 一样，OUTER JOIN 可以针对单个匹配列执行，也可以针对多个匹配属性执行。</li> <li>与 INNER JOIN 不同，<u>在 FROM 子句中列出和连接表的顺序对 OUTER JOIN 很重要，因为它将决定选择 LEFT 还是 RIGHT 进行连接</u>。</li> <li>当存在 OUTER JOIN 时，多表联接会更加复杂。 如果随后将中间结果联接到第三个表，则 OUTER JOIN 的结果中存在 NULL 可能会导致问题。 第二个联接的谓词可能会将包含 NULL 的行筛选掉。</li> <li>要仅显示不存在匹配项的行，请在 OUTER JOIN 谓词之后的 WHERE 子句中添加 NULL 测试。</li> <li>FULL OUTER JOIN 很少使用。 它返回两个表之间的所有匹配行，第一个表中在第二个表内没有匹配项的所有行，以及第二个表中在第一个表内没有匹配项的所有行。</li> <li>如果没有 ORDER BY 子句，便无法预测行返回的顺序。 无法知道是先返回匹配的行，还是不匹配的行</li> </ul> <div class="language-sql highlight"><span class=filename>FULL OUTER JOIN和INNER JOIN</span><pre><span></span><code><span id=__span-55-1><a id=__codelineno-55-1 name=__codelineno-55-1 href=#__codelineno-55-1></a><span class=cm>/*</span>
</span><span id=__span-55-2><a id=__codelineno-55-2 name=__codelineno-55-2 href=#__codelineno-55-2></a><span class=cm>Employee 表：</span>
</span><span id=__span-55-3><a id=__codelineno-55-3 name=__codelineno-55-3 href=#__codelineno-55-3></a><span class=cm>EmployeeID  Name</span>
</span><span id=__span-55-4><a id=__codelineno-55-4 name=__codelineno-55-4 href=#__codelineno-55-4></a><span class=cm>1           John</span>
</span><span id=__span-55-5><a id=__codelineno-55-5 name=__codelineno-55-5 href=#__codelineno-55-5></a><span class=cm>2           Jane</span>
</span><span id=__span-55-6><a id=__codelineno-55-6 name=__codelineno-55-6 href=#__codelineno-55-6></a><span class=cm>3           Alice</span>
</span><span id=__span-55-7><a id=__codelineno-55-7 name=__codelineno-55-7 href=#__codelineno-55-7></a>
</span><span id=__span-55-8><a id=__codelineno-55-8 name=__codelineno-55-8 href=#__codelineno-55-8></a><span class=cm>SalesOrder 表：</span>
</span><span id=__span-55-9><a id=__codelineno-55-9 name=__codelineno-55-9 href=#__codelineno-55-9></a><span class=cm>OrderID EmployeeID  Amount</span>
</span><span id=__span-55-10><a id=__codelineno-55-10 name=__codelineno-55-10 href=#__codelineno-55-10></a><span class=cm>101     1           200</span>
</span><span id=__span-55-11><a id=__codelineno-55-11 name=__codelineno-55-11 href=#__codelineno-55-11></a><span class=cm>102     2           150</span>
</span><span id=__span-55-12><a id=__codelineno-55-12 name=__codelineno-55-12 href=#__codelineno-55-12></a><span class=cm>103     4           300</span>
</span><span id=__span-55-13><a id=__codelineno-55-13 name=__codelineno-55-13 href=#__codelineno-55-13></a><span class=cm>*/</span>
</span><span id=__span-55-14><a id=__codelineno-55-14 name=__codelineno-55-14 href=#__codelineno-55-14></a>
</span><span id=__span-55-15><a id=__codelineno-55-15 name=__codelineno-55-15 href=#__codelineno-55-15></a><span class=k>SELECT</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>Amount</span>
</span><span id=__span-55-16><a id=__codelineno-55-16 name=__codelineno-55-16 href=#__codelineno-55-16></a><span class=k>FROM</span><span class=w> </span><span class=n>Employee</span><span class=w> </span><span class=n>emp</span>
</span><span id=__span-55-17><a id=__codelineno-55-17 name=__codelineno-55-17 href=#__codelineno-55-17></a><span class=k>INNER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>SalesOrder</span><span class=w> </span><span class=n>ord</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>EmployeeID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>EmployeeID</span><span class=p>;</span>
</span><span id=__span-55-18><a id=__codelineno-55-18 name=__codelineno-55-18 href=#__codelineno-55-18></a>
</span><span id=__span-55-19><a id=__codelineno-55-19 name=__codelineno-55-19 href=#__codelineno-55-19></a><span class=cm>/*</span>
</span><span id=__span-55-20><a id=__codelineno-55-20 name=__codelineno-55-20 href=#__codelineno-55-20></a><span class=cm>返回结果：</span>
</span><span id=__span-55-21><a id=__codelineno-55-21 name=__codelineno-55-21 href=#__codelineno-55-21></a><span class=cm>Name    Amount</span>
</span><span id=__span-55-22><a id=__codelineno-55-22 name=__codelineno-55-22 href=#__codelineno-55-22></a><span class=cm>John    200</span>
</span><span id=__span-55-23><a id=__codelineno-55-23 name=__codelineno-55-23 href=#__codelineno-55-23></a><span class=cm>Jane    150</span>
</span><span id=__span-55-24><a id=__codelineno-55-24 name=__codelineno-55-24 href=#__codelineno-55-24></a><span class=cm>*/</span>
</span><span id=__span-55-25><a id=__codelineno-55-25 name=__codelineno-55-25 href=#__codelineno-55-25></a>
</span><span id=__span-55-26><a id=__codelineno-55-26 name=__codelineno-55-26 href=#__codelineno-55-26></a><span class=k>SELECT</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>Amount</span>
</span><span id=__span-55-27><a id=__codelineno-55-27 name=__codelineno-55-27 href=#__codelineno-55-27></a><span class=k>FROM</span><span class=w> </span><span class=n>Employee</span><span class=w> </span><span class=n>emp</span>
</span><span id=__span-55-28><a id=__codelineno-55-28 name=__codelineno-55-28 href=#__codelineno-55-28></a><span class=k>FULL</span><span class=w> </span><span class=k>OUTER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>SalesOrder</span><span class=w> </span><span class=n>ord</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>EmployeeID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ord</span><span class=p>.</span><span class=n>EmployeeID</span><span class=p>;</span>
</span><span id=__span-55-29><a id=__codelineno-55-29 name=__codelineno-55-29 href=#__codelineno-55-29></a>
</span><span id=__span-55-30><a id=__codelineno-55-30 name=__codelineno-55-30 href=#__codelineno-55-30></a><span class=cm>/*</span>
</span><span id=__span-55-31><a id=__codelineno-55-31 name=__codelineno-55-31 href=#__codelineno-55-31></a><span class=cm>返回结果：</span>
</span><span id=__span-55-32><a id=__codelineno-55-32 name=__codelineno-55-32 href=#__codelineno-55-32></a><span class=cm>Name    Amount</span>
</span><span id=__span-55-33><a id=__codelineno-55-33 name=__codelineno-55-33 href=#__codelineno-55-33></a><span class=cm>John    200</span>
</span><span id=__span-55-34><a id=__codelineno-55-34 name=__codelineno-55-34 href=#__codelineno-55-34></a><span class=cm>Jane    150</span>
</span><span id=__span-55-35><a id=__codelineno-55-35 name=__codelineno-55-35 href=#__codelineno-55-35></a><span class=cm>Alice   NULL</span>
</span><span id=__span-55-36><a id=__codelineno-55-36 name=__codelineno-55-36 href=#__codelineno-55-36></a><span class=cm>NULL    300</span>
</span><span id=__span-55-37><a id=__codelineno-55-37 name=__codelineno-55-37 href=#__codelineno-55-37></a><span class=cm>*/</span>
</span></code></pre></div> <h2 id=_19>使用交叉联接</h2> <p>交叉联接就是两个表的笛卡尔乘积。 <strong>你可以使用 ANSI SQL-89 语法，通过省略连接两个表的筛选器来创建交叉联接。 使用 ANSI-92 语法会有点困难</strong>；这很好，因为一般来说，交叉联接并不是你通常想要的。 使用 ANSI-92 语法，不太可能意外出现交叉联接。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-56-1><a id=__codelineno-56-1 name=__codelineno-56-1 href=#__codelineno-56-1></a><span class=cm>/*</span>
</span><span id=__span-56-2><a id=__codelineno-56-2 name=__codelineno-56-2 href=#__codelineno-56-2></a><span class=cm>Products 表：</span>
</span><span id=__span-56-3><a id=__codelineno-56-3 name=__codelineno-56-3 href=#__codelineno-56-3></a><span class=cm>ProductID   ProductName</span>
</span><span id=__span-56-4><a id=__codelineno-56-4 name=__codelineno-56-4 href=#__codelineno-56-4></a><span class=cm>1           Apple</span>
</span><span id=__span-56-5><a id=__codelineno-56-5 name=__codelineno-56-5 href=#__codelineno-56-5></a><span class=cm>2           Banana</span>
</span><span id=__span-56-6><a id=__codelineno-56-6 name=__codelineno-56-6 href=#__codelineno-56-6></a><span class=cm>3           Orange</span>
</span><span id=__span-56-7><a id=__codelineno-56-7 name=__codelineno-56-7 href=#__codelineno-56-7></a>
</span><span id=__span-56-8><a id=__codelineno-56-8 name=__codelineno-56-8 href=#__codelineno-56-8></a><span class=cm>Categories 表：</span>
</span><span id=__span-56-9><a id=__codelineno-56-9 name=__codelineno-56-9 href=#__codelineno-56-9></a><span class=cm>CategoryID  CategoryName</span>
</span><span id=__span-56-10><a id=__codelineno-56-10 name=__codelineno-56-10 href=#__codelineno-56-10></a><span class=cm>1           Fruit</span>
</span><span id=__span-56-11><a id=__codelineno-56-11 name=__codelineno-56-11 href=#__codelineno-56-11></a><span class=cm>2           Vegetable</span>
</span><span id=__span-56-12><a id=__codelineno-56-12 name=__codelineno-56-12 href=#__codelineno-56-12></a><span class=cm>*/</span>
</span><span id=__span-56-13><a id=__codelineno-56-13 name=__codelineno-56-13 href=#__codelineno-56-13></a>
</span><span id=__span-56-14><a id=__codelineno-56-14 name=__codelineno-56-14 href=#__codelineno-56-14></a><span class=c1>-- ANSI SQL-89 语法</span>
</span><span id=__span-56-15><a id=__codelineno-56-15 name=__codelineno-56-15 href=#__codelineno-56-15></a><span class=k>SELECT</span><span class=w> </span><span class=n>Products</span><span class=p>.</span><span class=n>ProductName</span><span class=p>,</span><span class=w> </span><span class=n>Categories</span><span class=p>.</span><span class=n>CategoryName</span>
</span><span id=__span-56-16><a id=__codelineno-56-16 name=__codelineno-56-16 href=#__codelineno-56-16></a><span class=k>FROM</span><span class=w> </span><span class=n>Products</span><span class=p>,</span><span class=w> </span><span class=n>Categories</span><span class=p>;</span>
</span><span id=__span-56-17><a id=__codelineno-56-17 name=__codelineno-56-17 href=#__codelineno-56-17></a>
</span><span id=__span-56-18><a id=__codelineno-56-18 name=__codelineno-56-18 href=#__codelineno-56-18></a><span class=c1>--  ANSI SQL-92 语法</span>
</span><span id=__span-56-19><a id=__codelineno-56-19 name=__codelineno-56-19 href=#__codelineno-56-19></a><span class=k>SELECT</span><span class=w> </span><span class=n>Products</span><span class=p>.</span><span class=n>ProductName</span><span class=p>,</span><span class=w> </span><span class=n>Categories</span><span class=p>.</span><span class=n>CategoryName</span>
</span><span id=__span-56-20><a id=__codelineno-56-20 name=__codelineno-56-20 href=#__codelineno-56-20></a><span class=k>FROM</span><span class=w> </span><span class=n>Products</span>
</span><span id=__span-56-21><a id=__codelineno-56-21 name=__codelineno-56-21 href=#__codelineno-56-21></a><span class=k>CROSS</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>Categories</span><span class=p>;</span>
</span><span id=__span-56-22><a id=__codelineno-56-22 name=__codelineno-56-22 href=#__codelineno-56-22></a>
</span><span id=__span-56-23><a id=__codelineno-56-23 name=__codelineno-56-23 href=#__codelineno-56-23></a><span class=cm>/*</span>
</span><span id=__span-56-24><a id=__codelineno-56-24 name=__codelineno-56-24 href=#__codelineno-56-24></a><span class=cm>返回的结果（笛卡尔积）：</span>
</span><span id=__span-56-25><a id=__codelineno-56-25 name=__codelineno-56-25 href=#__codelineno-56-25></a>
</span><span id=__span-56-26><a id=__codelineno-56-26 name=__codelineno-56-26 href=#__codelineno-56-26></a><span class=cm>ProductName CategoryName</span>
</span><span id=__span-56-27><a id=__codelineno-56-27 name=__codelineno-56-27 href=#__codelineno-56-27></a><span class=cm>Apple       Fruit</span>
</span><span id=__span-56-28><a id=__codelineno-56-28 name=__codelineno-56-28 href=#__codelineno-56-28></a><span class=cm>Apple       Vegetable</span>
</span><span id=__span-56-29><a id=__codelineno-56-29 name=__codelineno-56-29 href=#__codelineno-56-29></a><span class=cm>Banana      Fruit</span>
</span><span id=__span-56-30><a id=__codelineno-56-30 name=__codelineno-56-30 href=#__codelineno-56-30></a><span class=cm>Banana      Vegetable</span>
</span><span id=__span-56-31><a id=__codelineno-56-31 name=__codelineno-56-31 href=#__codelineno-56-31></a><span class=cm>Orange      Fruit</span>
</span><span id=__span-56-32><a id=__codelineno-56-32 name=__codelineno-56-32 href=#__codelineno-56-32></a><span class=cm>Orange      Vegetable</span>
</span><span id=__span-56-33><a id=__codelineno-56-33 name=__codelineno-56-33 href=#__codelineno-56-33></a><span class=cm>*/</span>
</span></code></pre></div> <p>要显式创建笛卡尔乘积，请使用 CROSS JOIN 运算符。</p> <p>此运算会创建包含输入行的所有可能组合的结果集：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-57-1><a id=__codelineno-57-1 name=__codelineno-57-1 href=#__codelineno-57-1></a><span class=k>SELECT</span><span class=w> </span><span class=o>&lt;</span><span class=n>select_list</span><span class=o>&gt;</span>
</span><span id=__span-57-2><a id=__codelineno-57-2 name=__codelineno-57-2 href=#__codelineno-57-2></a><span class=k>FROM</span><span class=w> </span><span class=n>table1</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>t1</span>
</span><span id=__span-57-3><a id=__codelineno-57-3 name=__codelineno-57-3 href=#__codelineno-57-3></a><span class=k>CROSS</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>table2</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>t2</span><span class=p>;</span>
</span></code></pre></div> <p>虽然此结果通常不是所需的输出，但是编写显式的 CROSS JOIN 还是有以下一些实际应用：</p> <ul> <li>创建数字表，范围内的每个可能值均用一行表示。</li> <li>生成大量数据以进行测试。 当与自身进行交叉联接时，一个只有 100 行的表可以轻松生成 10,000 个输出行，而你几乎不需要执行任何操作。</li> </ul> <p>```sql title = "实际应用" -- 数字表 是一个仅包含数字的表，通常用于生成一个有序的数字序列，或者用于执行某些特定的查询（比如生成日期序列、范围数字等）。它本身不包含业务数据，仅仅存储数字。</p> <p>-- 你可以使用 CROSS JOIN 来生成一个数字表，而不需要手动列出每个数字。</p> <p>-- 示例：生成数字 1 到 100 -- 首先，我们创建两个非常简单的表（table1 和 table2），这两个表分别包含 1 到 10 的数字。</p> <p>-- 创建两个小表，每个表包含数字 1 到 10 SELECT 1 AS num UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10;</p> <p>-- 然后，我们可以使用 CROSS JOIN 将这两个表结合起来。由于 CROSS JOIN 会生成两个表的笛卡尔积，两个包含 10 个数字的表会生成 100 个结果行。 SELECT t1.num + t2.num - 1 AS number FROM (SELECT 1 AS num UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10) AS t1 CROSS JOIN (SELECT 1 AS num UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10) AS t2;</p> <p>/<em> 结果集： number 1 2 3 4 ... 100 </em>/</p> <p>-- 假设你想要生成一个日期范围从 2023-01-01 到 2023-12-31，可以借助 CROSS JOIN 来生成日期序列。你可以使用数字表（如上例）与日期函数配合，从而创建日期。 WITH Numbers AS ( SELECT 1 AS num UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 UNION ALL SELECT 9 UNION ALL SELECT 10 -- 重复多次以生成更大的数字范围 ) SELECT DATEADD(DAY, num - 1, '2023-01-01') AS generated_date FROM Numbers CROSS JOIN Numbers WHERE num &lt;= 365; -- 控制最大日期为一年内的所有日期</p> <p>/<em> 这个查询会生成 2023 年所有日期，从 2023-01-01 到 2023-12-31。</em>/</p> <p>-- 你也可以使用 CROSS JOIN 生成大量测试数据。例如，如果你需要生成多个产品和多个客户的所有组合来进行测试，你可以将两个表交叉连接来生成所有可能的组合。</p> <p>SELECT p.ProductName, c.CustomerName FROM Products AS p CROSS JOIN Customers AS c;</p> <p>/<em> 这会生成所有产品和客户的组合，通常用于生成测试数据。</em>/ <br> <div class="language-text highlight"><pre><span></span><code><span id=__span-58-1><a id=__codelineno-58-1 name=__codelineno-58-1 href=#__codelineno-58-1></a>### CROSS JOIN 语法
</span><span id=__span-58-2><a id=__codelineno-58-2 name=__codelineno-58-2 href=#__codelineno-58-2></a>
</span><span id=__span-58-3><a id=__codelineno-58-3 name=__codelineno-58-3 href=#__codelineno-58-3></a>使用 CROSS JOIN 编写查询时，请考虑以下准则：
</span><span id=__span-58-4><a id=__codelineno-58-4 name=__codelineno-58-4 href=#__codelineno-58-4></a>
</span><span id=__span-58-5><a id=__codelineno-58-5 name=__codelineno-58-5 href=#__codelineno-58-5></a>- 没有执行行匹配，因此不使用 ON 子句。 （**将 ON 子句与 CROSS JOIN 一起使用是错误的。**）
</span><span id=__span-58-6><a id=__codelineno-58-6 name=__codelineno-58-6 href=#__codelineno-58-6></a>- 要使用 ANSI SQL-92 语法，请使用 CROSS JOIN 运算符分隔输入表名称。
</span><span id=__span-58-7><a id=__codelineno-58-7 name=__codelineno-58-7 href=#__codelineno-58-7></a>
</span><span id=__span-58-8><a id=__codelineno-58-8 name=__codelineno-58-8 href=#__codelineno-58-8></a>以下查询是使用 CROSS JOIN 创建员工和产品的所有组合的示例：
</span><span id=__span-58-9><a id=__codelineno-58-9 name=__codelineno-58-9 href=#__codelineno-58-9></a>
</span><span id=__span-58-10><a id=__codelineno-58-10 name=__codelineno-58-10 href=#__codelineno-58-10></a>```sql
</span><span id=__span-58-11><a id=__codelineno-58-11 name=__codelineno-58-11 href=#__codelineno-58-11></a>SELECT emp.FirstName, prd.Name
</span><span id=__span-58-12><a id=__codelineno-58-12 name=__codelineno-58-12 href=#__codelineno-58-12></a>FROM HR.Employee AS emp
</span><span id=__span-58-13><a id=__codelineno-58-13 name=__codelineno-58-13 href=#__codelineno-58-13></a>CROSS JOIN Production.Product AS prd;
</span></code></pre></div></p> <h2 id=_20>使用自联接</h2> <div class="language-sql highlight"><pre><span></span><code><span id=__span-59-1><a id=__codelineno-59-1 name=__codelineno-59-1 href=#__codelineno-59-1></a><span class=c1>-- 到目前为止，我们使用的联接涉及不同的表。 在某些情况下，你可能需要检索表中的行，并将其与同一表中的其他行进行比较。 例如，在人力资源应用程序中，“Employee”表可能包含有关每个员工的经理的信息，并将经理的 ID 存储在员工所在的那行中。 每个经理也列为一名员工。</span>
</span><span id=__span-59-2><a id=__codelineno-59-2 name=__codelineno-59-2 href=#__codelineno-59-2></a>
</span><span id=__span-59-3><a id=__codelineno-59-3 name=__codelineno-59-3 href=#__codelineno-59-3></a><span class=cm>/*</span>
</span><span id=__span-59-4><a id=__codelineno-59-4 name=__codelineno-59-4 href=#__codelineno-59-4></a><span class=cm>EmployeeID          FirstName           ManagerID</span>
</span><span id=__span-59-5><a id=__codelineno-59-5 name=__codelineno-59-5 href=#__codelineno-59-5></a>
</span><span id=__span-59-6><a id=__codelineno-59-6 name=__codelineno-59-6 href=#__codelineno-59-6></a><span class=cm>1                   Dan                 Null</span>
</span><span id=__span-59-7><a id=__codelineno-59-7 name=__codelineno-59-7 href=#__codelineno-59-7></a>
</span><span id=__span-59-8><a id=__codelineno-59-8 name=__codelineno-59-8 href=#__codelineno-59-8></a><span class=cm>2                   Aisha               1</span>
</span><span id=__span-59-9><a id=__codelineno-59-9 name=__codelineno-59-9 href=#__codelineno-59-9></a>
</span><span id=__span-59-10><a id=__codelineno-59-10 name=__codelineno-59-10 href=#__codelineno-59-10></a><span class=cm>3                   Rosie               1</span>
</span><span id=__span-59-11><a id=__codelineno-59-11 name=__codelineno-59-11 href=#__codelineno-59-11></a>
</span><span id=__span-59-12><a id=__codelineno-59-12 name=__codelineno-59-12 href=#__codelineno-59-12></a><span class=cm>4                   Naomi               3</span>
</span><span id=__span-59-13><a id=__codelineno-59-13 name=__codelineno-59-13 href=#__codelineno-59-13></a><span class=cm>*/</span>
</span><span id=__span-59-14><a id=__codelineno-59-14 name=__codelineno-59-14 href=#__codelineno-59-14></a>
</span><span id=__span-59-15><a id=__codelineno-59-15 name=__codelineno-59-15 href=#__codelineno-59-15></a><span class=c1>-- 要检索员工信息并将其与相关的经理进行匹配，可以在查询中使用该表两次，并将其与自身进行联接以实现查询目的。</span>
</span><span id=__span-59-16><a id=__codelineno-59-16 name=__codelineno-59-16 href=#__codelineno-59-16></a>
</span><span id=__span-59-17><a id=__codelineno-59-17 name=__codelineno-59-17 href=#__codelineno-59-17></a><span class=k>SELECT</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>FirstName</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Employee</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-59-18><a id=__codelineno-59-18 name=__codelineno-59-18 href=#__codelineno-59-18></a><span class=w>       </span><span class=n>mgr</span><span class=p>.</span><span class=n>FirstName</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>Manager</span>
</span><span id=__span-59-19><a id=__codelineno-59-19 name=__codelineno-59-19 href=#__codelineno-59-19></a><span class=k>FROM</span><span class=w> </span><span class=n>HR</span><span class=p>.</span><span class=n>Employee</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>emp</span>
</span><span id=__span-59-20><a id=__codelineno-59-20 name=__codelineno-59-20 href=#__codelineno-59-20></a><span class=k>LEFT</span><span class=w> </span><span class=k>OUTER</span><span class=w> </span><span class=k>JOIN</span><span class=w> </span><span class=n>HR</span><span class=p>.</span><span class=n>Employee</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>mgr</span>
</span><span id=__span-59-21><a id=__codelineno-59-21 name=__codelineno-59-21 href=#__codelineno-59-21></a><span class=w>  </span><span class=k>ON</span><span class=w> </span><span class=n>emp</span><span class=p>.</span><span class=n>ManagerID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mgr</span><span class=p>.</span><span class=n>EmployeeID</span><span class=p>;</span>
</span><span id=__span-59-22><a id=__codelineno-59-22 name=__codelineno-59-22 href=#__codelineno-59-22></a>
</span><span id=__span-59-23><a id=__codelineno-59-23 name=__codelineno-59-23 href=#__codelineno-59-23></a><span class=c1>-- 在该查询的结果中，每名员工一行，其中包含其经理的姓名。 公司的 CEO 没有经理。 为了在结果中包括 CEO，将使用外部联接，并且对于“ManagerID”字段没有匹配的“EmployeeID”字段的行，经理姓名将返回 NULL。</span>
</span><span id=__span-59-24><a id=__codelineno-59-24 name=__codelineno-59-24 href=#__codelineno-59-24></a>
</span><span id=__span-59-25><a id=__codelineno-59-25 name=__codelineno-59-25 href=#__codelineno-59-25></a><span class=cm>/*</span>
</span><span id=__span-59-26><a id=__codelineno-59-26 name=__codelineno-59-26 href=#__codelineno-59-26></a><span class=cm>Employee       Manager</span>
</span><span id=__span-59-27><a id=__codelineno-59-27 name=__codelineno-59-27 href=#__codelineno-59-27></a>
</span><span id=__span-59-28><a id=__codelineno-59-28 name=__codelineno-59-28 href=#__codelineno-59-28></a><span class=cm>Dan            Null</span>
</span><span id=__span-59-29><a id=__codelineno-59-29 name=__codelineno-59-29 href=#__codelineno-59-29></a>
</span><span id=__span-59-30><a id=__codelineno-59-30 name=__codelineno-59-30 href=#__codelineno-59-30></a><span class=cm>Aisha          Dan</span>
</span><span id=__span-59-31><a id=__codelineno-59-31 name=__codelineno-59-31 href=#__codelineno-59-31></a>
</span><span id=__span-59-32><a id=__codelineno-59-32 name=__codelineno-59-32 href=#__codelineno-59-32></a><span class=cm>Rosie          Dan</span>
</span><span id=__span-59-33><a id=__codelineno-59-33 name=__codelineno-59-33 href=#__codelineno-59-33></a>
</span><span id=__span-59-34><a id=__codelineno-59-34 name=__codelineno-59-34 href=#__codelineno-59-34></a><span class=cm>Naomi          Rosie</span>
</span><span id=__span-59-35><a id=__codelineno-59-35 name=__codelineno-59-35 href=#__codelineno-59-35></a><span class=cm>*/</span>
</span></code></pre></div> <p>在其他情况下，你可能希望将表中的行与同一表中的其他行进行比较。 如你所见，使用 T-SQL 比较同一行中的列非常容易，但是比较不同行（例如存储开始时间的行，以及同一表中存储相应停止时间的另一行）中的值的方法就不那么明显了。 对于这些类型的查询，自联接这一技术会很有用。</p> <p>要完成此类任务，应考虑以下准则：</p> <ul> <li>在 FROM 子句中定义同一表的两个实例，并根据需要使用内部或外部联接来联接它们。</li> <li>使用表别名来区分同一个表的两个实例。</li> <li>使用 ON 子句来提供筛选器，将表的一个实例的列与该表的另一个实例的列进行比较。</li> </ul> <p><a href=https://microsoftlearning.github.io/dp-080-Transact-SQL/Instructions/Labs/03a-joins.html>练习 - 使用联接查询多个表</a></p> <p>使用 <strong>LEFT</strong>（或 <strong>RIGHT）</strong> 关键字会自动将联接标识为 <strong>OUTER</strong> 联接。</p> <p>为什么所有后续的外部连接必须具有相同的方向（LEFT 或 RIGHT）？</p> <ul> <li><strong>一致的方向</strong>（<code>LEFT</code> 或 <code>RIGHT</code>）能够保持查询的逻辑一致性，确保结果集中的数据按预期返回。</li> <li><strong>不同方向的外部连接</strong> 可能导致数据重复、遗漏或结果混乱，因此最好在查询中保持方向一致，避免让查询变得复杂并难以预测。</li> </ul> <p><strong>*自联接实际上不是一种特定类型的联接，而是一种技术，用于通过定义表的两个实例（每个实例都有自己的别名）将表联接到自身。</strong></p> <p>挑战三有点绕</p> <p><a href=https://learn.microsoft.com/zh-cn/shows/programming-databases-with-t-sql-for-beginners/combining-multiple-tables-with-joins-in-transact-sql-4-of-7-programming-databases-with-t-sql-for-beginners>将多个表与 Transact-SQL 中的 JOINS 组合（第 4 部分（共 7 部分） |使用 T-SQL 为初学者编程数据库</a></p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-60-1><a id=__codelineno-60-1 name=__codelineno-60-1 href=#__codelineno-60-1></a><span class=k>INSERT</span><span class=w> </span><span class=k>INTO</span><span class=w> </span><span class=o>#</span><span class=n>Employees</span><span class=err>（</span><span class=p>[</span><span class=n>Name</span><span class=p>],</span><span class=w> </span><span class=n>Title</span><span class=p>,</span><span class=w> </span><span class=n>Manager</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-60-2><a id=__codelineno-60-2 name=__codelineno-60-2 href=#__codelineno-60-2></a><span class=c1>-- # 表示临时表，用于创建局部临时表，在会话结束后会自动删除。</span>
</span><span id=__span-60-3><a id=__codelineno-60-3 name=__codelineno-60-3 href=#__codelineno-60-3></a><span class=c1>-- [] 用于标识符，包裹表名或列名等数据库对象，防止它们与 SQL 保留字或特殊字符冲突。</span>
</span></code></pre></div> <hr> <h2 id=_21>了解子查询</h2> <p>子查询是指嵌套在另一个查询中的 SELECT 语句。 <u>通过将一个查询嵌套在另一个查询中，可增强在 T-SQL 中创建有效查询的能力</u>。 通常，子查询将计算一次，并将结果提供给外部查询。</p> <h3 id=_22>使用子查询</h3> <p><u>子查询是指嵌套或嵌入在另一个查询中的 SELECT 语句。 嵌套的查询（即子查询）被称为内部查询。 包含嵌套查询的查询是外部查询。</u></p> <p>子查询的目的是向外部查询返回结果。 结果的形式决定子查询是标量子查询还是多值子查询：</p> <ul> <li>标量子查询返回单个值。 外部查询必须处理单个结果。</li> <li>多值子查询返回的结果很像是单列表格。 外部查询必须能够处理多个值。</li> </ul> <div class="language-sql highlight"><span class=filename>标量子查询和多值子查询</span><pre><span></span><code><span id=__span-61-1><a id=__codelineno-61-1 name=__codelineno-61-1 href=#__codelineno-61-1></a><span class=c1>-- 标量子查询 返回单个值，外部查询必须处理这个单个结果。通常用于 SELECT、WHERE、HAVING 或 ORDER BY 子句中，并且子查询必须保证只返回一行一列，否则会报错。</span>
</span><span id=__span-61-2><a id=__codelineno-61-2 name=__codelineno-61-2 href=#__codelineno-61-2></a><span class=k>SELECT</span><span class=w> </span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>ListPrice</span>
</span><span id=__span-61-3><a id=__codelineno-61-3 name=__codelineno-61-3 href=#__codelineno-61-3></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-61-4><a id=__codelineno-61-4 name=__codelineno-61-4 href=#__codelineno-61-4></a><span class=k>WHERE</span><span class=w> </span><span class=n>ListPrice</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>ListPrice</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span><span class=p>);</span>
</span><span id=__span-61-5><a id=__codelineno-61-5 name=__codelineno-61-5 href=#__codelineno-61-5></a>
</span><span id=__span-61-6><a id=__codelineno-61-6 name=__codelineno-61-6 href=#__codelineno-61-6></a><span class=c1>-- 子查询：(SELECT MAX(ListPrice) FROM SalesLT.Product) 只返回一个值，即最高价格。</span>
</span><span id=__span-61-7><a id=__codelineno-61-7 name=__codelineno-61-7 href=#__codelineno-61-7></a><span class=c1>-- 外部查询：使用 WHERE ListPrice = 最高价格 过滤产品，找到最高价的产品。</span>
</span><span id=__span-61-8><a id=__codelineno-61-8 name=__codelineno-61-8 href=#__codelineno-61-8></a>
</span><span id=__span-61-9><a id=__codelineno-61-9 name=__codelineno-61-9 href=#__codelineno-61-9></a><span class=c1>-- 多值子查询 返回多行单列（相当于一个单列表格），外部查询必须能够处理多个值。常用于 IN、EXISTS、ANY、ALL 语句。</span>
</span><span id=__span-61-10><a id=__codelineno-61-10 name=__codelineno-61-10 href=#__codelineno-61-10></a><span class=k>SELECT</span><span class=w> </span><span class=n>ProductID</span><span class=p>,</span><span class=w> </span><span class=n>Name</span>
</span><span id=__span-61-11><a id=__codelineno-61-11 name=__codelineno-61-11 href=#__codelineno-61-11></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-61-12><a id=__codelineno-61-12 name=__codelineno-61-12 href=#__codelineno-61-12></a><span class=k>WHERE</span><span class=w> </span><span class=n>ProductID</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=n>ProductID</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>Color</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Red&#39;</span><span class=p>);</span>
</span><span id=__span-61-13><a id=__codelineno-61-13 name=__codelineno-61-13 href=#__codelineno-61-13></a>
</span><span id=__span-61-14><a id=__codelineno-61-14 name=__codelineno-61-14 href=#__codelineno-61-14></a><span class=c1>-- 子查询：(SELECT ProductID FROM SalesLT.Product WHERE Color = &#39;Red&#39;) 可能返回多个 ProductID（多个值）。</span>
</span><span id=__span-61-15><a id=__codelineno-61-15 name=__codelineno-61-15 href=#__codelineno-61-15></a><span class=c1>-- 外部查询：使用 IN 关键字，匹配 ProductID 是否属于子查询返回的结果。</span>
</span></code></pre></div> <p>除标量子查询和多值子查询选项之外，子查询还可以是自包含子查询，或外部查询的关联子查询：</p> <ul> <li>自包含子查询可以作为独立查询写入，不依赖于外部查询。 在外部查询运行时，自包含子查询将处理一次，并将其结果传递给该外部查询。</li> <li>关联子查询会引用外部查询中的一个或多个列，因此依赖于外部查询。 关联子查询不能与外部查询分开运行。</li> </ul> <div class="language-sql highlight"><span class=filename>自包含子查询和关联子查询</span><pre><span></span><code><span id=__span-62-1><a id=__codelineno-62-1 name=__codelineno-62-1 href=#__codelineno-62-1></a><span class=c1>-- 自包含子查询 可以独立运行，不依赖外部查询中的任何列。它在外部查询执行前仅执行一次，然后将结果传递给外部查询。</span>
</span><span id=__span-62-2><a id=__codelineno-62-2 name=__codelineno-62-2 href=#__codelineno-62-2></a><span class=k>SELECT</span><span class=w> </span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>ListPrice</span>
</span><span id=__span-62-3><a id=__codelineno-62-3 name=__codelineno-62-3 href=#__codelineno-62-3></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span>
</span><span id=__span-62-4><a id=__codelineno-62-4 name=__codelineno-62-4 href=#__codelineno-62-4></a><span class=k>WHERE</span><span class=w> </span><span class=n>ListPrice</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>ListPrice</span><span class=p>)</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span><span class=w> </span><span class=k>WHERE</span><span class=w> </span><span class=n>Color</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Red&#39;</span><span class=p>);</span>
</span><span id=__span-62-5><a id=__codelineno-62-5 name=__codelineno-62-5 href=#__codelineno-62-5></a>
</span><span id=__span-62-6><a id=__codelineno-62-6 name=__codelineno-62-6 href=#__codelineno-62-6></a><span class=c1>-- 子查询 (SELECT MAX(ListPrice) FROM SalesLT.Product WHERE Color = &#39;Red&#39;)：该查询可以单独执行，它计算所有红色产品的最高价格。</span>
</span><span id=__span-62-7><a id=__codelineno-62-7 name=__codelineno-62-7 href=#__codelineno-62-7></a><span class=c1>-- 外部查询 WHERE ListPrice &gt; 最高红色产品价格：过滤 ListPrice 高于红色产品最高价的产品。</span>
</span><span id=__span-62-8><a id=__codelineno-62-8 name=__codelineno-62-8 href=#__codelineno-62-8></a>
</span><span id=__span-62-9><a id=__codelineno-62-9 name=__codelineno-62-9 href=#__codelineno-62-9></a><span class=c1>-- 关联子查询 不能独立运行，它依赖外部查询中的列。子查询对外部查询中的每一行执行一次。</span>
</span><span id=__span-62-10><a id=__codelineno-62-10 name=__codelineno-62-10 href=#__codelineno-62-10></a><span class=k>SELECT</span><span class=w> </span><span class=n>p1</span><span class=p>.</span><span class=n>Name</span><span class=p>,</span><span class=w> </span><span class=n>p1</span><span class=p>.</span><span class=n>Color</span><span class=p>,</span><span class=w> </span><span class=n>p1</span><span class=p>.</span><span class=n>ListPrice</span>
</span><span id=__span-62-11><a id=__codelineno-62-11 name=__codelineno-62-11 href=#__codelineno-62-11></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span><span class=w> </span><span class=n>p1</span>
</span><span id=__span-62-12><a id=__codelineno-62-12 name=__codelineno-62-12 href=#__codelineno-62-12></a><span class=k>WHERE</span><span class=w> </span><span class=n>p1</span><span class=p>.</span><span class=n>ListPrice</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-62-13><a id=__codelineno-62-13 name=__codelineno-62-13 href=#__codelineno-62-13></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=k>AVG</span><span class=p>(</span><span class=n>p2</span><span class=p>.</span><span class=n>ListPrice</span><span class=p>)</span>
</span><span id=__span-62-14><a id=__codelineno-62-14 name=__codelineno-62-14 href=#__codelineno-62-14></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Product</span><span class=w> </span><span class=n>p2</span>
</span><span id=__span-62-15><a id=__codelineno-62-15 name=__codelineno-62-15 href=#__codelineno-62-15></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>p1</span><span class=p>.</span><span class=n>Color</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p2</span><span class=p>.</span><span class=n>Color</span>
</span><span id=__span-62-16><a id=__codelineno-62-16 name=__codelineno-62-16 href=#__codelineno-62-16></a><span class=p>);</span>
</span><span id=__span-62-17><a id=__codelineno-62-17 name=__codelineno-62-17 href=#__codelineno-62-17></a><span class=c1>-- 子查询 (SELECT AVG(p2.ListPrice) FROM SalesLT.Product p2 WHERE p1.Color = p2.Color)：</span>
</span><span id=__span-62-18><a id=__codelineno-62-18 name=__codelineno-62-18 href=#__codelineno-62-18></a><span class=c1>-- 它依赖外部查询的 p1.Color，计算相同 Color 的产品的平均价格。</span>
</span><span id=__span-62-19><a id=__codelineno-62-19 name=__codelineno-62-19 href=#__codelineno-62-19></a><span class=c1>-- 不能独立执行，因为 p1.Color 只有在外部查询运行时才有值。</span>
</span><span id=__span-62-20><a id=__codelineno-62-20 name=__codelineno-62-20 href=#__codelineno-62-20></a>
</span><span id=__span-62-21><a id=__codelineno-62-21 name=__codelineno-62-21 href=#__codelineno-62-21></a><span class=c1>-- 外部查询 WHERE p1.ListPrice &gt; 该颜色的平均价格：</span>
</span><span id=__span-62-22><a id=__codelineno-62-22 name=__codelineno-62-22 href=#__codelineno-62-22></a><span class=c1>-- 逐行检查 p1.ListPrice 是否高于同色产品的平均价格。</span>
</span></code></pre></div> <h2 id=_23>使用标量或多值子查询</h2> <p><u>标量子查询是外部查询中的内部 SELECT 语句，写入后可返回单个值</u>。 标量子查询可用于 T-SQL 语句中允许单值表达式的任何位置，例如 SELECT 子句、WHERE 子句、HAVING 子句，甚至是 FROM 子句。 此外，它们还可用于 UPDATE 或 DELETE 等数据修改语句。</p> <p>顾名思义，多值子查询可以返回多个行。 不过，它们仍会返回单列。</p> <h3 id=_24>标量子查询</h3> <p>假设要检索上次下单的详细信息，假定它是具有最高“SalesOrderID”值的订单。</p> <p>要查找最高的“SalesOrderID”值，可以使用以下查询：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-63-1><a id=__codelineno-63-1 name=__codelineno-63-1 href=#__codelineno-63-1></a><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>SalesOrderID</span><span class=p>)</span>
</span><span id=__span-63-2><a id=__codelineno-63-2 name=__codelineno-63-2 href=#__codelineno-63-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrderHeader</span>
</span></code></pre></div> <p>此查询将返回一个指示“SalesOrderHeader”表中“OrderID”最高值的值。</p> <p>要获取该订单的详细信息，可能需要根据上述查询返回的任何值筛选“SalesOrderDetails”表。 通过将检索最高“SalesOrderID”的查询嵌套在检索订单详细信息的查询的 WHERE 子句中，可以完成此项任务。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-64-1><a id=__codelineno-64-1 name=__codelineno-64-1 href=#__codelineno-64-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>SalesOrderID</span><span class=p>,</span><span class=w> </span><span class=n>ProductID</span><span class=p>,</span><span class=w> </span><span class=n>OrderQty</span>
</span><span id=__span-64-2><a id=__codelineno-64-2 name=__codelineno-64-2 href=#__codelineno-64-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrderDetail</span>
</span><span id=__span-64-3><a id=__codelineno-64-3 name=__codelineno-64-3 href=#__codelineno-64-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>SalesOrderID</span><span class=w> </span><span class=o>=</span><span class=w> </span>
</span><span id=__span-64-4><a id=__codelineno-64-4 name=__codelineno-64-4 href=#__codelineno-64-4></a><span class=w>   </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>SalesOrderID</span><span class=p>)</span>
</span><span id=__span-64-5><a id=__codelineno-64-5 name=__codelineno-64-5 href=#__codelineno-64-5></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrderHeader</span><span class=p>);</span>
</span></code></pre></div> <p>要写入标量子查询，请考虑以下准则：</p> <ul> <li>要将查询表示为子查询，请用括号将其括起来。</li> <li><strong>Transact-SQL 中支持多级子查询。 在此模块中，我们仅考虑两级查询（一个外部查询中有一个内部查询），但最多支持 32 个级别</strong>。</li> <li>如果子查询没有返回任何行（空集），则子查询的结果是 NULL。 <u>如果方案中可以不返回任何行，则应确保外部查询除处理其他预期结果之外，还能正常处理 NUL</u>L。</li> <li><u>内部查询一般应返回单列</u>。 在子查询中选择多个列几乎都会出错。 唯一例外是，<u>使用 EXISTS 关键字引入子查询时</u>。</li> </ul> <div class="language-sql highlight"><pre><span></span><code><span id=__span-65-1><a id=__codelineno-65-1 name=__codelineno-65-1 href=#__codelineno-65-1></a><span class=c1>-- 子查询没有返回任何行（空集）时的处理</span>
</span><span id=__span-65-2><a id=__codelineno-65-2 name=__codelineno-65-2 href=#__codelineno-65-2></a>
</span><span id=__span-65-3><a id=__codelineno-65-3 name=__codelineno-65-3 href=#__codelineno-65-3></a><span class=k>SELECT</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CustomerName</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-65-4><a id=__codelineno-65-4 name=__codelineno-65-4 href=#__codelineno-65-4></a><span class=w>       </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=n>TOP</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>Amount</span>
</span><span id=__span-65-5><a id=__codelineno-65-5 name=__codelineno-65-5 href=#__codelineno-65-5></a><span class=w>        </span><span class=k>FROM</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=n>o</span>
</span><span id=__span-65-6><a id=__codelineno-65-6 name=__codelineno-65-6 href=#__codelineno-65-6></a><span class=w>        </span><span class=k>WHERE</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>CustomerID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CustomerID</span>
</span><span id=__span-65-7><a id=__codelineno-65-7 name=__codelineno-65-7 href=#__codelineno-65-7></a><span class=w>        </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>OrderDate</span><span class=w> </span><span class=k>DESC</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>LastOrderAmount</span>
</span><span id=__span-65-8><a id=__codelineno-65-8 name=__codelineno-65-8 href=#__codelineno-65-8></a><span class=k>FROM</span><span class=w> </span><span class=n>Customers</span><span class=w> </span><span class=k>c</span><span class=p>;</span>
</span><span id=__span-65-9><a id=__codelineno-65-9 name=__codelineno-65-9 href=#__codelineno-65-9></a>
</span><span id=__span-65-10><a id=__codelineno-65-10 name=__codelineno-65-10 href=#__codelineno-65-10></a><span class=c1>-- 改进：用 COALESCE 处理 NULL</span>
</span><span id=__span-65-11><a id=__codelineno-65-11 name=__codelineno-65-11 href=#__codelineno-65-11></a>
</span><span id=__span-65-12><a id=__codelineno-65-12 name=__codelineno-65-12 href=#__codelineno-65-12></a><span class=k>SELECT</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CustomerName</span><span class=p>,</span><span class=w> </span>
</span><span id=__span-65-13><a id=__codelineno-65-13 name=__codelineno-65-13 href=#__codelineno-65-13></a><span class=w>       </span><span class=k>COALESCE</span><span class=p>(</span>
</span><span id=__span-65-14><a id=__codelineno-65-14 name=__codelineno-65-14 href=#__codelineno-65-14></a><span class=w>           </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=n>TOP</span><span class=w> </span><span class=mi>1</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>Amount</span>
</span><span id=__span-65-15><a id=__codelineno-65-15 name=__codelineno-65-15 href=#__codelineno-65-15></a><span class=w>            </span><span class=k>FROM</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=n>o</span>
</span><span id=__span-65-16><a id=__codelineno-65-16 name=__codelineno-65-16 href=#__codelineno-65-16></a><span class=w>            </span><span class=k>WHERE</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>CustomerID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CustomerID</span>
</span><span id=__span-65-17><a id=__codelineno-65-17 name=__codelineno-65-17 href=#__codelineno-65-17></a><span class=w>            </span><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>OrderDate</span><span class=w> </span><span class=k>DESC</span><span class=p>),</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>LastOrderAmount</span>
</span><span id=__span-65-18><a id=__codelineno-65-18 name=__codelineno-65-18 href=#__codelineno-65-18></a><span class=k>FROM</span><span class=w> </span><span class=n>Customers</span><span class=w> </span><span class=k>c</span><span class=p>;</span>
</span><span id=__span-65-19><a id=__codelineno-65-19 name=__codelineno-65-19 href=#__codelineno-65-19></a>
</span><span id=__span-65-20><a id=__codelineno-65-20 name=__codelineno-65-20 href=#__codelineno-65-20></a><span class=cm>/*</span>
</span><span id=__span-65-21><a id=__codelineno-65-21 name=__codelineno-65-21 href=#__codelineno-65-21></a><span class=cm>输出示例：</span>
</span><span id=__span-65-22><a id=__codelineno-65-22 name=__codelineno-65-22 href=#__codelineno-65-22></a><span class=cm>CustomerName    LastOrderAmount</span>
</span><span id=__span-65-23><a id=__codelineno-65-23 name=__codelineno-65-23 href=#__codelineno-65-23></a><span class=cm>Alice           100</span>
</span><span id=__span-65-24><a id=__codelineno-65-24 name=__codelineno-65-24 href=#__codelineno-65-24></a><span class=cm>Bob             NULL</span>
</span><span id=__span-65-25><a id=__codelineno-65-25 name=__codelineno-65-25 href=#__codelineno-65-25></a><span class=cm>Charlie         50</span>
</span><span id=__span-65-26><a id=__codelineno-65-26 name=__codelineno-65-26 href=#__codelineno-65-26></a>
</span><span id=__span-65-27><a id=__codelineno-65-27 name=__codelineno-65-27 href=#__codelineno-65-27></a><span class=cm>通过使用 COALESCE，当没有订单时，NULL 就被转换成了 0：</span>
</span><span id=__span-65-28><a id=__codelineno-65-28 name=__codelineno-65-28 href=#__codelineno-65-28></a>
</span><span id=__span-65-29><a id=__codelineno-65-29 name=__codelineno-65-29 href=#__codelineno-65-29></a><span class=cm>CustomerName    LastOrderAmount</span>
</span><span id=__span-65-30><a id=__codelineno-65-30 name=__codelineno-65-30 href=#__codelineno-65-30></a><span class=cm>Alice           100</span>
</span><span id=__span-65-31><a id=__codelineno-65-31 name=__codelineno-65-31 href=#__codelineno-65-31></a><span class=cm>Bob             0</span>
</span><span id=__span-65-32><a id=__codelineno-65-32 name=__codelineno-65-32 href=#__codelineno-65-32></a><span class=cm>Charlie         50</span>
</span><span id=__span-65-33><a id=__codelineno-65-33 name=__codelineno-65-33 href=#__codelineno-65-33></a><span class=cm>*/</span>
</span></code></pre></div> <div class="language-sql highlight"><pre><span></span><code><span id=__span-66-1><a id=__codelineno-66-1 name=__codelineno-66-1 href=#__codelineno-66-1></a><span class=c1>-- 子查询返回多个列会出错</span>
</span><span id=__span-66-2><a id=__codelineno-66-2 name=__codelineno-66-2 href=#__codelineno-66-2></a><span class=c1>-- 假设我们有两个表：Employees 和 Departments。我们想要找出在某个部门工作的员工。以下是一个错误的示例，尝试让子查询返回多个列。</span>
</span><span id=__span-66-3><a id=__codelineno-66-3 name=__codelineno-66-3 href=#__codelineno-66-3></a>
</span><span id=__span-66-4><a id=__codelineno-66-4 name=__codelineno-66-4 href=#__codelineno-66-4></a><span class=k>SELECT</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>EmployeeName</span>
</span><span id=__span-66-5><a id=__codelineno-66-5 name=__codelineno-66-5 href=#__codelineno-66-5></a><span class=k>FROM</span><span class=w> </span><span class=n>Employees</span><span class=w> </span><span class=n>e</span>
</span><span id=__span-66-6><a id=__codelineno-66-6 name=__codelineno-66-6 href=#__codelineno-66-6></a><span class=k>WHERE</span><span class=w> </span><span class=p>(</span><span class=n>e</span><span class=p>.</span><span class=n>DepartmentID</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>JobTitle</span><span class=p>)</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-66-7><a id=__codelineno-66-7 name=__codelineno-66-7 href=#__codelineno-66-7></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>d</span><span class=p>.</span><span class=n>DepartmentID</span><span class=p>,</span><span class=w> </span><span class=n>d</span><span class=p>.</span><span class=n>ManagerID</span><span class=w>  </span><span class=c1>-- 错误：子查询返回多个列</span>
</span><span id=__span-66-8><a id=__codelineno-66-8 name=__codelineno-66-8 href=#__codelineno-66-8></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>Departments</span><span class=w> </span><span class=n>d</span>
</span><span id=__span-66-9><a id=__codelineno-66-9 name=__codelineno-66-9 href=#__codelineno-66-9></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>d</span><span class=p>.</span><span class=k>Location</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;New York&#39;</span>
</span><span id=__span-66-10><a id=__codelineno-66-10 name=__codelineno-66-10 href=#__codelineno-66-10></a><span class=p>);</span>
</span><span id=__span-66-11><a id=__codelineno-66-11 name=__codelineno-66-11 href=#__codelineno-66-11></a>
</span><span id=__span-66-12><a id=__codelineno-66-12 name=__codelineno-66-12 href=#__codelineno-66-12></a><span class=c1>-- 使用 EXISTS 处理多个列</span>
</span><span id=__span-66-13><a id=__codelineno-66-13 name=__codelineno-66-13 href=#__codelineno-66-13></a><span class=c1>-- EXISTS 关键字是一个例外，它可以用于检查子查询是否返回至少一行数据，而不要求子查询返回单列。即使子查询返回多个列，只要它返回至少一行，EXISTS 就会返回 TRUE。</span>
</span><span id=__span-66-14><a id=__codelineno-66-14 name=__codelineno-66-14 href=#__codelineno-66-14></a>
</span><span id=__span-66-15><a id=__codelineno-66-15 name=__codelineno-66-15 href=#__codelineno-66-15></a><span class=k>SELECT</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>EmployeeName</span>
</span><span id=__span-66-16><a id=__codelineno-66-16 name=__codelineno-66-16 href=#__codelineno-66-16></a><span class=k>FROM</span><span class=w> </span><span class=n>Employees</span><span class=w> </span><span class=n>e</span>
</span><span id=__span-66-17><a id=__codelineno-66-17 name=__codelineno-66-17 href=#__codelineno-66-17></a><span class=k>WHERE</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-66-18><a id=__codelineno-66-18 name=__codelineno-66-18 href=#__codelineno-66-18></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=mi>1</span><span class=w>  </span><span class=c1>-- `EXISTS` 不关心返回的列内容</span>
</span><span id=__span-66-19><a id=__codelineno-66-19 name=__codelineno-66-19 href=#__codelineno-66-19></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>Departments</span><span class=w> </span><span class=n>d</span>
</span><span id=__span-66-20><a id=__codelineno-66-20 name=__codelineno-66-20 href=#__codelineno-66-20></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>DepartmentID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>d</span><span class=p>.</span><span class=n>DepartmentID</span>
</span><span id=__span-66-21><a id=__codelineno-66-21 name=__codelineno-66-21 href=#__codelineno-66-21></a><span class=w>    </span><span class=k>AND</span><span class=w> </span><span class=n>d</span><span class=p>.</span><span class=k>Location</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;New York&#39;</span>
</span><span id=__span-66-22><a id=__codelineno-66-22 name=__codelineno-66-22 href=#__codelineno-66-22></a><span class=p>);</span>
</span><span id=__span-66-23><a id=__codelineno-66-23 name=__codelineno-66-23 href=#__codelineno-66-23></a>
</span><span id=__span-66-24><a id=__codelineno-66-24 name=__codelineno-66-24 href=#__codelineno-66-24></a><span class=c1>-- EXISTS 子查询中，即使我们选择了多个列（在此例中，DepartmentID 和 Location），EXISTS 只关心子查询是否有行返回。如果子查询返回至少一行数据，那么外部查询就会返回相应的员工名称。</span>
</span><span id=__span-66-25><a id=__codelineno-66-25 name=__codelineno-66-25 href=#__codelineno-66-25></a><span class=c1>-- SELECT 1 是一种常见的写法，因为 EXISTS 只关心是否存在匹配的行，而不关心返回哪些列。</span>
</span></code></pre></div> <p>标量子查询可用于查询中涉及值的任何位置，包括 SELECT 列表。 例如，我们可以将检索到最新订单详细信息的查询扩展到包括已订购商品的平均数量，这样我们就能将最新订单的订购数量与所有订单的平均订购数量进行比较。</p> <h3 id=_25>多值子查询</h3> <p>多值子查询非常适合返回使用 IN 运算符的结果。 以下假设示例将返回加拿大客户下达的所有订单的“CustomerID”和“SalesOrderID”值。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-67-1><a id=__codelineno-67-1 name=__codelineno-67-1 href=#__codelineno-67-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>CustomerID</span><span class=p>,</span><span class=w> </span><span class=n>SalesOrderID</span>
</span><span id=__span-67-2><a id=__codelineno-67-2 name=__codelineno-67-2 href=#__codelineno-67-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrderHeader</span>
</span><span id=__span-67-3><a id=__codelineno-67-3 name=__codelineno-67-3 href=#__codelineno-67-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>CustomerID</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span><span class=w> </span><span class=c1>-- IN 在 SQL 中确实用于查找列值是否等于列表中的任意一个值</span>
</span><span id=__span-67-4><a id=__codelineno-67-4 name=__codelineno-67-4 href=#__codelineno-67-4></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>CustomerID</span>
</span><span id=__span-67-5><a id=__codelineno-67-5 name=__codelineno-67-5 href=#__codelineno-67-5></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>Customer</span>
</span><span id=__span-67-6><a id=__codelineno-67-6 name=__codelineno-67-6 href=#__codelineno-67-6></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>CountryRegion</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Canada&#39;</span><span class=p>);</span>
</span></code></pre></div> <p>在此示例中，如果只执行内部查询，则会返回“CustomerID”值列，每行代表加拿大的一位客户。</p> <p>很多情况下，可以使用 join 轻松写入多值子查询。 例如，以下查询使用 join 来返回与前面示例相同的结果：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-68-1><a id=__codelineno-68-1 name=__codelineno-68-1 href=#__codelineno-68-1></a><span class=k>SELECT</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CustomerID</span><span class=p>,</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>SalesOrderID</span>
</span><span id=__span-68-2><a id=__codelineno-68-2 name=__codelineno-68-2 href=#__codelineno-68-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>Customer</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>c</span>
</span><span id=__span-68-3><a id=__codelineno-68-3 name=__codelineno-68-3 href=#__codelineno-68-3></a><span class=k>JOIN</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrderHeader</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>o</span>
</span><span id=__span-68-4><a id=__codelineno-68-4 name=__codelineno-68-4 href=#__codelineno-68-4></a><span class=w>    </span><span class=k>ON</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CustomerID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>CustomerID</span>
</span><span id=__span-68-5><a id=__codelineno-68-5 name=__codelineno-68-5 href=#__codelineno-68-5></a><span class=k>WHERE</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CountryRegion</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s1>&#39;Canada&#39;</span><span class=p>;</span>
</span></code></pre></div> <p>那么，<u>怎么决定是以 JOIN 方式写入涉及多个表的查询，还是使用子查询？ 有时，<strong>这取决于你哪种更熟练</strong></u>。 大多数可轻松转换为 JOIN 的嵌套查询，实际上都会在内部转换为 JOIN。 对于这类查询，使用哪种方式写入并无实际差别。</p> <p><u>应谨记的一项限制是，使用嵌套查询时，返回到客户端的结果只能包含外部查询中的列。 因此，如果需要返回两个表中的列，则应使用 JOIN 来写入查询</u>。</p> <p>最后，在某些情况下，内部查询需要执行示例中的简单检索无法做到的更复杂的操作。 使用 JOIN 重写复杂子查询可能非常困难。 <strong>许多 SQL 开发人员发现，子查询非常适合用于复杂处理，因为使用它们可以将处理分解为更小的步骤</strong>。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-69-1><a id=__codelineno-69-1 name=__codelineno-69-1 href=#__codelineno-69-1></a><span class=c1>-- Employees 表：包含员工信息（EmployeeID, FirstName, LastName）。</span>
</span><span id=__span-69-2><a id=__codelineno-69-2 name=__codelineno-69-2 href=#__codelineno-69-2></a><span class=c1>-- SalesOrders 表：包含订单信息（OrderID, EmployeeID, OrderAmount）。</span>
</span><span id=__span-69-3><a id=__codelineno-69-3 name=__codelineno-69-3 href=#__codelineno-69-3></a><span class=c1>-- 如果我们使用嵌套查询来查找员工和他们的订单金额（假设我们只想得到销售订单中订单金额大于 1000 的员工信息），可以写如下查询：</span>
</span><span id=__span-69-4><a id=__codelineno-69-4 name=__codelineno-69-4 href=#__codelineno-69-4></a><span class=k>SELECT</span><span class=w> </span><span class=n>EmployeeID</span><span class=p>,</span><span class=w> </span><span class=n>FirstName</span><span class=p>,</span><span class=w> </span><span class=n>LastName</span>
</span><span id=__span-69-5><a id=__codelineno-69-5 name=__codelineno-69-5 href=#__codelineno-69-5></a><span class=k>FROM</span><span class=w> </span><span class=n>Employees</span>
</span><span id=__span-69-6><a id=__codelineno-69-6 name=__codelineno-69-6 href=#__codelineno-69-6></a><span class=k>WHERE</span><span class=w> </span><span class=n>EmployeeID</span><span class=w> </span><span class=k>IN</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-69-7><a id=__codelineno-69-7 name=__codelineno-69-7 href=#__codelineno-69-7></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=n>EmployeeID</span>
</span><span id=__span-69-8><a id=__codelineno-69-8 name=__codelineno-69-8 href=#__codelineno-69-8></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>SalesOrders</span>
</span><span id=__span-69-9><a id=__codelineno-69-9 name=__codelineno-69-9 href=#__codelineno-69-9></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>OrderAmount</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>1000</span>
</span><span id=__span-69-10><a id=__codelineno-69-10 name=__codelineno-69-10 href=#__codelineno-69-10></a><span class=p>);</span>
</span><span id=__span-69-11><a id=__codelineno-69-11 name=__codelineno-69-11 href=#__codelineno-69-11></a><span class=c1>--  限制： 在这个查询中，外部查询只能返回 Employees 表的列。如果你需要包括来自 SalesOrders 表的列（比如 OrderAmount），就不能通过这个嵌套查询来直接获取了。</span>
</span><span id=__span-69-12><a id=__codelineno-69-12 name=__codelineno-69-12 href=#__codelineno-69-12></a>
</span><span id=__span-69-13><a id=__codelineno-69-13 name=__codelineno-69-13 href=#__codelineno-69-13></a><span class=c1>-- 如果你需要从多个表中获取信息，JOIN 更合适。你可以通过 JOIN 连接两个表，并选择你需要的列：</span>
</span><span id=__span-69-14><a id=__codelineno-69-14 name=__codelineno-69-14 href=#__codelineno-69-14></a><span class=k>SELECT</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>EmployeeID</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>FirstName</span><span class=p>,</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>LastName</span><span class=p>,</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>OrderAmount</span>
</span><span id=__span-69-15><a id=__codelineno-69-15 name=__codelineno-69-15 href=#__codelineno-69-15></a><span class=k>FROM</span><span class=w> </span><span class=n>Employees</span><span class=w> </span><span class=n>e</span>
</span><span id=__span-69-16><a id=__codelineno-69-16 name=__codelineno-69-16 href=#__codelineno-69-16></a><span class=k>JOIN</span><span class=w> </span><span class=n>SalesOrders</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=k>ON</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>EmployeeID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>EmployeeID</span>
</span><span id=__span-69-17><a id=__codelineno-69-17 name=__codelineno-69-17 href=#__codelineno-69-17></a><span class=k>WHERE</span><span class=w> </span><span class=n>s</span><span class=p>.</span><span class=n>OrderAmount</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>1000</span><span class=p>;</span>
</span><span id=__span-69-18><a id=__codelineno-69-18 name=__codelineno-69-18 href=#__codelineno-69-18></a><span class=c1>-- 我们通过 JOIN 连接了 Employees 表和 SalesOrders 表。</span>
</span><span id=__span-69-19><a id=__codelineno-69-19 name=__codelineno-69-19 href=#__codelineno-69-19></a><span class=c1>-- 外部查询返回了 Employees 表的列（EmployeeID, FirstName, LastName）和 SalesOrders 表的列（OrderAmount）。</span>
</span><span id=__span-69-20><a id=__codelineno-69-20 name=__codelineno-69-20 href=#__codelineno-69-20></a><span class=c1>-- 通过 WHERE 子句过滤订单金额大于 1000 的记录。</span>
</span></code></pre></div> <h2 id=_26>使用自包含或关联子查询</h2> <p>以前，我们将自包含子查询看作是内部查询不依赖于外部查询，执行一次，并向外部查询返回结果。 T-SQL 还支持关联子查询，其中内部查询会引用外部查询中的列，理论上每行执行一次。</p> <h3 id=_27>使用关联子查询</h3> <p>同自包含子查询一样，关联子查询也是嵌套在外部查询中的 SELECT 语句。 关联子查询也可以是标量子查询或多值子查询。 它们通常用于内部查询需要引用外部查询中值的情况。</p> <p>但是，与自包含子查询不同的是，使用关联子查询时有一些特殊注意事项：</p> <ul> <li><u>关联子查询不能与外部查询分开运行。 此限制会使测试和调试变得有些复杂。</u></li> <li>与自包含子查询处理一次不同，关联子查询将运行多次。 逻辑上，外部查询先运行，对于返回的每一行，内部查询都会处理。</li> </ul> <div class="language-sql highlight"><pre><span></span><code><span id=__span-70-1><a id=__codelineno-70-1 name=__codelineno-70-1 href=#__codelineno-70-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>EmployeeID</span><span class=p>,</span><span class=w> </span><span class=n>Name</span>
</span><span id=__span-70-2><a id=__codelineno-70-2 name=__codelineno-70-2 href=#__codelineno-70-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Employees</span><span class=w> </span><span class=n>e</span>
</span><span id=__span-70-3><a id=__codelineno-70-3 name=__codelineno-70-3 href=#__codelineno-70-3></a><span class=k>WHERE</span><span class=w> </span><span class=k>EXISTS</span><span class=w> </span><span class=p>(</span>
</span><span id=__span-70-4><a id=__codelineno-70-4 name=__codelineno-70-4 href=#__codelineno-70-4></a><span class=w>    </span><span class=k>SELECT</span><span class=w> </span><span class=mi>1</span>
</span><span id=__span-70-5><a id=__codelineno-70-5 name=__codelineno-70-5 href=#__codelineno-70-5></a><span class=w>    </span><span class=k>FROM</span><span class=w> </span><span class=n>Orders</span><span class=w> </span><span class=n>o</span>
</span><span id=__span-70-6><a id=__codelineno-70-6 name=__codelineno-70-6 href=#__codelineno-70-6></a><span class=w>    </span><span class=k>WHERE</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>EmployeeID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>e</span><span class=p>.</span><span class=n>EmployeeID</span>
</span><span id=__span-70-7><a id=__codelineno-70-7 name=__codelineno-70-7 href=#__codelineno-70-7></a><span class=p>);</span>
</span><span id=__span-70-8><a id=__codelineno-70-8 name=__codelineno-70-8 href=#__codelineno-70-8></a>
</span><span id=__span-70-9><a id=__codelineno-70-9 name=__codelineno-70-9 href=#__codelineno-70-9></a><span class=c1>-- 这就是 关联子查询（Correlated Subquery），它会对 Employees 表中的每一行执行一次，检查该员工是否在 Orders 表中有对应的记录。</span>
</span><span id=__span-70-10><a id=__codelineno-70-10 name=__codelineno-70-10 href=#__codelineno-70-10></a>
</span><span id=__span-70-11><a id=__codelineno-70-11 name=__codelineno-70-11 href=#__codelineno-70-11></a><span class=c1>-- 由于子查询依赖于外部查询，它无法单独运行，因此无法直接测试子查询的结果。</span>
</span><span id=__span-70-12><a id=__codelineno-70-12 name=__codelineno-70-12 href=#__codelineno-70-12></a><span class=c1>-- 调试时，通常需要先单独运行 类似的非关联查询 来检查 Orders 表中是否有 EmployeeID，例如：</span>
</span><span id=__span-70-13><a id=__codelineno-70-13 name=__codelineno-70-13 href=#__codelineno-70-13></a>
</span><span id=__span-70-14><a id=__codelineno-70-14 name=__codelineno-70-14 href=#__codelineno-70-14></a><span class=k>SELECT</span><span class=w> </span><span class=k>DISTINCT</span><span class=w> </span><span class=n>EmployeeID</span><span class=w> </span><span class=k>FROM</span><span class=w> </span><span class=n>Orders</span><span class=p>;</span>
</span><span id=__span-70-15><a id=__codelineno-70-15 name=__codelineno-70-15 href=#__codelineno-70-15></a>
</span><span id=__span-70-16><a id=__codelineno-70-16 name=__codelineno-70-16 href=#__codelineno-70-16></a><span class=c1>-- 然后再使用 EXISTS 语句进行联调。</span>
</span></code></pre></div> <p>以下示例将使用关联子查询返回每个客户的最近订单。 子查询引用外部查询，并在 WHERE 子句中引用其“CustomerID”值。 对于外部查询中的每一行，子查询都会查找该行中所引用客户的最大订单 ID，而外部查询将检查其正在查看的行是否是包含该订单 ID 的行。</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-71-1><a id=__codelineno-71-1 name=__codelineno-71-1 href=#__codelineno-71-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>SalesOrderID</span><span class=p>,</span><span class=w> </span><span class=n>CustomerID</span><span class=p>,</span><span class=w> </span><span class=n>OrderDate</span>
</span><span id=__span-71-2><a id=__codelineno-71-2 name=__codelineno-71-2 href=#__codelineno-71-2></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>SalesOrderHeader</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>o1</span>
</span><span id=__span-71-3><a id=__codelineno-71-3 name=__codelineno-71-3 href=#__codelineno-71-3></a><span class=k>WHERE</span><span class=w> </span><span class=n>SalesOrderID</span><span class=w> </span><span class=o>=</span>
</span><span id=__span-71-4><a id=__codelineno-71-4 name=__codelineno-71-4 href=#__codelineno-71-4></a><span class=w>    </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>MAX</span><span class=p>(</span><span class=n>SalesOrderID</span><span class=p>)</span>
</span><span id=__span-71-5><a id=__codelineno-71-5 name=__codelineno-71-5 href=#__codelineno-71-5></a><span class=w>     </span><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>SalesOrderHeader</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>o2</span>
</span><span id=__span-71-6><a id=__codelineno-71-6 name=__codelineno-71-6 href=#__codelineno-71-6></a><span class=w>     </span><span class=k>WHERE</span><span class=w> </span><span class=n>o2</span><span class=p>.</span><span class=n>CustomerID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>o1</span><span class=p>.</span><span class=n>CustomerID</span><span class=p>)</span>
</span><span id=__span-71-7><a id=__codelineno-71-7 name=__codelineno-71-7 href=#__codelineno-71-7></a><span class=k>ORDER</span><span class=w> </span><span class=k>BY</span><span class=w> </span><span class=n>CustomerID</span><span class=p>,</span><span class=w> </span><span class=n>OrderDate</span><span class=p>;</span>
</span></code></pre></div> <h3 id=_28>写入关联子查询</h3> <p>要写入关联子查询，请考虑以下准则：</p> <ul> <li><u>写入外部查询以接受来自内部查询的适当返回结果。 如果内部查询是标量查询，可以在 WHERE 子句中使用等于和比较运算符，例如 =、&lt;、&gt; 和 &lt;&gt;。 如果内部查询可能返回多个值，则使用 IN 谓词。 计划处理 NULL 结果。</u></li> <li>标识关联子查询将会引用的外部查询中的列。 对作为外部查询中列源的表声明一个别名。</li> <li>标识内部表中要与外部表中列进行比较的列。 为源表创建一个别名，方法与针对外部查询的处理方式相同。</li> <li>写入内部查询，以根据外部查询的输入值从其源中检索值。 例如，在内部查询的 WHERE 子句中使用外部列。</li> </ul> <p>当内部查询引用外部值进行比较时，内外查询之间将会发生关联。 正是这种关联，让该子查询名副其实。</p> <h3 id=exists>使用 EXISTS</h3> <p>除从子查询中检索值之外，T-SQL 还提供了一种检查查询是否会返回任何结果的机制。 <u>EXISTS 谓词可确定是否存在满足指定条件的任何行，但不会返回这些行，而是返回 TRUE 或 FALSE</u>。 这种方法对于验证数据非常有用，不会产生检索和处理结果的开销。</p> <p><u>当子查询与使用 EXISTS 谓词的外部查询关联时，SQL Server 将以特殊方式来处理子查询的结果。</u> EXISTS 只需检查结果中是否存在任何行，而不是从子查询中检索标量值或多值列表。</p> <p>理论上，EXISTS 谓词相当于检索结果，对返回的行计数，再将计数与零进行比较。 比较以下查询，这些查询将返回已下单客户的详细信息：</p> <p>第一个示例查询在子查询中使用 COUNT：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-72-1><a id=__codelineno-72-1 name=__codelineno-72-1 href=#__codelineno-72-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>CustomerID</span><span class=p>,</span><span class=w> </span><span class=n>CompanyName</span><span class=p>,</span><span class=w> </span><span class=n>EmailAddress</span><span class=w> </span>
</span><span id=__span-72-2><a id=__codelineno-72-2 name=__codelineno-72-2 href=#__codelineno-72-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>Customer</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>c</span><span class=w> </span>
</span><span id=__span-72-3><a id=__codelineno-72-3 name=__codelineno-72-3 href=#__codelineno-72-3></a><span class=k>WHERE</span>
</span><span id=__span-72-4><a id=__codelineno-72-4 name=__codelineno-72-4 href=#__codelineno-72-4></a><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=k>COUNT</span><span class=p>(</span><span class=o>*</span><span class=p>)</span><span class=w> </span>
</span><span id=__span-72-5><a id=__codelineno-72-5 name=__codelineno-72-5 href=#__codelineno-72-5></a><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrderHeader</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>o</span>
</span><span id=__span-72-6><a id=__codelineno-72-6 name=__codelineno-72-6 href=#__codelineno-72-6></a><span class=w>  </span><span class=k>WHERE</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>CustomerID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CustomerID</span><span class=p>)</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
</span></code></pre></div> <p>第二个查询使用 EXISTS 返回相同的结果：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-73-1><a id=__codelineno-73-1 name=__codelineno-73-1 href=#__codelineno-73-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>CustomerID</span><span class=p>,</span><span class=w> </span><span class=n>CompanyName</span><span class=p>,</span><span class=w> </span><span class=n>EmailAddress</span><span class=w> </span>
</span><span id=__span-73-2><a id=__codelineno-73-2 name=__codelineno-73-2 href=#__codelineno-73-2></a><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>Customer</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>c</span><span class=w> </span>
</span><span id=__span-73-3><a id=__codelineno-73-3 name=__codelineno-73-3 href=#__codelineno-73-3></a><span class=k>WHERE</span><span class=w> </span><span class=k>EXISTS</span>
</span><span id=__span-73-4><a id=__codelineno-73-4 name=__codelineno-73-4 href=#__codelineno-73-4></a><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span>
</span><span id=__span-73-5><a id=__codelineno-73-5 name=__codelineno-73-5 href=#__codelineno-73-5></a><span class=w>  </span><span class=k>FROM</span><span class=w> </span><span class=n>Sales</span><span class=p>.</span><span class=n>SalesOrderHeader</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>o</span>
</span><span id=__span-73-6><a id=__codelineno-73-6 name=__codelineno-73-6 href=#__codelineno-73-6></a><span class=w>  </span><span class=k>WHERE</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>CustomerID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CustomerID</span><span class=p>);</span>
</span></code></pre></div> <p>在第一个示例中，子查询必须对在“Sales.SalesOrderHeader”表中找到的每个“custid”匹配项计数，并将计数结果与零比较，这样才能指示该客户已下单。</p> <p>在第二个查询中，只要在“Sales.SalesOrderHeader”表中找到相关订单，EXISTS 就会立即对该“custid”返回 TRUE。 不需要完整计算每个匹配项。 另请注意，使用 EXISTS 形式时，子查询并不局限于返回单列。 在此，我们使用 SELECT *。 返回的列无关紧要，因为我们只是检查有无返回任何行，而不是这些行中的值。</p> <p>从逻辑处理角度来看，这两种查询形式效果相当。 从性能角度来看，数据库引擎对查询的处理可能有所不同，因为它会优化查询后执行处理。 请针对自己的使用情况测试每种查询。</p> <p><strong>如果要将使用 COUNT(<em>) 的子查询转换为使用 EXISTS 的子查询，请确保子查询使用 SELECT </em>，而不是 SELECT COUNT(<em>)。 SELECT COUNT(</em>) 始终返回一行，因此 EXISTS 将始终返回 TRUE。</strong></p> <p>EXISTS 的另一种有用情形是使用 NOT 对子查询求反，如以下示例所示，结果将返回从未下过订单的所有客户：</p> <div class="language-sql highlight"><pre><span></span><code><span id=__span-74-1><a id=__codelineno-74-1 name=__codelineno-74-1 href=#__codelineno-74-1></a><span class=k>SELECT</span><span class=w> </span><span class=n>CustomerID</span><span class=p>,</span><span class=w> </span><span class=n>CompanyName</span><span class=p>,</span><span class=w> </span><span class=n>EmailAddress</span><span class=w> </span>
</span><span id=__span-74-2><a id=__codelineno-74-2 name=__codelineno-74-2 href=#__codelineno-74-2></a><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>Customer</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=k>c</span><span class=w> </span>
</span><span id=__span-74-3><a id=__codelineno-74-3 name=__codelineno-74-3 href=#__codelineno-74-3></a><span class=k>WHERE</span><span class=w> </span><span class=k>NOT</span><span class=w> </span><span class=k>EXISTS</span>
</span><span id=__span-74-4><a id=__codelineno-74-4 name=__codelineno-74-4 href=#__codelineno-74-4></a><span class=w>  </span><span class=p>(</span><span class=k>SELECT</span><span class=w> </span><span class=o>*</span><span class=w> </span>
</span><span id=__span-74-5><a id=__codelineno-74-5 name=__codelineno-74-5 href=#__codelineno-74-5></a><span class=w>   </span><span class=k>FROM</span><span class=w> </span><span class=n>SalesLT</span><span class=p>.</span><span class=n>SalesOrderHeader</span><span class=w> </span><span class=k>AS</span><span class=w> </span><span class=n>o</span>
</span><span id=__span-74-6><a id=__codelineno-74-6 name=__codelineno-74-6 href=#__codelineno-74-6></a><span class=w>   </span><span class=k>WHERE</span><span class=w> </span><span class=n>o</span><span class=p>.</span><span class=n>CustomerID</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>c</span><span class=p>.</span><span class=n>CustomerID</span><span class=p>);</span>
</span></code></pre></div> <p>SQL Server不必一定返回已下过订单客户的相关订单数据。 如果在“Sales.SalesOrderHeader”表中找到“custid”，则 NOT EXISTS 计算为 FALSE，并将很快完成计算。</p> <p>要对使用 EXISTS 的查询写入子查询，请考虑以下准则：</p> <ul> <li>关键字 EXISTS 直接位于 WHERE 后。 除非也使用 NOT，否则前面不加任何列名称（或其他表达式）。</li> <li>在子查询中使用 SELECT *。 子查询不返回任何行，因此无需指定任何列。</li> </ul> <hr> <p><strong><em>参考：</em></strong></p> <p><a href=https://learn.microsoft.com/zh-cn/training/modules/introduction-to-transact-sql/ >Transact-SQL 简介</a></p> <p><a href=https://learn.microsoft.com/zh-cn/training/modules/sort-filter-queries/ >对 T-SQL 中的结果进行排序和筛选</a></p> <p><a href=https://learn.microsoft.com/zh-cn/training/modules/query-multiple-tables-with-joins/ >采用 T-SQL 通过 JOIN 合并多个表</a></p> <p><a href=https://learn.microsoft.com/zh-cn/training/modules/write-subqueries/ >在 T-SQL 中写入子查询</a></p> <aside class=md-source-file> <span class=md-source-file__fact> <span class=md-icon title=最后更新> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年3月30日 14:28:37">2025年3月30日</span> </span> <span class=md-source-file__fact> <span class=md-icon title=创建日期> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg> </span> <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="2025年3月30日 14:28:37">2025年3月30日</span> </span> </aside> <script src=https://giscus.app/client.js data-repo=Tenax-599/mkdocs-material data-repo-id=R_kgDONNnBDQ data-category=Announcements data-category-id=DIC_kwDONNnBDc4ClQfV data-mapping=title data-strict=0 data-reactions-enabled=1 data-emit-metadata=1 data-input-position=top data-theme=preferred_color_scheme data-lang=zh-CN crossorigin=anonymous async>
</script> </article> </div> <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../%E5%AD%A6%E4%B9%A0-modbustcp-%E9%80%9A%E4%BF%A1/ class="md-footer__link md-footer__link--prev" aria-label="上一页: 学习 ModbusTCP 通信"> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </div> <div class=md-footer__title> <span class=md-footer__direction> 上一页 </span> <div class=md-ellipsis> 学习 ModbusTCP 通信 </div> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2025 <a href=http://gitlab.code-nav.cn/Tenax target=_blank rel=noopener>Tenax</a> </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-social> <a href=http://gitlab.code-nav.cn/Tenax target=_blank rel=noopener title=gitlab.code-nav.cn class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 512 512"><!-- Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="m503.5 204.6-.7-1.8-69.7-181.78c-1.4-3.57-3.9-6.59-7.2-8.64-2.4-1.55-5.1-2.515-8-2.81s-5.7.083-8.4 1.11c-2.7 1.02-5.1 2.66-7.1 4.78-1.9 2.12-3.3 4.67-4.1 7.44l-47 144H160.8l-47.1-144c-.8-2.77-2.2-5.31-4.1-7.43-2-2.12-4.4-3.75-7.1-4.77a18.1 18.1 0 0 0-8.38-1.113 18.4 18.4 0 0 0-8.04 2.793 18.1 18.1 0 0 0-7.16 8.64L9.267 202.8l-.724 1.8a129.57 129.57 0 0 0-3.52 82c7.747 26.9 24.047 50.7 46.447 67.6l.27.2.59.4 105.97 79.5 52.6 39.7 32 24.2c3.7 1.9 8.3 4.3 13 4.3s9.3-2.4 13-4.3l32-24.2 52.6-39.7 106.7-79.9.3-.3c22.4-16.9 38.7-40.6 45.6-67.5 8.6-27 7.4-55.8-2.6-82"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.action.edit", "content.action.view", "content.tooltips", "navigation.indexes", "navigation.tracking", "search.share", "navigation.top", "navigation.sections", "navigation.footer", "search.suggest", "search.highlight", "content.tabs.link", "content.code.annotate", "content.code.copy", "toc.follow"], "search": "../assets/javascripts/workers/search.f8cc74c7.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../assets/javascripts/bundle.c8b220af.min.js></script> <script src=../javascripts/katex.js></script> <script src=https://unpkg.com/katex@0/dist/katex.min.js></script> <script src=https://unpkg.com/katex@0/dist/contrib/auto-render.min.js></script> <script id=init-glightbox>const lightbox = GLightbox({"touchNavigation": true, "loop": false, "zoomable": true, "draggable": true, "openEffect": "zoom", "closeEffect": "zoom", "slideEffect": "slide"});
document$.subscribe(() => { lightbox.reload() });
</script></body> </html>